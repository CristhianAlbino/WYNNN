<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>WYN - Chat do Serviço</title>

    <link
        rel="apple-touch-icon"
        sizes="180x180"
        href="/w/1.png"
    />
    <link
        rel="icon"
        type="image/png"
        sizes="32x32"
        href="/w/1.png"
    />
    <link
        rel="icon"
        type="image/png"
        sizes="16x16"
        href="/w/1.png"
    />

    <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
    />

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="vendors/styles/core.css" />
    <link
        rel="stylesheet"
        type="text/css"
        href="vendors/styles/icon-font.min.css"
    />
    <link rel="stylesheet" type="text/css" href="vendors/styles/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0x0Ugau/r+PRGFNfN/P1M2k/L/W84b36d0K7+v7z/z0q0+A==" crossorigin="anonymous" referrerpolicy="no-referrer" />


    <style>
        .chat-container {
            max-width: 800px;
            margin: 20px auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 150px); /* Ajuste a altura conforme necessário */
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* Sombra para destacar */
        }

        .chat-header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.2em;
            border-bottom: 1px solid #0056b3;
            display: flex; /* Para alinhar título e ícone */
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .chat-header .service-info {
            font-weight: bold;
            font-size: 1.1em;
        }

        .chat-header .participant-name {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .chat-header .back-button {
            position: absolute;
            left: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column; /* Para mensagens se alinharem corretamente */
        }

        .message {
            margin-bottom: 10px;
            padding: 10px 15px; /* Aumentado padding */
            border-radius: 15px; /* Mais arredondado */
            max-width: 75%; /* Ligeiramente menor */
            word-wrap: break-word;
            position: relative; /* Para o timestamp */
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); /* Sombra sutil */
        }

        .message.sent {
            background-color: #dcf8c6; /* Cor para mensagens enviadas (verde claro) */
            margin-left: auto;
            border-bottom-right-radius: 2px; /* Canto "dobrado" */
        }

        .message.received {
            background-color: #ffffff; /* Cor para mensagens recebidas (branco) */
            margin-right: auto;
            border: 1px solid #e9e9eb;
            border-bottom-left-radius: 2px; /* Canto "dobrado" */
        }

        .message strong {
            display: block;
            font-size: 0.85em; /* Ligeiramente menor */
            margin-bottom: 3px;
            color: #333;
        }

        .message p {
            margin-bottom: 0;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .message span {
            font-size: 0.7em; /* Menor */
            color: #6c757d;
            display: block;
            text-align: right;
            margin-top: 5px;
            opacity: 0.8;
        }

        .chat-input {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            background-color: #ffffff;
            display: flex;
            align-items: center; /* Alinha verticalmente */
        }

        .chat-input input[type="text"] {
            flex-grow: 1;
            padding: 10px 15px; /* Aumentado padding */
            border: 1px solid #ced4da;
            border-radius: 25px; /* Mais arredondado */
            margin-right: 10px;
            font-size: 1em;
            transition: border-color 0.2s ease;
        }

        .chat-input input[type="text"]:focus {
            border-color: #007bff;
            outline: none;
        }

        .chat-input button {
            padding: 10px 20px;
            background-color: #28a745; /* Cor para o botão de enviar (verde) */
            color: white;
            border: none;
            border-radius: 25px; /* Mais arredondado */
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex; /* Para alinhar ícone e texto */
            align-items: center;
            gap: 5px;
        }

        .chat-input button:hover {
            background-color: #218838;
            transform: translateY(-1px);
        }

        #loading-messages {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }

        .spinner-border {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            vertical-align: text-bottom;
            border: .25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            -webkit-animation: .75s linear infinite spinner-border;
            animation: .75s linear infinite spinner-border;
        }

        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        /* Estilo para a foto de perfil no header */
        .user-icon img.profile-pic-header {
            border-radius: 50% !important;
            object-fit: cover;
            width: 40px;
            height: 40px;
        }

        .profile-pic-placeholder {
            background-color: #e0e0e0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: #888;
        }
        .profile-pic-placeholder .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para ocultar/mostrar a barra lateral */
        .left-side-bar {
            /* Certifique-se de que a barra lateral tem um display inicial adequado, como block ou flex */
            display: block; /* Ou flex, dependendo do seu layout original */
        }
        /* Adicione estas regras CSS para os elementos de menu */
        #cliente-menu-chat {
            display: none; /* Inicia oculto, será mostrado via JS se for cliente */
        }

        #prestador-menu-chat {
            display: none; /* Inicia oculto, será mostrado via JS se for prestador */
        }


        /* Media queries para responsividade */
        @media (max-width: 768px) {
            .chat-container {
                margin: 10px auto;
                height: calc(100vh - 100px);
            }
            .chat-header {
                font-size: 1em;
                padding: 10px;
            }
            .chat-header .back-button {
                font-size: 1.2em;
                left: 10px;
            }
            .message {
                max-width: 90%;
                padding: 8px 12px;
            }
            .chat-input {
                padding: 10px;
            }
            .chat-input input[type="text"] {
                font-size: 0.9em;
                padding: 8px 12px;
            }
            .chat-input button {
                font-size: 0.9em;
                padding: 8px 15px;
            }
        }
    </style>

    <script>
        (function (w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s),
                dl = l != "dataLayer" ? "&l=" + l : "";
            j.async = true;
            j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, "script", "dataLayer", "GTM-NXZMQSS");
    </script>
    </head>
<body>
    <div class="pre-loader">
        <div class="pre-loader-box">
            <div class="loader-logo">
                <img src="w.png" alt="" />
            </div>
            <div class="loader-progress" id="progress_div">
                <div class="bar" id="bar1"></div>
            </div>
            <div class="percent" id="percent1">0%</div>
            <div class="loading-text">Carregando...</div>
        </div>
    </div>

    <div class="header">
        <div class="header-left">
            <div class="menu-icon bi bi-list"></div>
            <div
                class="search-toggle-icon bi bi-search"
                data-toggle="header_search"
            ></div>
            <div class="header-search">
                <form>
                    <div class="form-group mb-0">
                        <i class="dw dw-search2 search-icon"></i>
                        <input
                            type="text"
                            class="form-control search-input"
                            placeholder="Search Here"
                        />
                        <div class="dropdown">
                            <a
                                class="dropdown-toggle no-arrow"
                                href="#"
                                role="button"
                                data-toggle="dropdown"
                            >
                                <i class="ion-arrow-down-c"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right">
                                <div class="form-group row">
                                    <label class="col-sm-12 col-md-2 col-form-label"
                                        >De</label
                                    >
                                    <div class="col-sm-12 col-md-10">
                                        <input
                                            class="form-control form-control-sm form-control-line"
                                            type="text"
                                        />
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-sm-12 col-md-2 col-form-label">Para</label>
                                    <div class="col-sm-12 col-md-10">
                                        <input
                                            class="form-control form-control-sm form-control-line"
                                            type="text"
                                        />
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-sm-12 col-md-2 col-form-label"
                                        >Sujeito</label
                                    >
                                    <div class="col-sm-12 col-md-10">
                                        <input
                                            class="form-control form-control-sm form-control-line"
                                            type="text"
                                        />
                                    </div>
                                </div>
                                <div class="text-right">
                                    <button class="btn btn-primary">Pesquisar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="header-right">
            <div class="dashboard-setting user-notification">
                <div class="dropdown">
                    <a
                        class="dropdown-toggle no-arrow"
                        href="javascript:;"
                        data-toggle="right-sidebar"
                    >
                        <i class="dw dw-settings2"></i>
                    </a>
                </div>
            </div>

            <div class="user-info-dropdown">
                <div class="dropdown">
                    <a
                        class="dropdown-toggle"
                        href="#"
                        role="button"
                        data-toggle="dropdown"
                    >
                        <span class="user-icon">
                            <img src="/w/1.png" alt="" id="user-profile-pic-header"/>
                        </span>
                        <span class="user-name">Usuário/Prestador</span>
                    </a>
                    <div
                        class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list"
                    >
                        <a class="dropdown-item" href="profile.html"
                            ><i class="dw dw-user1"></i> Perfil</a
                        >
                        <a class="dropdown-item" href="profile.html"
                            ><i class="dw dw-settings2"></i>Configurações</a
                        >
                        <a class="dropdown-item" href="faq.html"
                            ><i class="dw dw-help"></i> Ajuda</a
                        >
                        <a class="dropdown-item" href="#" id="logout-link"
                            ><i class="dw dw-logout"></i> Sair</a
                        >
                    </div>
                </div>
            </div>
        </div>
    </div>
	<div class="left-side-bar">
		<div class="brand-logo">
			<a href="index.html"> <img src="w (1).png" alt="" class="dark-logo" />
				<img
					src="w (1).png"
					alt=""
					class="light-logo"
				/>
			</a>
			<div class="close-sidebar" data-toggle="left-sidebar-close">
				<i class="ion-close-round"></i>
			</div>
		</div>
		<div class="menu-block customscroll">
			<div class="sidebar-menu">
				<ul id="accordion-menu">
					<li>
						<a href="chat-list.html" class="dropdown-toggle no-arrow" id="back-link">
                            <span class="micon bi bi-arrow-left-circle"></span
							><span class="mtext">Voltar para Chats</span>
						</a>
					</li>
                    <!-- Menu do Cliente -->
                    <li id="cliente-menu-chat">
                        <li>
                            <a href="indexx.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-house"></span
                                ><span class="mtext">Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="catalogo.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-grid"></span
                                ><span class="mtext">Catálogo de Serviços</span>
                            </a>
                        </li>
                        <li>
                            <a href="contratos.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-journal-check"></span
                                ><span class="mtext">Meus Pedidos</span>
                            </a>
                        </li>
                        <li>
                            <a href="chat-list.html" class="dropdown-toggle no-arrow active">
                                <span class="micon bi bi-chat-dots"></span>
                                <span class="mtext">Chat de Pedidos</span>
                                <span id="unread-chat-count-sidebar-cliente" class="badge badge-pill badge-danger" style="display: none; margin-left: 5px;">0</span>
                            </a>
                        </li>
                         <li>
                            <a href="avaliar-prestador.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-star-fill"></span>
                                <span class="mtext">Avaliar Prestadores</span>
                            </a>
                        </li>
                         <li>
                            <a href="profile.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-person"></span>
                                <span class="mtext">Meu Perfil</span>
                            </a>
                        </li>
                        <li>
                            <a href="notificacoes.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-bell"></span>
                                <span class="mtext">Notificações</span>
                            </a>
                        </li>
                    </li>
                    <!-- Menu do Prestador -->
                     <li id="prestador-menu-chat" style="display: none;">
                         <li>
                             <a href="index.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-house"></span
                                 ><span class="mtext">Dashboard</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-solicitacoes.html" class="dropdown-toggle no-arrow">
                                 <span class="micon bi bi-textarea-resize"></span>
                                 <span class="mtext">Solicitações Pendentes</span>
                                 <span id="new-solicitation-indicator" class="badge badge-pill badge-danger" style="display: none; margin-left: 5px;">Novo!</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-meus-servicos.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-check-circle"></span
                                 ><span class="mtext">Meus Serviços Aceitos</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-historico.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-clock-history"></span
                                 ><span class="mtext">Histórico de Serviços</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-avaliacoes.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-star-fill"></span
                                 ><span class="mtext">Minhas Avaliações</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-gerenciar-servicos.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-gear"></span>
                                 <span class="mtext">Gerenciar Serviços</span>
                             </a>
                         </li>
                          <li>
                             <a href="prestador-minha-disponibilidade.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-calendar-week"></span>
                                 <span class="mtext">Minha Disponibilidade</span>
                             </a>
                         </li>
                          <li>
                             <a href="chat-list.html" class="dropdown-toggle no-arrow active"> <span class="micon bi bi-chat-dots"></span>
                                 <span class="mtext">Chat de Serviços</span>
                                  <span id="unread-chat-count-sidebar-prestador" class="badge badge-pill badge-danger" style="display: none; margin-left: 5px;">0</span>
                             </a>
                         </li>
                     </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="mobile-menu-overlay"></div>

    <div class="main-container">
        <div class="xs-pd-20-10 pd-ltr-20">
            <div class="card-box pd-20 mb-30 chat-container">
                <div id="chat-header" class="chat-header">
                    <button id="back-button" class="back-button" aria-label="Voltar para Chats"><i class="fa-solid fa-arrow-left"></i></button>
                    <div class="header-content">
                        <div class="service-info" id="service-title">Carregando Serviço...</div>
                        <div class="participant-name" id="participant-name"></div>
                    </div>
                </div>
                <div id="chat-messages" class="chat-messages">
                    <div id="loading-messages" style="text-align: center; padding: 20px;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Carregando...</span>
                        </div>
                        <p>Carregando mensagens...</p>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="message-input" placeholder="Digite sua mensagem..." />
                    <button id="send-button"><i class="fa-solid fa-paper-plane"></i> Enviar</button>
                </div>
            </div>

            <div class="footer-wrap pd-20 mb-20 card-box">
                Plataforma WYN-TECH
            </div>
        </div>
    </div>

    <div id="toastContainer"></div>

    <script src="vendors/scripts/core.js"></script>
    <script src="vendors/scripts/script.min.js"></script>
    <script src="vendors/scripts/process.js"></script>
    <script src="vendors/scripts/layout-settings.js"></script>

    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NXZMQSS" height="0" width="0" style="display: none; visibility: hidden"></iframe>
    </noscript>

    <script>
        const BACKEND_BASE_URL = 'https://wyn-backend.onrender.com';
        let usuarioLogado = null;
        let usuarioTipo = null;
        let serviceId = null;
        let pollingInterval = null;

        const chatMessagesDiv = document.getElementById("chat-messages");
        const messageInput = document.getElementById("message-input");
        const sendButton = document.getElementById("send-button");
        const loadingMessagesDiv = document.getElementById("loading-messages");
        const serviceTitleSpan = document.getElementById("service-title");
        const participantNameSpan = document.getElementById("participant-name");
        const userProfilePicHeader = document.getElementById("user-profile-pic-header");
        const backButton = document.getElementById("back-button");

        // Função para exibir toast notifications
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                const newToastContainer = document.createElement('div');
                newToastContainer.id = 'toastContainer';
                newToastContainer.style.position = 'fixed';
                newToastContainer.style.top = '20px';
                newToastContainer.style.right = '20px';
                newToastContainer.style.zIndex = '9999';
                document.body.appendChild(newToastContainer);
                // Re-select the container
                toastContainer = document.getElementById('toastContainer');
            }

            const toastElement = document.createElement('div');
            toastElement.classList.add('toast');
            toastElement.setAttribute('role', 'alert');
            toastElement.setAttribute('aria-live', 'assertive');
            toastElement.setAttribute('aria-atomic', 'true');
            toastElement.setAttribute('data-delay', '5000');

            toastElement.innerHTML = `
                <div class="toast-header ${type === 'success' ? 'bg-success text-white' : type === 'danger' ? 'bg-danger text-white' : 'bg-info text-white'}">
                    <strong class="mr-auto">${type === 'success' ? 'Sucesso' : type === 'danger' ? 'Erro' : 'Informação'}</strong>
                    <small>Agora</small>
                    <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;

            toastContainer.appendChild(toastElement);
            $(toastElement).toast('show');
            $(toastElement).on('hidden.bs.toast', function () {
                $(this).remove();
            });
        }


        async function carregarPerfil() {
            const token = localStorage.getItem('token');
            const usuarioCache = localStorage.getItem('usuario');
            const prestadorCache = localStorage.getItem('prestador');

            const nomeSpan = document.querySelector(".user-name");

            if (!token) {
                console.warn("Não autenticado. Redirecionando para login.");
                window.location.href = "login.html";
                return;
            }

            try {
                if (usuarioCache) {
                    usuarioLogado = JSON.parse(usuarioCache);
                    usuarioTipo = 'usuario';
                } else if (prestadorCache) {
                    usuarioLogado = JSON.parse(prestadorCache);
                    usuarioTipo = 'prestador';
                }

                if (nomeSpan && usuarioLogado?.nome) {
                    nomeSpan.textContent = usuarioLogado.nome;
                }
                if (userProfilePicHeader && usuarioLogado?.foto_perfil_url) {
                    userProfilePicHeader.src = usuarioLogado.foto_perfil_url;
                    userProfilePicHeader.onerror = function() {
                        this.onerror = null;
                        this.src = usuarioTipo === 'usuario' ? "vendors/images/photo1.jpg" : "vendors/images/photo4.jpg";
                    };
                }


                const res = await fetch(`${BACKEND_BASE_URL}/perfil`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                const resClone = res.clone();

                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) {
                        console.error("Token inválido ou expirado. Redirecionando para login.");
                        showToast("Sua sessão expirou. Por favor, faça login novamente.", 'danger');
                        window.location.href = "login.html";
                        return;
                    }
                    throw new Error(`Erro HTTP ao buscar perfil: ${res.status}`);
                }

                let data = {};
                try {
                    data = await res.json();
                } catch(jsonError) {
                    console.error("Erro ao parsear JSON do perfil:", await resClone.text());
                    throw new Error("Resposta de perfil inválida.");
                }

                if (data.tipo === 'usuario' && data.usuario?._id) {
                    usuarioLogado = data.usuario;
                    usuarioTipo = 'usuario';
                    localStorage.setItem('usuario', JSON.stringify(usuarioLogado));
                    localStorage.removeItem('prestador');
                } else if (data.tipo === 'prestador' && data.prestador?._id) {
                    usuarioLogado = data.prestador;
                    usuarioTipo = 'prestador';
                    localStorage.setItem('prestador', JSON.stringify(usuarioLogado));
                    localStorage.removeItem('usuario');
                } else {
                    console.error("Token válido, mas tipo de usuário/prestador desconhecido ou dados incompletos.");
                    showToast("Erro ao carregar perfil. Faça login novamente.", 'danger');
                    window.location.href = "login.html";
                    return;
                }

                if (usuarioLogado?.nome && nomeSpan) {
                    nomeSpan.textContent = usuarioLogado.nome;
                }
                if (userProfilePicHeader && usuarioLogado?.foto_perfil_url) {
                    userProfilePicHeader.src = usuarioLogado.foto_perfil_url;
                    userProfilePicHeader.onerror = function() {
                        this.onerror = null;
                        this.src = usuarioTipo === 'usuario' ? "vendors/images/photo1.jpg" : "vendors/images/photo4.jpg";
                    };
                } else if (userProfilePicHeader) {
                    userProfilePicHeader.src = usuarioTipo === 'usuario' ? "vendors/images/photo1.jpg" : "vendors/images/photo4.jpg";
                }

                console.log(`Perfil de ${usuarioTipo} carregado:`, usuarioLogado);

                // Chama a função para configurar a visibilidade do menu após carregar o perfil
                configurarVisibilidadeMenu();

                // Carrega os detalhes do serviço e as mensagens
                carregarDetalhesServico();
                carregarMensagens();

            } catch (err) {
                console.error('Erro ao carregar perfil:', err);
                showToast('Ocorreu um erro ao carregar informações do perfil.', 'danger');
            }
        }

        // Nova função para configurar a visibilidade do menu lateral
        function configurarVisibilidadeMenu() {
            const clienteMenu = document.getElementById('cliente-menu-chat');
            const prestadorMenu = document.getElementById('prestador-menu-chat');
            const adminLinkHeader = document.querySelector('.admin-link-header'); // Link do admin no cabeçalho

            if (clienteMenu && prestadorMenu) {
                if (usuarioTipo === 'usuario') {
                    clienteMenu.style.display = 'block';
                    prestadorMenu.style.display = 'none';
                    if (adminLinkHeader) adminLinkHeader.style.display = 'none'; // Esconde link admin para cliente
                } else if (usuarioTipo === 'prestador') {
                    clienteMenu.style.display = 'none';
                    prestadorMenu.style.display = 'block';
                    if (adminLinkHeader) adminLinkHeader.style.display = 'none'; // Esconde link admin para prestador
                } else {
                    // Se não for nem usuário nem prestador (ex: deslogado ou erro), esconde ambos
                    clienteMenu.style.display = 'none';
                    prestadorMenu.style.display = 'none';
                    if (adminLinkHeader) adminLinkHeader.style.display = 'none'; // Esconde link admin
                }
            } else {
                console.error("Elementos de menu (cliente-menu-chat ou prestador-menu-chat) não encontrados.");
            }

            // Exibir o link de admin apenas se o usuário for um admin (você pode adicionar uma lógica aqui)
            // Por exemplo, se você tiver um campo `isAdmin` no objeto usuarioLogado
            if (usuarioLogado && usuarioLogado.isAdmin) { // Exemplo: se o usuário logado for um admin
                if (adminLinkHeader) adminLinkHeader.style.display = 'block';
            }
        }


        async function carregarDetalhesServico() {
            if (!serviceId || !localStorage.getItem('token')) {
                console.warn("Não é possível carregar detalhes do serviço: ID do serviço ou token faltando.");
                return;
            }
            try {
                const response = await fetch(`${BACKEND_BASE_URL}/servico/${serviceId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP ao buscar detalhes do serviço: ${response.status}`);
                }

                const serviceDetails = await response.json();
                console.log("Detalhes do serviço carregados:", serviceDetails);

                // Atualiza o título do serviço
                if (serviceTitleSpan) {
                    serviceTitleSpan.textContent = serviceDetails.tipo_servico || 'Serviço Desconhecido';
                }

                // Atualiza o nome do participante
                if (participantNameSpan) {
                    if (usuarioTipo === 'usuario' && serviceDetails.nome_prestador) {
                        participantNameSpan.textContent = `com ${serviceDetails.nome_prestador}`;
                    } else if (usuarioTipo === 'prestador' && serviceDetails.nome_cliente) {
                        participantNameSpan.textContent = `com ${serviceDetails.nome_cliente}`;
                    } else {
                        participantNameSpan.textContent = ''; // Limpa se não houver nome
                    }
                }

            } catch (error) {
                console.error("Erro ao carregar detalhes do serviço:", error);
                showToast("Erro ao carregar detalhes do serviço.", 'danger');
            }
        }


        document.getElementById('logout-link').addEventListener('click', (e) => {
             e.preventDefault();
             localStorage.removeItem('token');
             localStorage.removeItem('usuario');
             localStorage.removeItem('prestador');
             if (pollingInterval) {
                 clearInterval(pollingInterval);
             }
             window.location.href = 'login.html';
        });

        document.addEventListener("DOMContentLoaded", () => {
             const urlParams = new URLSearchParams(window.location.search);
             serviceId = urlParams.get('serviceId');

             if (!serviceId) {
                 showToast("ID do serviço não fornecido na URL.", 'danger');
                 setTimeout(() => { window.location.href = "chat-list.html"; }, 2000); // Redireciona de volta
                 return;
             }

             console.log("Chat carregado para o serviço ID:", serviceId);

             carregarPerfil(); // Esta função agora também chama configurarVisibilidadeMenu()

             pollingInterval = setInterval(carregarMensagens, 3000);

             if (backButton) {
                 backButton.addEventListener('click', (e) => {
                     e.preventDefault();
                     window.location.href = 'chat-list.html';
                 });
             } else {
                 console.error("Elemento #back-button não encontrado.");
             }
        });

        window.addEventListener('beforeunload', () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });

    </script>


    <script>
        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function displayMessage(message) {
            const messageElement = document.createElement("div");
            messageElement.classList.add("message");
            messageElement.dataset.messageId = message._id; // Adiciona o ID da mensagem para deduplicação

            const isSent = (usuarioLogado && message.remetente_id === usuarioLogado._id);

            messageElement.classList.add(isSent ? "sent" : "received");

            const senderName = message.remetente_nome_cache || 'Desconhecido';

            messageElement.innerHTML = `
                <strong>${isSent ? 'Você' : senderName}</strong>
                <p>${message.conteudo}</p>
                <span>${formatMessageTime(message.data_envio)}</span>
            `;

            chatMessagesDiv.appendChild(messageElement);
        }

        async function carregarMensagens() {
            if (!serviceId || !localStorage.getItem('token') || !usuarioLogado || !usuarioTipo) {
                loadingMessagesDiv.innerHTML = `<p>Carregando informações do chat...</p>`;
                loadingMessagesDiv.style.display = "block";
                return;
            }

            if (chatMessagesDiv.children.length === 0 || chatMessagesDiv.children[0].id === 'loading-messages') {
                 loadingMessagesDiv.style.display = "block";
            }

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/chat/${serviceId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Erro HTTP ao buscar mensagens:", response.status, errorText);
                    loadingMessagesDiv.innerHTML = `<p>Erro ao carregar mensagens: ${response.status}. Tente recarregar.</p>`;
                    loadingMessagesDiv.style.display = "block";
                    return;
                }

                const messages = await response.json();
                console.log("Mensagens carregadas:", messages);

                const currentMessageIds = Array.from(chatMessagesDiv.children).map(el => el.dataset.messageId).filter(id => id);
                let newMessagesCount = 0;

                messages.forEach(message => {
                    if (!currentMessageIds.includes(message._id)) {
                        displayMessage(message);
                        newMessagesCount++;
                    }
                });

                if (messages.length === 0) {
                    loadingMessagesDiv.innerHTML = `<p>Nenhuma mensagem ainda. Comece a conversa!</p>`;
                    loadingMessagesDiv.style.display = "block";
                } else {
                    loadingMessagesDiv.style.display = "none";
                    if (newMessagesCount > 0) {
                         chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                    }
                }

            } catch (error) {
                console.error("Erro ao carregar mensagens:", error);
                loadingMessagesDiv.innerHTML = `<p>Erro ao carregar mensagens: ${error.message || 'Verifique a conexão.'}</p>`;
                loadingMessagesDiv.style.display = "block";
            }
        }

        async function sendMessage() {
            const content = messageInput.value.trim();
            const token = localStorage.getItem('token');

            if (!content || !serviceId || !token || !usuarioLogado || !usuarioTipo) {
                showToast("Não é possível enviar mensagem: Conteúdo, ID do serviço ou autenticação faltando.", 'danger');
                return;
            }

            messageInput.disabled = true;
            sendButton.disabled = true;
            sendButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...`;

            // Implementação do AbortController para timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                controller.abort(); // Aborta a requisição após o timeout
            }, 10000); // 10 segundos de timeout

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/chat/message`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        serviceId: serviceId,
                        conteudo: content,
                    }),
                    signal: controller.signal // Associa o signal ao fetch
                });

                clearTimeout(timeoutId); // Limpa o timeout se a requisição for concluída

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Erro HTTP ao enviar mensagem:", response.status, errorText);
                    try {
                        const errorJson = JSON.parse(errorText);
                        throw new Error(errorJson.message || errorText || `Erro HTTP: ${response.status}`);
                    } catch (parseError) {
                        throw new Error(errorText || `Erro HTTP: ${response.status}`);
                    }
                }

                const result = await response.json();
                console.log("Mensagem enviada:", result);

                messageInput.value = "";
                carregarMensagens(); // Recarrega para exibir a nova mensagem

            } catch (error) {
                clearTimeout(timeoutId); // Garante que o timeout é limpo mesmo em caso de erro
                if (error.name === 'AbortError') {
                    showToast("Erro ao enviar mensagem: Tempo limite excedido. Verifique sua conexão.", 'danger');
                } else {
                    console.error("Erro ao enviar mensagem:", error);
                    showToast("Erro ao enviar mensagem: " + (error.message || "Verifique sua conexão ou tente novamente."), 'danger');
                }
            } finally {
                messageInput.disabled = false;
                sendButton.disabled = false;
                sendButton.innerHTML = `<i class="fa-solid fa-paper-plane"></i> Enviar`;
                messageInput.focus();
            }
        }

        sendButton.addEventListener("click", sendMessage);

        messageInput.addEventListener("keypress", (event) => {
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault();
                sendMessage();
            }
        });

    </script>

</body>
</html>
