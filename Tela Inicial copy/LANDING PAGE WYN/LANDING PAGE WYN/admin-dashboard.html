<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>WYN - Dashboard Administrativo</title>

    <link rel="apple-touch-icon" sizes="180x180" href="/Tela Inicial copy/w.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/Tela Inicial copy/w.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/Tela Inicial copy/w.png" />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="vendors/styles/core.css" />
    <link rel="stylesheet" type="text/css" href="vendors/styles/icon-font.min.css" />
    <link rel="stylesheet" type="text/css" href="src/plugins/datatables/css/dataTables.bootstrap4.min.css" />
    <link rel="stylesheet" type="text/css" href="src/plugins/datatables/css/responsive.bootstrap4.min.css" />
    <link rel="stylesheet" type="text/css" href="vendors/styles/style.css" />

    <script async src="https://www.googletagmanager.com/gtag/js?id=GTM-NXZMQSS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'GTM-NXZMQSS');
    </script>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="brand-logo">
                <a href="admin-dashboard.html">
                    <img src="/Tela Inicial copy/w.png" alt="" class="dark-logo" />
                    <img src="/Tela Inicial copy/w.png" alt="" class="light-logo" />
                </a>
            </div>
            <div class="menu-icon bi bi-list"></div>
            <div class="search-toggle-icon bi bi-search" data-toggle="header_search"></div>
            <div class="header-search">
                <form>
                    <div class="form-group mb-0">
                        <i class="bi bi-search search-icon"></i>
                        <input
                            type="text"
                            class="form-control search-input"
                            placeholder="Buscar..."
                        />
                        <i class="bi bi-x-lg search-toggle-icon" data-toggle="header_search"></i>
                    </div>
                </form>
            </div>
        </div>
        <div class="header-right">
            <div class="dashboard-setting user-notification">
                <div class="dropdown">
                    <a
                        class="dropdown-toggle no-arrow"
                        href="javascript:;"
                        data-toggle="right-sidebar"
                    >
                        <i class="bi bi-gear"></i>
                    </a>
                </div>
            </div>
            <div class="user-notification">
                <div class="dropdown">
                    <a
                        class="dropdown-toggle no-arrow"
                        href="#"
                        role="button"
                        data-toggle="dropdown"
                    >
                        <i class="icon-copy bi bi-bell"></i>
                        <span class="badge notification-active"></span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right">
                        <div class="notification-list mx-h-350 customscroll">
                            <ul>
                                </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="user-info-dropdown">
                <div class="dropdown">
                    <a
                        class="dropdown-toggle"
                        href="#"
                        role="button"
                        data-toggle="dropdown"
                    >
                        <span class="user-icon">
                            <img id="profile-picture-nav" src="https://placehold.co/150x150/cccccc/ffffff?text=Admin" alt="" />
                        </span>
                        <span id="admin-name-nav" class="user-name">Admin</span>
                    </a>
                    <div
                        class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list"
                    >
                        <a class="dropdown-item" href="profile.html"
                            ><i class="dw dw-user1"></i> Perfil</a
                        >
                        <a class="dropdown-item" href="javascript:void(0);" id="logout-link"
                            ><i class="dw dw-logout"></i> Sair</a
                        >
                    </div>
                </div>
            </div>
            <div class="github-link">
                <a href="https://github.com/dropways/deskapp" target="_blank"
                    ><img src="vendors/images/github.svg" alt=""
                /></a>
            </div>
        </div>
    </div>

    <div class="right-sidebar">
        <div class="sidebar-icon" data-toggle="right-sidebar-close">
            <i class="ion-ios-close-empty"></i>
        </div>
        <div class="sidebar-settings customscroll">
            <div class="text-center mt-3 mb-0">
                <div class="dark-light-toggle">
                    <input type="checkbox" id="dark-mode-toggle" />
                    <label for="dark-mode-toggle"></label>
                </div>
                <label class="toggle-label">Modo Escuro</label>
            </div>
            <div class="text-center mt-3 mb-0">
                <div class="layout-type-toggle">
                    <input type="radio" id="sidebar-light" name="sidebar-type" value="light" />
                    <label for="sidebar-light">Claro</label>
                    <input type="radio" id="sidebar-dark" name="sidebar-type" value="dark" />
                    <label for="sidebar-dark">Escuro</label>
                </div>
                <label class="toggle-label">Layout da Sidebar</label>
            </div>
            <div class="text-center mt-3 mb-0">
                <div class="header-type-toggle">
                    <input type="radio" id="header-light" name="header-type" value="light" />
                    <label for="header-light">Claro</label>
                    <input type="radio" id="header-dark" name="header-type" value="dark" />
                    <label for="header-dark">Escuro</label>
                </div>
                <label class="toggle-label">Layout do Header</label>
            </div>
            <div class="text-center mt-3 mb-0">
                <div class="sidebar-style-toggle">
                    <input type="radio" id="sidebar-style-1" name="sidebar-style" value="1" />
                    <label for="sidebar-style-1">Estilo 1</label>
                    <input type="radio" id="sidebar-style-2" name="sidebar-style" value="2" />
                    <label for="sidebar-style-2">Estilo 2</label>
                    <input type="radio" id="sidebar-style-3" name="sidebar-style" value="3" />
                    <label for="sidebar-style-3">Estilo 3</label>
                </div>
                <label class="toggle-label">Estilo da Sidebar</label>
            </div>
        </div>
    </div>

    <div class="left-side-bar">
        <div class="brand-logo">
            <a href="admin-dashboard.html">
                <img src="/Tela Inicial copy/w.png" alt="" class="dark-logo" />
                <img src="/Tela Inicial copy/w.png" alt="" class="light-logo" />
            </a>
            <div class="close-sidebar" data-toggle="left-sidebar-close">
                <i class="ion-close-round"></i>
            </div>
        </div>
        <div class="menu-block customscroll">
            <div class="sidebar-menu">
                <ul id="accordion-menu">
                    <li class="dropdown">
                        <a href="admin-dashboard.html" class="dropdown-toggle no-arrow">
                            <span class="micon bi bi-house"></span>
                            <span class="mtext">Dashboard</span>
                        </a>
                    </li>
                    <li class="dropdown">
                        <a href="javascript:;" class="dropdown-toggle" id="menu-usuarios">
                            <span class="micon bi bi-people"></span>
                            <span class="mtext">Usuários</span>
                        </a>
                        <ul class="submenu">
                            <li><a href="javascript:void(0);" id="menu-usuarios-listar">Listar Usuários</a></li>
                            <li><a href="javascript:void(0);" id="menu-usuarios-criar">Criar Usuário</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="javascript:;" class="dropdown-toggle" id="menu-prestadores">
                            <span class="micon bi bi-person-workspace"></span>
                            <span class="mtext">Prestadores</span>
                        </a>
                        <ul class="submenu">
                            <li><a href="javascript:void(0);" id="menu-prestadores-listar">Listar Prestadores</a></li>
                            <li><a href="javascript:void(0);" id="menu-prestadores-criar">Criar Prestador</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="javascript:;" class="dropdown-toggle" id="menu-servicos">
                            <span class="micon bi bi-card-checklist"></span>
                            <span class="mtext">Pedidos de Serviço</span>
                        </a>
                        <ul class="submenu">
                            <li><a href="javascript:void(0);" id="menu-servicos-listar">Listar Pedidos</a></li>
                            </ul>
                    </li>
                    <li class="dropdown">
                        <a href="javascript:;" class="dropdown-toggle" id="menu-servicos-oferecidos">
                            <span class="micon bi bi-tags"></span>
                            <span class="mtext">Serviços Oferecidos</span>
                        </a>
                        <ul class="submenu">
                            <li><a href="javascript:void(0);" id="menu-servicos-oferecidos-listar">Listar Serviços</a></li>
                            <li><a href="javascript:void(0);" id="menu-servicos-oferecidos-criar">Criar Serviço</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="javascript:;" class="dropdown-toggle" id="menu-avaliacoes">
                            <span class="micon bi bi-star"></span>
                            <span class="mtext">Avaliações</span>
                        </a>
                        <ul class="submenu">
                            <li><a href="javascript:void(0);" id="menu-avaliacoes-listar">Listar Avaliações</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="mobile-menu-overlay"></div>

    <div class="main-container">
        <div class="pd-ltr-20">
            <div class="card-box pd-20 height-100-p mb-30" id="overview-section">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <img src="vendors/images/banner-img.png" alt="" />
                    </div>
                    <div class="col-md-8">
                        <h4 class="font-20 weight-500 mb-10 text-capitalize">
                            Bem-vindo de volta, <div class="weight-600 font-30 text-blue" id="admin-name-overview">Admin!</div>
                        </h4>
                        <p class="font-18 max-width-600">
                            Aqui você pode gerenciar usuários, prestadores, serviços e avaliações da plataforma WYN.
                        </p>
                    </div>
                </div>
            </div>

            <div class="row pb-10">
                <div class="col-xl-3 col-lg-3 col-md-6 mb-20">
                    <div class="card-box height-100-p widget-style3">
                        <div class="d-flex flex-wrap">
                            <div class="widget-data">
                                <div class="weight-700 font-24 text-dark" id="total-users">0</div>
                                <div class="font-14 text-secondary weight-500">Total de Usuários</div>
                            </div>
                            <div class="widget-icon">
                                <div class="icon" data-color="#00eccf">
                                    <i class="icon-copy bi bi-people"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-3 col-md-6 mb-20">
                    <div class="card-box height-100-p widget-style3">
                        <div class="d-flex flex-wrap">
                            <div class="widget-data">
                                <div class="weight-700 font-24 text-dark" id="total-providers">0</div>
                                <div class="font-14 text-secondary weight-500">Total de Prestadores</div>
                            </div>
                            <div class="widget-icon">
                                <div class="icon" data-color="#00eccf">
                                    <i class="icon-copy bi bi-person-workspace"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-3 col-md-6 mb-20">
                    <div class="card-box height-100-p widget-style3">
                        <div class="d-flex flex-wrap">
                            <div class="widget-data">
                                <div class="weight-700 font-24 text-dark" id="total-services">0</div>
                                <div class="font-14 text-secondary weight-500">Pedidos de Serviço</div>
                            </div>
                            <div class="widget-icon">
                                <div class="icon" data-color="#ff6b6b">
                                    <i class="icon-copy bi bi-card-checklist"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-3 col-md-6 mb-20">
                    <div class="card-box height-100-p widget-style3">
                        <div class="d-flex flex-wrap">
                            <div class="widget-data">
                                <div class="weight-700 font-24 text-dark" id="total-reviews">0</div>
                                <div class="font-14 text-secondary weight-500">Avaliações</div>
                            </div>
                            <div class="widget-icon">
                                <div class="icon" data-color="#ff6b6b">
                                    <i class="icon-copy bi bi-star"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-30">
                <div class="col-md-12">
                    <div class="card-box pb-20">
                        <h2 class="h4 pd-20">Serviços por Status</h2>
                        <div id="services-status-chart" style="height: 350px;"></div>
                    </div>
                </div>
            </div>

            <div id="usuarios-section" class="card-box mb-30" style="display: none;">
                <h2 class="h4 pd-20">Gerenciar Usuários</h2>
                <div class="pd-20">
                    <button class="btn btn-primary mb-3" id="add-user-btn">Adicionar Novo Usuário</button>
                    <table class="data-table table nowrap" id="users-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Telefone</th>
                                <th>Admin</th>
                                <th class="datatable-nosort">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="prestadores-section" class="card-box mb-30" style="display: none;">
                <h2 class="h4 pd-20">Gerenciar Prestadores</h2>
                <div class="pd-20">
                    <button class="btn btn-primary mb-3" id="add-provider-btn">Adicionar Novo Prestador</button>
                    <table class="data-table table nowrap" id="providers-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>Telefone</th>
                                <th class="datatable-nosort">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="servicos-section" class="card-box mb-30" style="display: none;">
                <h2 class="h4 pd-20">Gerenciar Pedidos de Serviço</h2>
                <div class="pd-20">
                    <table class="data-table table nowrap" id="services-table">
                        <thead>
                            <tr>
                                <th>ID Pedido</th>
                                <th>Cliente</th>
                                <th>Prestador</th>
                                <th>Serviço</th>
                                <th>Status</th>
                                <th>Valor</th>
                                <th class="datatable-nosort">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="servicos-oferecidos-section" class="card-box mb-30" style="display: none;">
                <h2 class="h4 pd-20">Gerenciar Serviços Oferecidos</h2>
                <div class="pd-20">
                    <button class="btn btn-primary mb-3" id="add-offered-service-btn">Adicionar Novo Serviço Oferecido</button>
                    <table class="data-table table nowrap" id="offered-services-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Prestador</th>
                                <th>Preço Mín.</th>
                                <th>Preço Máx.</th>
                                <th>Categorias</th>
                                <th class="datatable-nosort">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="avaliacoes-section" class="card-box mb-30" style="display: none;">
                <h2 class="h4 pd-20">Gerenciar Avaliações</h2>
                <div class="pd-20">
                    <table class="data-table table nowrap" id="reviews-table">
                        <thead>
                            <tr>
                                <th>ID Pedido</th>
                                <th>Cliente</th>
                                <th>Prestador</th>
                                <th>Serviço</th>
                                <th>Nota</th>
                                <th>Comentário</th>
                                <th class="datatable-nosort">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="modal fade bs-example-modal-lg" id="user-modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="user-modal-title">Adicionar Usuário</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="user-form">
                                <input type="hidden" id="user-id" />
                                <div class="form-group">
                                    <label>Nome</label>
                                    <input class="form-control" type="text" id="user-name" required />
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input class="form-control" type="email" id="user-email" required />
                                </div>
                                <div class="form-group">
                                    <label>Telefone</label>
                                    <input class="form-control" type="text" id="user-phone" />
                                </div>
                                <div class="form-group" id="user-password-group">
                                    <label>Senha</label>
                                    <input class="form-control" type="password" id="user-password" required />
                                </div>
                                <div class="form-group">
                                    <label>Foto de Perfil</label>
                                    <input class="form-control" type="file" id="user-profile-picture" accept="image/*" />
                                </div>
                                <div class="form-group">
                                    <label>É Administrador?</label>
                                    <input type="checkbox" id="user-is-admin" />
                                </div>
                                <button type="submit" class="btn btn-primary">Salvar</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade bs-example-modal-lg" id="provider-modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="provider-modal-title">Adicionar Prestador</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="provider-form">
                                <input type="hidden" id="provider-id" />
                                <div class="form-group">
                                    <label>Nome</label>
                                    <input class="form-control" type="text" id="provider-name" required />
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input class="form-control" type="email" id="provider-email" required />
                                </div>
                                <div class="form-group">
                                    <label>Telefone</label>
                                    <input class="form-control" type="text" id="provider-phone" />
                                </div>
                                <div class="form-group" id="provider-password-group">
                                    <label>Senha</label>
                                    <input class="form-control" type="password" id="provider-password" required />
                                </div>
                                <div class="form-group">
                                    <label>Foto de Perfil</label>
                                    <input class="form-control" type="file" id="provider-profile-picture" accept="image/*" />
                                </div>
                                <button type="submit" class="btn btn-primary">Salvar</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade bs-example-modal-lg" id="offered-service-modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="offered-service-modal-title">Adicionar Serviço Oferecido</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="offered-service-form">
                                <input type="hidden" id="offered-service-id" />
                                <div class="form-group">
                                    <label>Nome do Serviço</label>
                                    <input class="form-control" type="text" id="offered-service-name" required />
                                </div>
                                <div class="form-group">
                                    <label>Descrição</label>
                                    <textarea class="form-control" id="offered-service-description"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Prestador</label>
                                    <select class="form-control" id="offered-service-provider" required>
                                        </select>
                                </div>
                                <div class="form-group">
                                    <label>Faixa de Preço Mínimo</label>
                                    <input class="form-control" type="number" step="0.01" id="offered-service-min-price" />
                                </div>
                                <div class="form-group">
                                    <label>Faixa de Preço Máximo</label>
                                    <input class="form-control" type="number" step="0.01" id="offered-service-max-price" />
                                </div>
                                <div class="form-group">
                                    <label>Categorias (separadas por vírgula)</label>
                                    <input class="form-control" type="text" id="offered-service-categories" />
                                </div>
                                <button type="submit" class="btn btn-primary">Salvar</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>


            <div class="footer-wrap pd-20 mb-20 card-box">
                WYN - Dashboard Administrativo por
                <a href="https://github.com/dropways" target="_blank"
                    >Dropways</a
                >
            </div>
        </div>
    </div>

    <script src="vendors/scripts/core.js"></script>
    <script src="vendors/scripts/script.min.js"></script>
    <script src="vendors/scripts/process.js"></script>
    <script src="vendors/scripts/layout-settings.js"></script>
    <script src="src/plugins/apexcharts/apexcharts.min.js"></script>
    <script src="src/plugins/datatables/js/jquery.dataTables.min.js"></script>
    <script src="src/plugins/datatables/js/dataTables.bootstrap4.min.js"></script>
    <script src="src/plugins/datatables/js/dataTables.responsive.min.js"></script>
    <script src="src/plugins/datatables/js/responsive.bootstrap4.min.js"></script>
    <script src="vendors/scripts/dashboard3.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <script>
        const BACKEND_BASE_URL = 'https://wyn-backend.onrender.com'; // Ou 'http://localhost:3000' se estiver rodando localmente

        // Função para mostrar mensagens SweetAlert2
        function showMessage(title, text, icon = 'info') {
            Swal.fire({
                title: title,
                text: text,
                icon: icon,
                confirmButtonText: 'Ok'
            });
        }

        // Função para mostrar uma seção e esconder as outras
        function showSection(sectionId) {
            document.getElementById('overview-section').style.display = 'none';
            document.getElementById('usuarios-section').style.display = 'none';
            document.getElementById('prestadores-section').style.display = 'none';
            document.getElementById('servicos-section').style.display = 'none';
            document.getElementById('servicos-oferecidos-section').style.display = 'none';
            document.getElementById('avaliacoes-section').style.display = 'none';

            document.getElementById(sectionId + '-section').style.display = 'block';
        }

        // Função para carregar o perfil do administrador e verificar o token
        async function carregarPerfilAdmin() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.warn("[FRONTEND] Token não encontrado. Redirecionando para login.");
                window.location.href = 'login-admin.html';
                return;
            }

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/perfil`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("[FRONTEND] Erro ao carregar perfil do admin:", response.status, errorData.message);
                    // Se o token for inválido ou o usuário não for admin, redireciona
                    if (response.status === 401 || response.status === 403) {
                        showMessage('Acesso Negado', 'Você não tem permissão para acessar esta área ou sua sessão expirou.', 'error');
                        localStorage.removeItem('token');
                        localStorage.removeItem('admin');
                        window.location.href = 'login-admin.html';
                    } else {
                        showMessage('Erro', errorData.message || 'Erro ao carregar perfil.', 'error');
                    }
                    return;
                }

                const data = await response.json();
                console.log("[FRONTEND] Dados do perfil recebidos:", data); // Log dos dados recebidos

                if (data.tipo === 'usuario' && data.usuario.isAdmin) {
                    console.log("[FRONTEND] Usuário é administrador. Carregando dashboard."); // Confirma que é admin
                    // Atualiza o nome e a foto de perfil na navegação e no overview
                    document.getElementById('admin-name-nav').textContent = data.usuario.nome;
                    document.getElementById('admin-name-overview').textContent = data.usuario.nome;
                    if (data.usuario.foto_perfil_url) {
                        document.getElementById('profile-picture-nav').src = data.usuario.foto_perfil_url;
                    }

                    // Carregar dados dos cards e gráficos
                    carregarContadores();
                    carregarServicosPorStatusChart();

                    // Opcional: Carregar a primeira seção padrão (ex: usuários)
                    // showSection('usuarios'); // Descomente se quiser iniciar em uma seção específica
                } else {
                    console.warn("[FRONTEND] Usuário logado não é administrador. Redirecionando."); // Não é admin
                    showMessage('Acesso Negado', 'Esta área é apenas para administradores.', 'error');
                    localStorage.removeItem('token');
                    localStorage.removeItem('admin');
                    window.location.href = 'login-admin.html';
                }
            } catch (error) {
                console.error("[FRONTEND] Erro de rede ou inesperado ao carregar perfil do admin:", error);
                showMessage('Erro de Conexão', 'Não foi possível conectar ao servidor. Verifique sua conexão.', 'error');
                localStorage.removeItem('token');
                localStorage.removeItem('admin');
                window.location.href = 'login-admin.html';
            }
        }

        // Função para carregar os contadores do dashboard
        async function carregarContadores() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const headers = { 'Authorization': `Bearer ${token}` };

                const [usersRes, providersRes, servicesRes, reviewsRes] = await Promise.all([
                    fetch(`${BACKEND_BASE_URL}/admin/count/usuarios`, { headers }),
                    fetch(`${BACKEND_BASE_URL}/admin/count/prestadores`, { headers }),
                    fetch(`${BACKEND_BASE_URL}/admin/count/servicos`, { headers }),
                    fetch(`${BACKEND_BASE_URL}/admin/count/avaliacoes`, { headers })
                ]);

                const usersData = await usersRes.json();
                const providersData = await providersRes.json();
                const servicesData = await servicesRes.json();
                const reviewsData = await reviewsRes.json();

                document.getElementById('total-users').textContent = usersData.total || 0;
                document.getElementById('total-providers').textContent = providersData.total || 0;
                document.getElementById('total-services').textContent = servicesData.total || 0;
                document.getElementById('total-reviews').textContent = reviewsData.total || 0;

            } catch (error) {
                console.error("Erro ao carregar contadores do dashboard:", error);
                showMessage('Erro', 'Não foi possível carregar os dados dos contadores.', 'error');
            }
        }

        // Função para carregar o gráfico de serviços por status
        async function carregarServicosPorStatusChart() {
            const token = localStorage.getItem('token');
            if (!token) return;

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/admin/stats/servicos-por-status`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Erro ao carregar dados do gráfico de serviços por status:", errorData.message);
                    return;
                }

                const data = await response.json();
                const options = {
                    series: [{
                        data: data.data
                    }],
                    chart: {
                        type: 'bar',
                        height: 350,
                        toolbar: {
                            show: false
                        }
                    },
                    plotOptions: {
                        bar: {
                            horizontal: false,
                            columnWidth: '55%',
                            endingShape: 'rounded'
                        },
                    },
                    dataLabels: {
                        enabled: false
                    },
                    stroke: {
                        show: true,
                        width: 2,
                        colors: ['transparent']
                    },
                    xaxis: {
                        categories: data.labels,
                    },
                    yaxis: {
                        title: {
                            text: 'Número de Serviços'
                        }
                    },
                    fill: {
                        opacity: 1
                    },
                    tooltip: {
                        y: {
                            formatter: function (val) {
                                return val + " serviços"
                            }
                        }
                    }
                };

                // Limpa o gráfico existente se houver
                const chartElement = document.getElementById('services-status-chart');
                if (chartElement && chartElement.chart) {
                    chartElement.chart.destroy();
                }

                const chart = new ApexCharts(chartElement, options);
                chart.render();
                chartElement.chart = chart; // Armazena a instância do gráfico para destruição futura

            } catch (error) {
                console.error("Erro ao renderizar gráfico de serviços por status:", error);
            }
        }


        // Funções para carregar e gerenciar dados das tabelas (Usuários, Prestadores, Serviços, etc.)
        // Estas funções são placeholders e precisam ser implementadas para buscar dados do backend
        // e popular as tabelas usando DataTables.

        async function carregarUsuarios() {
            const token = localStorage.getItem('token');
            if (!token) return;
            try {
                const response = await fetch(`${BACKEND_BASE_URL}/admin/usuarios`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Erro ao carregar usuários');
                const users = await response.json();
                // Limpa e popula a tabela de usuários
                const tableBody = document.querySelector('#users-table tbody');
                if ($.fn.DataTable.isDataTable('#users-table')) {
                    $('#users-table').DataTable().destroy();
                }
                tableBody.innerHTML = '';
                users.forEach(user => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${user.nome}</td>
                        <td>${user.email}</td>
                        <td>${user.telefone || 'N/A'}</td>
                        <td>${user.isAdmin ? 'Sim' : 'Não'}</td>
                        <td>
                            <div class="dropdown">
                                <a class="btn btn-link font-24 p-0 line-height-1 no-arrow dropdown-toggle" href="#" role="button" data-toggle="dropdown">
                                    <i class="dw dw-more"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list">
                                    <a class="dropdown-item edit-user" href="#" data-id="${user._id}"><i class="dw dw-edit2"></i> Editar</a>
                                    <a class="dropdown-item delete-user" href="#" data-id="${user._id}"><i class="dw dw-delete-3"></i> Deletar</a>
                                </div>
                            </div>
                        </td>
                    `;
                });
                $('#users-table').DataTable({
                    responsive: true
                });
            } catch (error) {
                console.error("Erro ao carregar usuários:", error);
                showMessage('Erro', 'Não foi possível carregar a lista de usuários.', 'error');
            }
        }

        async function carregarPrestadores() {
            const token = localStorage.getItem('token');
            if (!token) return;
            try {
                const response = await fetch(`${BACKEND_BASE_URL}/admin/prestadores`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Erro ao carregar prestadores');
                const providers = await response.json();
                const tableBody = document.querySelector('#providers-table tbody');
                if ($.fn.DataTable.isDataTable('#providers-table')) {
                    $('#providers-table').DataTable().destroy();
                }
                tableBody.innerHTML = '';
                providers.forEach(provider => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${provider.nome}</td>
                        <td>${provider.email}</td>
                        <td>${provider.telefone || 'N/A'}</td>
                        <td>
                            <div class="dropdown">
                                <a class="btn btn-link font-24 p-0 line-height-1 no-arrow dropdown-toggle" href="#" role="button" data-toggle="dropdown">
                                    <i class="dw dw-more"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list">
                                    <a class="dropdown-item edit-provider" href="#" data-id="${provider._id}"><i class="dw dw-edit2"></i> Editar</a>
                                    <a class="dropdown-item delete-provider" href="#" data-id="${provider._id}"><i class="dw dw-delete-3"></i> Deletar</a>
                                </div>
                            </div>
                        </td>
                    `;
                });
                $('#providers-table').DataTable({
                    responsive: true
                });
            } catch (error) {
                console.error("Erro ao carregar prestadores:", error);
                showMessage('Erro', 'Não foi possível carregar a lista de prestadores.', 'error');
            }
        }

        async function carregarServicos() {
            const token = localStorage.getItem('token');
            if (!token) return;
            try {
                const response = await fetch(`${BACKEND_BASE_URL}/admin/servicos`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Erro ao carregar serviços');
                const services = await response.json();
                const tableBody = document.querySelector('#services-table tbody');
                if ($.fn.DataTable.isDataTable('#services-table')) {
                    $('#services-table').DataTable().destroy();
                }
                tableBody.innerHTML = '';
                services.forEach(service => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${service._id.substring(0, 8)}...</td>
                        <td>${service.usuario_id ? service.usuario_id.nome : 'N/A'}</td>
                        <td>${service.prestador_id ? service.prestador_id.nome : 'N/A'}</td>
                        <td>${service.tipo_servico || 'N/A'}</td>
                        <td>${service.status}</td>
                        <td>${service.valor_servico ? `R$ ${service.valor_servico.toFixed(2).replace('.', ',')}` : 'N/A'}</td>
                        <td>
                            <div class="dropdown">
                                <a class="btn btn-link font-24 p-0 line-height-1 no-arrow dropdown-toggle" href="#" role="button" data-toggle="dropdown">
                                    <i class="dw dw-more"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list">
                                    <a class="dropdown-item view-service" href="#" data-id="${service._id}"><i class="dw dw-eye"></i> Ver Detalhes</a>
                                    <a class="dropdown-item edit-service" href="#" data-id="${service._id}"><i class="dw dw-edit2"></i> Editar</a>
                                    <a class="dropdown-item delete-service" href="#" data-id="${service._id}"><i class="dw dw-delete-3"></i> Deletar</a>
                                </div>
                            </div>
                        </td>
                    `;
                });
                $('#services-table').DataTable({
                    responsive: true
                });
            } catch (error) {
                console.error("Erro ao carregar serviços:", error);
                showMessage('Erro', 'Não foi possível carregar a lista de pedidos de serviço.', 'error');
            }
        }

        async function carregarServicosOferecidos() {
            const token = localStorage.getItem('token');
            if (!token) return;
            try {
                const response = await fetch(`${BACKEND_BASE_URL}/admin/servicos-oferecidos`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Erro ao carregar serviços oferecidos');
                const offeredServices = await response.json();
                const tableBody = document.querySelector('#offered-services-table tbody');
                if ($.fn.DataTable.isDataTable('#offered-services-table')) {
                    $('#offered-services-table').DataTable().destroy();
                }
                tableBody.innerHTML = '';
                offeredServices.forEach(service => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${service.nome}</td>
                        <td>${service.prestador_id ? service.prestador_id.nome : 'N/A'}</td>
                        <td>${service.faixa_preco_min ? `R$ ${service.faixa_preco_min.toFixed(2).replace('.', ',')}` : 'N/A'}</td>
                        <td>${service.faixa_preco_max ? `R$ ${service.faixa_preco_max.toFixed(2).replace('.', ',')}` : 'N/A'}</td>
                        <td>${service.categorias.join(', ') || 'N/A'}</td>
                        <td>
                            <div class="dropdown">
                                <a class="btn btn-link font-24 p-0 line-height-1 no-arrow dropdown-toggle" href="#" role="button" data-toggle="dropdown">
                                    <i class="dw dw-more"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list">
                                    <a class="dropdown-item edit-offered-service" href="#" data-id="${service._id}"><i class="dw dw-edit2"></i> Editar</a>
                                    <a class="dropdown-item delete-offered-service" href="#" data-id="${service._id}"><i class="dw dw-delete-3"></i> Deletar</a>
                                </div>
                            </div>
                        </td>
                    `;
                });
                $('#offered-services-table').DataTable({
                    responsive: true
                });
            } catch (error) {
                console.error("Erro ao carregar serviços oferecidos:", error);
                showMessage('Erro', 'Não foi possível carregar a lista de serviços oferecidos.', 'error');
            }
        }

        async function carregarAvaliacoes() {
            const token = localStorage.getItem('token');
            if (!token) return;
            try {
                const response = await fetch(`${BACKEND_BASE_URL}/admin/avaliacoes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Erro ao carregar avaliações');
                const reviews = await response.json();
                const tableBody = document.querySelector('#reviews-table tbody');
                if ($.fn.DataTable.isDataTable('#reviews-table')) {
                    $('#reviews-table').DataTable().destroy();
                }
                tableBody.innerHTML = '';
                reviews.forEach(review => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${review.pedido_servico_id ? review.pedido_servico_id._id.substring(0, 8) + '...' : 'N/A'}</td>
                        <td>${review.cliente_id ? review.cliente_id.nome : 'N/A'}</td>
                        <td>${review.prestador_id ? review.prestador_id.nome : 'N/A'}</td>
                        <td>${review.pedido_servico_id ? review.pedido_servico_id.tipo_servico : 'N/A'}</td>
                        <td>${review.nota}</td>
                        <td>${review.comentario || 'Sem comentário'}</td>
                        <td>
                            <div class="dropdown">
                                <a class="btn btn-link font-24 p-0 line-height-1 no-arrow dropdown-toggle" href="#" role="button" data-toggle="dropdown">
                                    <i class="dw dw-more"></i>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list">
                                    <a class="dropdown-item edit-review" href="#" data-id="${review._id}"><i class="dw dw-edit2"></i> Editar</a>
                                    <a class="dropdown-item delete-review" href="#" data-id="${review._id}"><i class="dw dw-delete-3"></i> Deletar</a>
                                </div>
                            </div>
                        </td>
                    `;
                });
                $('#reviews-table').DataTable({
                    responsive: true
                });
            } catch (error) {
                console.error("Erro ao carregar avaliações:", error);
                showMessage('Erro', 'Não foi possível carregar a lista de avaliações.', 'error');
            }
        }

        // Event Listeners para os menus da sidebar
        document.addEventListener("DOMContentLoaded", () => {
            carregarPerfilAdmin();

            document.getElementById('menu-usuarios').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('usuarios');
                carregarUsuarios(); // Carrega os dados da tabela de usuários
            });
            document.getElementById('menu-usuarios-listar').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('usuarios');
                carregarUsuarios();
            });
            document.getElementById('menu-usuarios-criar').addEventListener('click', (e) => {
                e.preventDefault();
                // Limpa o formulário e abre o modal para criar
                document.getElementById('user-form').reset();
                document.getElementById('user-id').value = '';
                document.getElementById('user-modal-title').textContent = 'Adicionar Usuário';
                document.getElementById('user-password-group').style.display = 'block'; // Senha obrigatória para novo
                document.getElementById('user-password').required = true;
                $('#user-modal').modal('show');
            });

            document.getElementById('menu-prestadores').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('prestadores');
                carregarPrestadores(); // Carrega os dados da tabela de prestadores
            });
            document.getElementById('menu-prestadores-listar').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('prestadores');
                carregarPrestadores();
            });
            document.getElementById('menu-prestadores-criar').addEventListener('click', (e) => {
                e.preventDefault();
                // Limpa o formulário e abre o modal para criar
                document.getElementById('provider-form').reset();
                document.getElementById('provider-id').value = '';
                document.getElementById('provider-modal-title').textContent = 'Adicionar Prestador';
                document.getElementById('provider-password-group').style.display = 'block'; // Senha obrigatória para novo
                document.getElementById('provider-password').required = true;
                $('#provider-modal').modal('show');
            });

            document.getElementById('menu-servicos').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('servicos');
                carregarServicos(); // Carrega os dados da tabela de serviços
            });
            document.getElementById('menu-servicos-listar').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('servicos');
                carregarServicos();
            });

            document.getElementById('menu-servicos-oferecidos').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('servicos-oferecidos');
                carregarServicosOferecidos(); // Carrega os dados da tabela de serviços oferecidos
            });
            document.getElementById('menu-servicos-oferecidos-listar').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('servicos-oferecidos');
                carregarServicosOferecidos();
            });
            document.getElementById('menu-servicos-oferecidos-criar').addEventListener('click', async (e) => {
                e.preventDefault();
                document.getElementById('offered-service-form').reset();
                document.getElementById('offered-service-id').value = '';
                document.getElementById('offered-service-modal-title').textContent = 'Adicionar Serviço Oferecido';
                // Carregar prestadores para o select
                const token = localStorage.getItem('token');
                if (!token) return;
                try {
                    const response = await fetch(`${BACKEND_BASE_URL}/admin/prestadores`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!response.ok) throw new Error('Erro ao carregar prestadores para o select');
                    const providers = await response.json();
                    const select = document.getElementById('offered-service-provider');
                    select.innerHTML = '<option value="">Selecione um Prestador</option>';
                    providers.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p._id;
                        option.textContent = p.nome;
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error("Erro ao carregar prestadores para select:", error);
                    showMessage('Erro', 'Não foi possível carregar a lista de prestadores para o serviço oferecido.', 'error');
                }
                $('#offered-service-modal').modal('show');
            });


            document.getElementById('menu-avaliacoes').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('avaliacoes');
                carregarAvaliacoes(); // Carrega os dados da tabela de avaliações
            });
            document.getElementById('menu-avaliacoes-listar').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('avaliacoes');
                carregarAvaliacoes();
            });

            // Listener para o link do Dashboard (visão geral)
            document.querySelector('.sidebar-menu a[href="admin-dashboard.html"]').addEventListener('click', (e) => {
                e.preventDefault();
                showSection('overview');
                carregarContadores();
                carregarServicosPorStatusChart();
            });

            // Função de Logout
            document.getElementById('logout-link').addEventListener('click', (e) => {
                e.preventDefault(); // Previne a navegação padrão
                localStorage.removeItem('token'); // Remove o token do localStorage
                localStorage.removeItem('admin'); // Remove o cache do admin
                window.location.href = 'login-admin.html'; // Redireciona para a tela de login de admin
            });


            // --- Lógica para os formulários de CRUD ---
            // Usuários
            document.getElementById('user-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const userId = document.getElementById('user-id').value;
                const nome = document.getElementById('user-name').value;
                const email = document.getElementById('user-email').value;
                const telefone = document.getElementById('user-phone').value;
                const senha = document.getElementById('user-password').value;
                const isAdmin = document.getElementById('user-is-admin').checked;
                const fotoPerfil = document.getElementById('user-profile-picture').files[0];

                const formData = new FormData();
                formData.append('nome', nome);
                formData.append('email', email);
                if (telefone) formData.append('telefone', telefone);
                if (senha && userId === '') formData.append('senha', senha); // Senha apenas para criação
                formData.append('isAdmin', isAdmin); // Envia o valor booleano ou string 'true'/'false'
                if (fotoPerfil) formData.append('foto_perfil', fotoPerfil);

                const token = localStorage.getItem('token');
                const headers = { 'Authorization': `Bearer ${token}` };
                // Não defina 'Content-Type': 'application/json' quando usar FormData, o navegador faz isso
                // Por isso, remova o header Content-Type para requisições com FormData

                let url = `${BACKEND_BASE_URL}/admin/usuarios`;
                let method = 'POST';
                if (userId) {
                    url = `${BACKEND_BASE_URL}/admin/usuarios/${userId}`;
                    method = 'PUT';
                    // Para PUT com FormData, se o backend espera JSON para alguns campos e file para outros,
                    // pode ser necessário enviar o JSON em um campo separado do FormData,
                    // ou fazer duas requisições (uma para dados, outra para foto).
                    // Para simplificar, estamos enviando tudo como FormData e o backend deve parsear.
                }

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData // Envia FormData diretamente
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.message || 'Erro ao salvar usuário.');
                    }
                    showMessage('Sucesso', result.message, 'success');
                    $('#user-modal').modal('hide');
                    carregarUsuarios(); // Recarrega a tabela
                } catch (error) {
                    console.error("Erro ao salvar usuário:", error);
                    showMessage('Erro', error.message, 'error');
                }
            });

            // Event listener para o botão de editar usuário
            document.getElementById('usuarios-section').addEventListener('click', async (e) => {
                if (e.target.classList.contains('edit-user')) {
                    e.preventDefault();
                    const userId = e.target.dataset.id;
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    try {
                        const response = await fetch(`${BACKEND_BASE_URL}/admin/usuarios/${userId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (!response.ok) throw new Error('Erro ao buscar dados do usuário');
                        const user = await response.json();

                        document.getElementById('user-id').value = user._id;
                        document.getElementById('user-name').value = user.nome;
                        document.getElementById('user-email').value = user.email;
                        document.getElementById('user-phone').value = user.telefone || '';
                        document.getElementById('user-password-group').style.display = 'none'; // Não edita a senha por aqui
                        document.getElementById('user-password').required = false;
                        document.getElementById('user-is-admin').checked = user.isAdmin; // Define o checkbox

                        document.getElementById('user-modal-title').textContent = 'Editar Usuário';
                        $('#user-modal').modal('show');
                    } catch (error) {
                        console.error("Erro ao carregar dados para edição de usuário:", error);
                        showMessage('Erro', error.message, 'error');
                    }
                } else if (e.target.classList.contains('delete-user')) {
                    e.preventDefault();
                    const userId = e.target.dataset.id;
                    Swal.fire({
                        title: 'Tem certeza?',
                        text: "Você não poderá reverter isso!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sim, deletar!',
                        cancelButtonText: 'Cancelar'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            const token = localStorage.getItem('token');
                            if (!token) return;
                            try {
                                const response = await fetch(`${BACKEND_BASE_URL}/admin/usuarios/${userId}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                const result = await response.json();
                                if (!response.ok) {
                                    throw new Error(result.message || 'Erro ao deletar usuário.');
                                }
                                showMessage('Deletado!', result.message, 'success');
                                carregarUsuarios(); // Recarrega a tabela
                            } catch (error) {
                                console.error("Erro ao deletar usuário:", error);
                                showMessage('Erro', error.message, 'error');
                            }
                        }
                    });
                }
            });

            // Prestadores (Implementação similar aos usuários)
            document.getElementById('provider-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const providerId = document.getElementById('provider-id').value;
                const nome = document.getElementById('provider-name').value;
                const email = document.getElementById('provider-email').value;
                const telefone = document.getElementById('provider-phone').value;
                const senha = document.getElementById('provider-password').value;
                const fotoPerfil = document.getElementById('provider-profile-picture').files[0];

                const formData = new FormData();
                formData.append('nome', nome);
                formData.append('email', email);
                if (telefone) formData.append('telefone', telefone);
                if (senha && providerId === '') formData.append('senha', senha);
                if (fotoPerfil) formData.append('foto_perfil', fotoPerfil);

                const token = localStorage.getItem('token');
                let url = `${BACKEND_BASE_URL}/admin/prestadores`;
                let method = 'POST';
                if (providerId) {
                    url = `${BACKEND_BASE_URL}/admin/prestadores/${providerId}`;
                    method = 'PUT';
                }

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.message || 'Erro ao salvar prestador.');
                    }
                    showMessage('Sucesso', result.message, 'success');
                    $('#provider-modal').modal('hide');
                    carregarPrestadores();
                } catch (error) {
                    console.error("Erro ao salvar prestador:", error);
                    showMessage('Erro', error.message, 'error');
                }
            });

            document.getElementById('prestadores-section').addEventListener('click', async (e) => {
                if (e.target.classList.contains('edit-provider')) {
                    e.preventDefault();
                    const providerId = e.target.dataset.id;
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    try {
                        const response = await fetch(`${BACKEND_BASE_URL}/admin/prestadores/${providerId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (!response.ok) throw new Error('Erro ao buscar dados do prestador');
                        const provider = await response.json();

                        document.getElementById('provider-id').value = provider._id;
                        document.getElementById('provider-name').value = provider.nome;
                        document.getElementById('provider-email').value = provider.email;
                        document.getElementById('provider-phone').value = provider.telefone || '';
                        document.getElementById('provider-password-group').style.display = 'none';
                        document.getElementById('provider-password').required = false;

                        document.getElementById('provider-modal-title').textContent = 'Editar Prestador';
                        $('#provider-modal').modal('show');
                    } catch (error) {
                        console.error("Erro ao carregar dados para edição de prestador:", error);
                        showMessage('Erro', error.message, 'error');
                    }
                } else if (e.target.classList.contains('delete-provider')) {
                    e.preventDefault();
                    const providerId = e.target.dataset.id;
                    Swal.fire({
                        title: 'Tem certeza?',
                        text: "Você não poderá reverter isso!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sim, deletar!',
                        cancelButtonText: 'Cancelar'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            const token = localStorage.getItem('token');
                            if (!token) return;
                            try {
                                const response = await fetch(`${BACKEND_BASE_URL}/admin/prestadores/${providerId}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                const result = await response.json();
                                if (!response.ok) {
                                    throw new Error(result.message || 'Erro ao deletar prestador.');
                                }
                                showMessage('Deletado!', result.message, 'success');
                                carregarPrestadores();
                            } catch (error) {
                                console.error("Erro ao deletar prestador:", error);
                                showMessage('Erro', error.message, 'error');
                            }
                        }
                    });
                }
            });

            // Serviços (Pedidos de Serviço)
            document.getElementById('servicos-section').addEventListener('click', async (e) => {
                if (e.target.classList.contains('view-service')) {
                    e.preventDefault();
                    const serviceId = e.target.dataset.id;
                    // Implementar modal ou redirecionamento para ver detalhes do serviço
                    showMessage('Detalhes do Serviço', `Visualizando detalhes do serviço ID: ${serviceId}`, 'info');
                    // Você pode abrir um modal com mais informações ou redirecionar para uma página de detalhes
                } else if (e.target.classList.contains('edit-service')) {
                    e.preventDefault();
                    const serviceId = e.target.dataset.id;
                    // Implementar modal para editar serviço
                    showMessage('Editar Serviço', `Editando serviço ID: ${serviceId}`, 'info');
                } else if (e.target.classList.contains('delete-service')) {
                    e.preventDefault();
                    const serviceId = e.target.dataset.id;
                    Swal.fire({
                        title: 'Tem certeza?',
                        text: "Você não poderá reverter isso!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sim, deletar!',
                        cancelButtonText: 'Cancelar'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            const token = localStorage.getItem('token');
                            if (!token) return;
                            try {
                                const response = await fetch(`${BACKEND_BASE_URL}/admin/servicos/${serviceId}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                const result = await response.json();
                                if (!response.ok) {
                                    throw new Error(result.message || 'Erro ao deletar serviço.');
                                }
                                showMessage('Deletado!', result.message, 'success');
                                carregarServicos();
                                carregarContadores(); // Atualiza contadores após deletar
                                carregarServicosPorStatusChart(); // Atualiza gráfico
                            } catch (error) {
                                console.error("Erro ao deletar serviço:", error);
                                showMessage('Erro', error.message, 'error');
                            }
                        }
                    });
                }
            });

            // Serviços Oferecidos
            document.getElementById('offered-services-table').addEventListener('click', async (e) => {
                if (e.target.classList.contains('edit-offered-service')) {
                    e.preventDefault();
                    const serviceId = e.target.dataset.id;
                    const token = localStorage.getItem('token');
                    if (!token) return;

                    try {
                        const response = await fetch(`${BACKEND_BASE_URL}/admin/servicos-oferecidos/${serviceId}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (!response.ok) throw new Error('Erro ao buscar dados do serviço oferecido');
                        const service = await response.json();

                        document.getElementById('offered-service-id').value = service._id;
                        document.getElementById('offered-service-name').value = service.nome;
                        document.getElementById('offered-service-description').value = service.descricao || '';
                        document.getElementById('offered-service-min-price').value = service.faixa_preco_min || '';
                        document.getElementById('offered-service-max-price').value = service.faixa_preco_max || '';
                        document.getElementById('offered-service-categories').value = service.categorias.join(', ') || '';

                        // Carregar prestadores para o select e selecionar o atual
                        const providersResponse = await fetch(`${BACKEND_BASE_URL}/admin/prestadores`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (!providersResponse.ok) throw new Error('Erro ao carregar prestadores para o select');
                        const providers = await providersResponse.json();
                        const select = document.getElementById('offered-service-provider');
                        select.innerHTML = '<option value="">Selecione um Prestador</option>';
                        providers.forEach(p => {
                            const option = document.createElement('option');
                            option.value = p._id;
                            option.textContent = p.nome;
                            select.appendChild(option);
                        });
                        if (service.prestador_id) {
                            select.value = service.prestador_id;
                        }

                        document.getElementById('offered-service-modal-title').textContent = 'Editar Serviço Oferecido';
                        $('#offered-service-modal').modal('show');
                    } catch (error) {
                        console.error("Erro ao carregar dados para edição de serviço oferecido:", error);
                        showMessage('Erro', error.message, 'error');
                    }
                } else if (e.target.classList.contains('delete-offered-service')) {
                    e.preventDefault();
                    const serviceId = e.target.dataset.id;
                    Swal.fire({
                        title: 'Tem certeza?',
                        text: "Você não poderá reverter isso!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sim, deletar!',
                        cancelButtonText: 'Cancelar'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            const token = localStorage.getItem('token');
                            if (!token) return;
                            try {
                                const response = await fetch(`${BACKEND_BASE_URL}/admin/servicos-oferecidos/${serviceId}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                const result = await response.json();
                                if (!response.ok) {
                                    throw new Error(result.message || 'Erro ao deletar serviço oferecido.');
                                }
                                showMessage('Deletado!', result.message, 'success');
                                carregarServicosOferecidos();
                            } catch (error) {
                                console.error("Erro ao deletar serviço oferecido:", error);
                                showMessage('Erro', error.message, 'error');
                            }
                        }
                    });
                }
            });

            document.getElementById('offered-service-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const serviceId = document.getElementById('offered-service-id').value;
                const nome = document.getElementById('offered-service-name').value;
                const descricao = document.getElementById('offered-service-description').value;
                const prestador_id = document.getElementById('offered-service-provider').value;
                const faixa_preco_min = document.getElementById('offered-service-min-price').value;
                const faixa_preco_max = document.getElementById('offered-service-max-price').value;
                const categorias = document.getElementById('offered-service-categories').value.split(',').map(c => c.trim()).filter(c => c !== '');

                const serviceData = {
                    nome,
                    descricao,
                    prestador_id,
                    faixa_preco_min: faixa_preco_min ? parseFloat(faixa_preco_min) : null,
                    faixa_preco_max: faixa_preco_max ? parseFloat(faixa_preco_max) : null,
                    categorias
                };

                const token = localStorage.getItem('token');
                let url = `${BACKEND_BASE_URL}/admin/servicos-oferecidos`;
                let method = 'POST';
                if (serviceId) {
                    url = `${BACKEND_BASE_URL}/admin/servicos-oferecidos/${serviceId}`;
                    method = 'PUT';
                }

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(serviceData)
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.message || 'Erro ao salvar serviço oferecido.');
                    }
                    showMessage('Sucesso', result.message, 'success');
                    $('#offered-service-modal').modal('hide');
                    carregarServicosOferecidos();
                } catch (error) {
                    console.error("Erro ao salvar serviço oferecido:", error);
                    showMessage('Erro', error.message, 'error');
                }
            });

            // Avaliações
            document.getElementById('avaliacoes-section').addEventListener('click', async (e) => {
                if (e.target.classList.contains('edit-review')) {
                    e.preventDefault();
                    const reviewId = e.target.dataset.id;
                    // Implementar modal para editar avaliação
                    showMessage('Editar Avaliação', `Editando avaliação ID: ${reviewId}`, 'info');
                } else if (e.target.classList.contains('delete-review')) {
                    e.preventDefault();
                    const reviewId = e.target.dataset.id;
                    Swal.fire({
                        title: 'Tem certeza?',
                        text: "Você não poderá reverter isso!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sim, deletar!',
                        cancelButtonText: 'Cancelar'
                    }).then(async (result) => {
                        if (result.isConfirmed) {
                            const token = localStorage.getItem('token');
                            if (!token) return;
                            try {
                                const response = await fetch(`${BACKEND_BASE_URL}/admin/avaliacoes/${reviewId}`, {
                                    method: 'DELETE',
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                const result = await response.json();
                                if (!response.ok) {
                                    throw new Error(result.message || 'Erro ao deletar avaliação.');
                                }
                                showMessage('Deletado!', result.message, 'success');
                                carregarAvaliacoes();
                                carregarContadores(); // Atualiza contadores após deletar
                            } catch (error) {
                                console.error("Erro ao deletar avaliação:", error);
                                showMessage('Erro', error.message, 'error');
                            }
                        }
                    });
                }
            });
        });

    </script>
</body>
</html>
