<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>WYN - Meus Chats</title>

    <link
        rel="apple-touch-icon"
        sizes="180x180"
        href="/w/1.png"
    />
    <link
        rel="icon"
        type="image/png"
        sizes="32x32"
        href="/w/1.png"
    />
    <link
        rel="icon"
        type="image/png"
        sizes="16x16"
        href="/w/1.png"
    />

    <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
    />

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="vendors/styles/core.css" />
    <link
        rel="stylesheet"
        type="text/css"
        href="vendors/styles/icon-font.min.css"
    />
     <link
        rel="stylesheet"
        type="text/css"
        href="src/plugins/datatables/css/dataTables.bootstrap4.min.css"
    />
    <link
        rel="stylesheet"
        type="text/css"
        href="src/plugins/datatables/css/responsive.bootstrap4.min.css"
    />
    <link rel="stylesheet" type="text/css" href="vendors/styles/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0x0Ugau/r+PRGFNfN/P1M2k/L/W84b36d0K7+v7z/z0q0+A==" crossorigin="anonymous" referrerpolicy="no-referrer" />


    <style>
        /* Estilo para a foto de perfil no header */
        .user-icon img.profile-pic-header {
            border-radius: 50% !important;
            object-fit: cover;
            width: 40px;
            height: 40px;
        }

         /* Estilo para mensagens de feedback (loading, erro, vazio) */
        .feedback-message {
            text-align: center;
            padding: 10px;
            margin: 15px 20px; /* Espaçamento alinhado com a tabela */
            border-radius: 4px;
            font-weight: 500;
        }

        .feedback-loading {
            color: #007bff; /* Cor azul */
            background-color: #e9f5ff; /* Fundo azul claro */
            border: 1px solid #b8daff;
        }

        .feedback-error {
            color: #dc3545; /* Cor vermelha */
            background-color: #f8d7da; /* Fundo vermelho claro */
            border: 1px solid #f5c6cb;
        }

        .feedback-empty {
            color: #6c757d; /* Cor cinza */
            background-color: #f8f9fa; /* Fundo branco/claro */
            border: 1px solid #dee2e6;
        }

        /* Estilo para o container de toasts */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050; /* Acima de modais */
        }

        /* Estilo individual do toast */
        .toast {
            width: 300px;
            max-width: 100%;
            font-size: .875rem;
            background-color: rgba(255,255,255,.85);
            background-clip: padding-box;
            border: 1px solid rgba(0,0,0,.1);
            box-shadow: 0 .25rem .75rem rgba(0,0,0,.1);
            opacity: 0;
            border-radius: .25rem;
        }

        .toast.showing {
            opacity: 1;
        }

        .toast.show {
            display: block;
            opacity: 1;
        }

        .toast.hide {
            display: none;
        }

        .toast-header {
            display: flex;
            align-items: center;
            padding: .25rem .75rem;
            color: #6c757d;
            background-color: rgba(255,255,255,.85);
            background-clip: padding-box;
            border-bottom: 1px solid rgba(0,0,0,.05);
            border-top-left-radius: calc(.25rem - 1px);
            border-top-right-radius: calc(.25rem - 1px);
        }

        .toast-body {
            padding: .75rem;
        }

        /* Cores para os headers dos toasts */
        .toast-header.bg-success { background-color: #28a745 !important; color: white !important; }
        .toast-header.bg-danger { background-color: #dc3545 !important; color: white !important; }
        .toast-header.bg-info { background-color: #17a2b8 !important; color: white !important; }

         /* Estilo para linhas da tabela clicáveis */
         #services-table tbody tr {
             cursor: pointer;
         }
         #services-table tbody tr:hover {
             background-color: #f1f1f1; /* Cor de fundo ao passar o mouse */
         }

        /* Estilo para o badge de mensagens não lidas na lista de chats */
        .unread-badge {
            background-color: #007bff; /* Azul */
            color: white;
            border-radius: 50%;
            padding: 4px 8px;
            font-size: 0.75em;
            margin-left: 10px;
            min-width: 25px; /* Garante que a bolha tenha um tamanho mínimo */
            text-align: center;
            display: inline-block;
        }

    </style>

    <script>
        (function (w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s),
                dl = l != "dataLayer" ? "&l=" + l : "";
            j.async = true;
            j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, "script", "dataLayer", "GTM-NXZMQSS");
    </script>
</head>
<body>
    <div class="pre-loader">
        <div class="pre-loader-box">
            <div class="loader-logo">
                <img src="w.png" alt="" />
            </div>
            <div class="loader-progress" id="progress_div">
                <div class="bar" id="bar1"></div>
            </div>
            <div class="percent" id="percent1">0%</div>
            <div class="loading-text">Carregando...</div>
        </div>
    </div>

    <div class="header">
        <div class="header-left">
            <div class="menu-icon bi bi-list"></div>
            <div
                class="search-toggle-icon bi bi-search"
                data-toggle="header_search"
            ></div>
            <div class="header-search">
                <form>
                    <div class="form-group mb-0">
                        <i class="dw dw-search2 search-icon"></i>
                        <input
                            type="text"
                            class="form-control search-input"
                            placeholder="Search Here"
                        />
                        <div class="dropdown">
                            <a
                                class="dropdown-toggle no-arrow"
                                href="#"
                                role="button"
                                data-toggle="dropdown"
                            >
                                <i class="ion-arrow-down-c"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right">
                                <div class="form-group row">
                                    <label class="col-sm-12 col-md-2 col-form-label"
                                        >De</label
                                    >
                                    <div class="col-sm-12 col-md-10">
                                        <input
                                            class="form-control form-control-sm form-control-line"
                                            type="text"
                                        />
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-sm-12 col-md-2 col-form-label">Para</label>
                                    <div class="col-sm-12 col-md-10">
                                        <input
                                            class="form-control form-control-sm form-control-line"
                                            type="text"
                                        />
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-sm-12 col-md-2 col-form-label"
                                        >Sujeito</label
                                    >
                                    <div class="col-sm-12 col-md-10">
                                        <input
                                            class="form-control form-control-sm form-control-line"
                                            type="text"
                                        />
                                    </div>
                                </div>
                                <div class="text-right">
                                    <button class="btn btn-primary">Pesquisar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="header-right">
            <div class="dashboard-setting user-notification">
                <div class="dropdown">
                    <a
                        class="dropdown-toggle no-arrow"
                        href="javascript:;"
                        data-toggle="right-sidebar"
                    >
                        <i class="dw dw-settings2"></i>
                    </a>
                </div>
            </div>

            <div class="user-info-dropdown">
                <div class="dropdown">
                    <a
                        class="dropdown-toggle"
                        href="#"
                        role="button"
                        data-toggle="dropdown"
                    >
                        <span class="user-icon">
                            <img src="vendors/images/photo1.jpg" id="user-profile-pic" class="profile-pic-header" alt="" />
                        </span>
                        <span class="user-name">Usuário/Prestador</span>
                    </a>
                    <div
                        class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list"
                    >
                        <a class="dropdown-item" href="profile.html"
                            ><i class="dw dw-user1"></i> Perfil</a
                        >
                        <a class="dropdown-item" href="profile.html"
                            ><i class="dw dw-settings2"></i>Configurações</a
                        >
                        <a class="dropdown-item" href="faq.html"
                            ><i class="dw dw-help"></i> Ajuda</a
                        >
                        <a class="dropdown-item" href="#" id="logout-link"
                            ><i class="dw dw-logout"></i> Sair</a
                        >
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="right-sidebar">
        <div class="sidebar-title">
            <h3 class="weight-600 font-16 text-blue">
                Configuração de Layout
                <span class="btn-block font-weight-400 font-12"
                    >Personalização</span
                >
            </h3>
            <div class="close-sidebar" data-toggle="right-sidebar-close">
                <i class="icon-copy ion-close-round"></i>
            </div>
        </div>
        <div class="right-sidebar-body customscroll">
            <div class="right-sidebar-body-content">
                <h4 class="weight-600 font-18 pb-10">Fundo</h4>
                <div class="sidebar-btn-group pb-30 mb-10">
                    <a
                        href="javascript:void(0);"
                        class="btn btn-outline-primary header-white active"
                        >Claro</a
                    >
                    <a
                        href="javascript:void(0);"
                        class="btn btn-outline-primary header-dark"
                        >Escuro</a
                    >
                </div>

                <h4 class="weight-600 font-18 pb-10">Menu Lateral</h4> <div class="sidebar-btn-group pb-30 mb-10">
                    <a
                        href="javascript:void(0);"
                        class="btn btn-outline-primary sidebar-light"
                        >Claro</a
                    >
                    <a
                        href="javascript:void(0);"
                        class="btn btn-outline-primary sidebar-dark active"
                        >Escuro</a
                    >
                </div>

                <h4 class="weight-600 font-18 pb-10">Icone Dropdown</h4> <div class="sidebar-radio-group pb-10 mb-10">
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebaricon-1"
                            name="menu-dropdown-icon"
                            class="custom-control-input"
                            value="icon-style-1"
                            checked=""
                        />
                        <label class="custom-control-label" for="sidebaricon-1"
                            ><i class="fa fa-angle-down"></i
                        ></label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebaricon-2"
                            name="menu-dropdown-icon"
                            class="custom-control-input"
                            value="icon-style-2"
                        />
                        <label class="custom-control-label" for="sidebaricon-2"
                            ><i class="ion-plus-round"></i
                        ></label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebariconlist-3"
                            name="menu-list-icon"
                            class="custom-control-input"
                            value="icon-list-style-3"
                        />
                        <label class="custom-control-label" for="sidebariconlist-3"
                            ><i class="fa fa-angle-double-right"></i
                        ></label>
                    </div>
                </div>

                <h4 class="weight-600 font-18 pb-10">Icones do Menu</h4>
                <div class="sidebar-radio-group pb-30 mb-10">
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebariconlist-1"
                            name="menu-list-icon"
                            class="custom-control-input"
                            value="icon-list-style-1"
                            checked=""
                        />
                        <label class="custom-control-label" for="sidebariconlist-1"
                            ><i class="ion-minus-round"></i
                        ></label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebariconlist-2"
                            name="menu-list-icon"
                            class="custom-control-input"
                            value="icon-list-style-2"
                        />
                        <label class="custom-control-label" for="sidebariconlist-2"
                            ><i class="fa fa-circle-o" aria-hidden="true"></i
                        ></label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebariconlist-3"
                            name="menu-list-icon"
                            class="custom-control-input"
                            value="icon-list-style-3"
                        />
                        <label class="custom-control-label" for="sidebariconlist-3"
                            ><i class="dw dw-check"></i
                        ></label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebariconlist-4"
                            name="menu-list-icon"
                            class="custom-control-input"
                            value="icon-list-style-4"
                            checked=""
                        />
                        <label class="custom-control-label" for="sidebariconlist-4"
                            ><i class="icon-copy dw dw-next-2"></i
                        ></label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebariconlist-5"
                            name="menu-list-icon"
                            class="custom-control-input"
                            value="icon-list-style-5"
                        />
                        <label class="custom-control-label" for="sidebariconlist-5"
                            ><i class="dw dw-fast-forward-1"></i
                        ></label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebariconlist-6"
                            name="menu-list-icon"
                            class="custom-control-input"
                            value="icon-list-style-6"
                        />
                        <label class="custom-control-label" for="sidebariconlist-6"
                            ><i class="dw dw-next"></i
                        ></label>
                    </div>
                </div>

                <div class="reset-options pt-30 text-center">
                    <button class="btn btn-danger" id="reset-settings">
                        Resetar Configurações
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="left-side-bar">
        <div class="brand-logo">
            <a href="indexx.html"> <img src="w (1).png" alt="" class="dark-logo" />
                <img
                    src="w (1).png"
                    alt=""
                    class="light-logo"
                />
            </a>
            <div class="close-sidebar" data-toggle="left-sidebar-close">
                <i class="ion-close-round"></i>
            </div>
        </div>
        <div class="menu-block customscroll">
            <div class="sidebar-menu">
                <ul id="accordion-menu">
                    <li id="cliente-menu">
                        <li>
                            <a href="indexx.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-house"></span
                                ><span class="mtext">Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="catalogo.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-grid"></span
                                ><span class="mtext">Catálogo de Serviços</span>
                            </a>
                        </li>
                        <li>
                            <a href="contratos.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-journal-check"></span
                                ><span class="mtext">Meus Pedidos</span>
                            </a>
                        </li>
                        <li>
                            <a href="chat-list.html" class="dropdown-toggle no-arrow active">
                                <span class="micon bi bi-chat-dots"></span>
                                <span class="mtext">Chat de Pedidos</span>
                                <span id="unread-chat-count-sidebar-cliente" class="badge badge-pill badge-danger" style="display: none; margin-left: 5px;">0</span>
                            </a>
                        </li>
                         <li>
                         <li>
                            <a href="profile.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-person"></span>
                                <span class="mtext">Meu Perfil</span>
                            </a>
                        </li>
                    </li>
                     <li id="prestador-menu" style="display: none;">
                         <li>
                             <a href="index.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-house"></span
                                 ><span class="mtext">Dashboard</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-solicitacoes.html" class="dropdown-toggle no-arrow">
                                 <span class="micon bi bi-textarea-resize"></span>
                                 <span class="mtext">Solicitações Pendentes</span>
                                 <span id="new-solicitation-indicator" class="badge badge-pill badge-danger" style="display: none; margin-left: 5px;">Novo!</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-meus-servicos.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-check-circle"></span
                                 ><span class="mtext">Meus Serviços Aceitos</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-historico.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-clock-history"></span
                                 ><span class="mtext">Histórico de Serviços</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-avaliacoes.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-star-fill"></span
                                 ><span class="mtext">Minhas Avaliações</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-gerenciar-servicos.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-gear"></span>
                                 <span class="mtext">Gerenciar Serviços</span>
                             </a>
                         </li>
                          <li>
                             <a href="prestador-minha-disponibilidade.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-calendar-week"></span>
                                 <span class="mtext">Minha Disponibilidade</span>
                             </a>
                         </li>
                          <li>
                             <a href="chat-list.html" class="dropdown-toggle no-arrow active"> <span class="micon bi bi-chat-dots"></span>
                                 <span class="mtext">Chat de Serviços</span>
                                  <span id="unread-chat-count-sidebar-prestador" class="badge badge-pill badge-danger" style="display: none; margin-left: 5px;">0</span>
                             </a>
                         </li>
                     </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="mobile-menu-overlay"></div>

    <div class="main-container">
        <div class="xs-pd-20-10 pd-ltr-20">
            <div class="title pb-20">
                <div>
                    <h2 class="h3 mb-0">Chats Ativos</h2>
                    <p class="font-14 text-secondary weight-500">Selecione um serviço para abrir o chat.</p>
                </div>
            </div>

            <div class="card-box pb-10">
                <div id="loading-services" class="feedback-message feedback-loading" style="display: none;">Carregando chats...</div>
                <div id="feedback-services" class="feedback-message feedback-error" style="display: none;"></div>
                <div id="empty-services" class="feedback-message feedback-empty" style="display: none;">Nenhum chat ativo encontrado.</div>

                <table class="data-table table nowrap" id="services-table">
                    <thead>
                        <tr>
                            <th class="table-plus">Serviço</th>
                            <th>Participante</th> <th>Status</th>
                            <th>Última Mensagem</th>
                            <th>Não Lidas</th>
                        </tr>
                    </thead>
                    <tbody id="services-list-body">
                        </tbody>
                </table>
            </div>

            <div class="footer-wrap pd-20 mb-20 card-box">
                Plataforma WYN-TECH
            </div>
        </div>
    </div>

    <div id="toastContainer">
       </div>


    <script src="vendors/scripts/core.js"></script>
    <script src="vendors/scripts/script.min.js"></script>
    <script src="vendors/scripts/process.js"></script>
    <script src="vendors/scripts/layout-settings.js"></script>
     <script src="src/plugins/datatables/js/jquery.dataTables.min.js"></script>
    <script src="src/plugins/datatables/js/dataTables.bootstrap4.min.js"></script>
    <script src="src/plugins/datatables/js/dataTables.responsive.min.js"></script>
    <script src="src/plugins/datatables/js/responsive.bootstrap4.min.js"></script>
     <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NXZMQSS" height="0" width="0" style="display: none; visibility: hidden"></iframe>
    </noscript>

    <script>
        const BACKEND_BASE_URL = 'https://wyn-backend.onrender.com';
        let usuarioLogado = null;
        let usuarioTipo = null;
        let unreadChatPollingInterval = null;


        // Função para exibir toast notifications (copiada das outras telas)
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                const newToastContainer = document.createElement('div');
                newToastContainer.id = 'toastContainer';
                newToastContainer.style.position = 'fixed';
                newToastContainer.style.top = '20px';
                newToastContainer.style.right = '20px';
                newToastContainer.style.zIndex = '1050';
                document.body.appendChild(newToastContainer);
                // Re-select the container
                toastContainer = document.getElementById('toastContainer');
            }

            const toastElement = document.createElement('div');
            toastElement.classList.add('toast');
            toastElement.setAttribute('role', 'alert');
            toastElement.setAttribute('aria-live', 'assertive');
            toastElement.setAttribute('aria-atomic', 'true');
            toastElement.setAttribute('data-delay', '5000');

            toastElement.innerHTML = `
                <div class="toast-header ${type === 'success' ? 'bg-success text-white' : type === 'danger' ? 'bg-danger text-white' : 'bg-info text-white'}">
                    <strong class="mr-auto">${type === 'success' ? 'Sucesso' : type === 'danger' ? 'Erro' : 'Informação'}</strong>
                    <small>Agora</small>
                    <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;

            toastContainer.appendChild(toastElement);
            $(toastElement).toast('show');
            $(toastElement).on('hidden.bs.toast', function () {
                $(this).remove();
            });
        }


        async function carregarPerfil() {
            const token = localStorage.getItem('token');
            const usuarioCache = localStorage.getItem('usuario');
            const prestadorCache = localStorage.getItem('prestador');

            const nomeSpan = document.querySelector(".user-name");
            const profilePicImg = document.getElementById("user-profile-pic");

            if (!token) {
                console.warn("[CHAT LIST] Não autenticado. Redirecionando para login.");
                window.location.href = "login.html";
                return;
            }

            try {
                if (usuarioCache) {
                    usuarioLogado = JSON.parse(usuarioCache);
                    usuarioTipo = 'usuario';
                } else if (prestadorCache) {
                    usuarioLogado = JSON.parse(prestadorCache);
                    usuarioTipo = 'prestador';
                }

                if (nomeSpan && usuarioLogado?.nome) {
                    nomeSpan.textContent = usuarioLogado.nome;
                }
                if (profilePicImg && usuarioLogado?.foto_perfil_url) {
                    profilePicImg.src = usuarioLogado.foto_perfil_url;
                    profilePicImg.onerror = function() {
                        this.onerror = null;
                        this.src = usuarioTipo === 'usuario' ? "vendors/images/photo1.jpg" : "vendors/images/photo4.jpg";
                    };
                } else if (profilePicImg) {
                    profilePicImg.src = usuarioTipo === 'usuario' ? "vendors/images/photo1.jpg" : "vendors/images/photo4.jpg";
                }


                const res = await fetch(`${BACKEND_BASE_URL}/perfil`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                const resClone = res.clone();

                if (!res.ok) {
                    if (res.status === 401 || res.status === 403) {
                        console.error("[CHAT LIST] Token inválido ou expirado. Redirecionando para login.");
                        showToast("Sua sessão expirou. Por favor, faça login novamente.", 'danger');
                        localStorage.removeItem('token');
                        localStorage.removeItem('usuario');
                        localStorage.removeItem('prestador');
                        setTimeout(() => { window.location.href = "login.html"; }, 3000);
                        return;
                    }
                    throw new Error(await resClone.text() || `Erro HTTP ao buscar perfil: ${res.status}`);
                }

                let data = {};
                try {
                    data = await res.json();
                } catch(jsonError) {
                    console.error("[CHAT LIST] Erro ao parsear JSON do perfil:", await resClone.text());
                    throw new Error("Resposta de perfil inválida.");
                }

                // CORREÇÃO: Garante que a propriedade 'tipo' seja incluída no usuarioLogado
                if (data.tipo === 'usuario' && data.usuario?._id) {
                    usuarioLogado = { ...data.usuario, tipo: data.tipo };
                    usuarioTipo = 'usuario';
                    localStorage.setItem('usuario', JSON.stringify(usuarioLogado));
                    localStorage.removeItem('prestador');
                    document.getElementById('cliente-menu').style.display = 'block';
                    document.getElementById('prestador-menu').style.display = 'none';
                } else if (data.tipo === 'prestador' && data.prestador?._id) {
                    usuarioLogado = { ...data.prestador, tipo: data.tipo };
                    usuarioTipo = 'prestador';
                    localStorage.setItem('prestador', JSON.stringify(usuarioLogado));
                    localStorage.removeItem('usuario');
                    document.getElementById('cliente-menu').style.display = 'none';
                    document.getElementById('prestador-menu').style.display = 'block';
                } else {
                    console.error("[CHAT LIST] Token válido, mas tipo de usuário/prestador desconhecido ou dados incompletos.");
                    showToast("Erro ao carregar perfil. Faça login novamente.", 'danger');
                    localStorage.removeItem('token');
                    localStorage.removeItem('usuario');
                    localStorage.removeItem('prestador');
                    setTimeout(() => { window.location.href = "login.html"; }, 3000);
                    return;
                }

                if (usuarioLogado?.nome && nomeSpan) {
                    nomeSpan.textContent = usuarioLogado.nome;
                }
                if (profilePicImg && usuarioLogado?.foto_perfil_url) {
                    profilePicImg.src = usuarioLogado.foto_perfil_url;
                    profilePicImg.onerror = function() {
                        this.onerror = null;
                        this.src = usuarioTipo === 'usuario' ? "vendors/images/photo1.jpg" : "vendors/images/photo4.jpg";
                    };
                } else if (profilePicImg) {
                    profilePicImg.src = usuarioTipo === 'usuario' ? "vendors/images/photo1.jpg" : "vendors/images/photo4.jpg";
                }

                console.log(`[CHAT LIST] Perfil de ${usuarioTipo} carregado:`, usuarioLogado);

                carregarListaServicosParaChat();
                iniciarPollingMensagensNaoLidas();

            } catch (err) {
                console.error('[CHAT LIST] Erro ao carregar perfil:', err);
                showToast('Ocorreu um erro ao carregar informações do perfil.', 'danger');
            }
        }

        document.getElementById('logout-link').addEventListener('click', (e) => {
             e.preventDefault();
             localStorage.removeItem('token');
             localStorage.removeItem('usuario');
             localStorage.removeItem('prestador');
             pararPollingMensagensNaoLidas();
             window.location.href = 'login.html';
        });

        async function carregarListaServicosParaChat() {
            const loading = document.getElementById("loading-services");
            const feedback = document.getElementById("feedback-services");
            const empty = document.getElementById("empty-services");
            const servicesListBody = document.getElementById("services-list-body");
            const token = localStorage.getItem("token");

            loading.style.display = "block";
            feedback.style.display = "none";
            empty.style.display = "none";
            servicesListBody.innerHTML = "";

            if (!token || !usuarioLogado || !usuarioTipo) {
                feedback.textContent = "Autenticação necessária para carregar chats.";
                feedback.style.display = "block";
                loading.style.display = "none";
                console.warn("[CHAT LIST] carregarListaServicosParaChat: Token, usuário ou tipo faltando.");
                return;
            }

            if ($.fn.DataTable.isDataTable('#services-table')) {
                $('#services-table').DataTable().destroy();
            }

            try {
                let endpoint = '';
                if (usuarioTipo === 'usuario') {
                    endpoint = `${BACKEND_BASE_URL}/meus-servicos`;
                } else if (usuarioTipo === 'prestador') {
                    endpoint = `${BACKEND_BASE_URL}/meus-servicos-prestador`;
                } else {
                    feedback.textContent = "Tipo de usuário desconhecido.";
                    feedback.style.display = "block";
                    loading.style.display = "none";
                    console.error("[CHAT LIST] Tipo de usuário inválido para carregar lista de chats:", usuarioTipo);
                    return;
                }

                console.log(`[CHAT LIST] Buscando lista de serviços para chat (${usuarioTipo})...`);
                const response = await fetch(endpoint, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                console.log("[CHAT LIST] Resposta do backend recebida:", response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("[CHAT LIST] Erro HTTP ao buscar lista de serviços para chat:", response.status, errorText);
                    throw new Error(errorText || `Erro HTTP ao buscar lista de serviços para chat: ${response.status}`);
                }

                let servicos = await response.json();
                console.log("[CHAT LIST] Lista de serviços para chat carregada:", servicos);

                // Para cada serviço, tenta buscar a última mensagem e a contagem de não lidas
                const servicesWithChatInfo = await Promise.all(servicos.map(async servico => {
                    let lastMessage = null;
                    let unreadCount = 0;
                    try {
                        const messagesResponse = await fetch(`${BACKEND_BASE_URL}/chat/${servico._id}/messages`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (messagesResponse.ok) {
                            const messages = await messagesResponse.json();
                            if (messages.length > 0) {
                                lastMessage = messages[messages.length - 1];
                                unreadCount = messages.filter(msg =>
                                    msg.remetente_id !== usuarioLogado._id && !msg.lido_por.includes(usuarioLogado._id)
                                ).length;
                            }
                        }
                    } catch (msgError) {
                        console.error(`Erro ao buscar mensagens para o serviço ${servico._id}:`, msgError);
                    }
                    return { ...servico, lastMessage, unreadCount };
                }));


                const servicosComChatAtivo = servicesWithChatInfo.filter(servico =>
                    servico.status !== 'aguardando_aceite_prestador' &&
                    servico.status !== 'recusado_pelo_prestador' &&
                    servico.status !== 'cancelado'
                );

                // Ordena os serviços: primeiro os com mensagens não lidas (mais recentes), depois os demais (mais recentes)
                servicosComChatAtivo.sort((a, b) => {
                    const dateA = a.lastMessage ? new Date(a.lastMessage.data_envio) : new Date(a.data_solicitacao);
                    const dateB = b.lastMessage ? new Date(b.lastMessage.data_envio) : new Date(b.data_solicitacao);

                    // Prioriza chats com mensagens não lidas
                    if (a.unreadCount > 0 && b.unreadCount === 0) return -1;
                    if (a.unreadCount === 0 && b.unreadCount > 0) return 1;

                    // Depois, ordena por data (mais recente primeiro)
                    return dateB.getTime() - dateA.getTime();
                });


                if (servicosComChatAtivo.length === 0) {
                    empty.style.display = "block";
                } else {
                    empty.style.display = "none";
                    servicosComChatAtivo.forEach(servico => {
                        const row = document.createElement('tr');
                        row.dataset.serviceId = servico._id;
                        row.classList.add('service-row');

                        let participanteNome = 'Desconhecido';
                        if (usuarioTipo === 'usuario' && servico.nome_prestador) {
                            participanteNome = servico.nome_prestador;
                        } else if (usuarioTipo === 'prestador' && servico.nome_cliente) {
                            participanteNome = servico.nome_cliente;
                        }

                        const statusMap = {
                            'aguardando_pagamento_cliente': 'Aguardando Pagamento',
                            'aguardando_confirmacao_pagamento': 'Pagamento em Processamento',
                            'aceito_pelo_prestador': 'Em Andamento',
                            'concluido_pelo_prestador': 'Concluído',
                            'avaliado_pelo_cliente': 'Avaliado',
                        };

                        const ultimaMensagemTexto = servico.lastMessage ? servico.lastMessage.conteudo : 'Nenhuma mensagem';
                        const ultimaMensagemTime = servico.lastMessage ? new Date(servico.lastMessage.data_envio).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) : '';

                        row.innerHTML = `
                            <td class="table-plus">${servico.tipo_servico || 'Serviço sem Nome'}</td>
                            <td>${participanteNome}</td>
                            <td>${statusMap[servico.status] || servico.status}</td>
                            <td>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>${ultimaMensagemTexto.substring(0, 50)}${ultimaMensagemTexto.length > 50 ? '...' : ''}</span>
                                    ${servico.unreadCount > 0 ? `<span class="unread-badge">${servico.unreadCount}</span>` : ''}
                                </div>
                                <small class="text-muted">${ultimaMensagemTime}</small>
                            </td>
                        `;
                        servicesListBody.appendChild(row);
                    });

                    $('#services-table').DataTable({
                        responsive: true,
                        paging: true,
                        searching: true,
                        ordering: true,
                        info: true,
                        language: {
                            url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/pt-BR.json'
                        }
                    });

                    document.querySelectorAll('#services-table tbody tr.service-row').forEach(row => {
                        row.addEventListener('click', function() {
                            const serviceId = this.dataset.serviceId;
                            if (serviceId) {
                                console.log("[CHAT LIST] Clicou na linha do serviço:", serviceId);
                                window.location.href = `chat.html?serviceId=${serviceId}`;
                            }
                        });
                    });
                }

            } catch (error) {
                console.error("[CHAT LIST] Erro ao carregar lista de serviços para chat:", error);
                feedback.textContent = `Erro ao carregar lista de chats: ${error.message || 'Verifique a conexão com o servidor.'}`;
                feedback.style.display = "block";
                empty.style.display = "none";
            } finally {
                loading.style.display = "none";
            }
        }

         async function carregarContadorMensagensNaoLidas() {
              const token = localStorage.getItem("token");
              const unreadCountElementCliente = document.getElementById("unread-chat-count-sidebar-cliente");
              const unreadCountElementPrestador = document.getElementById("unread-chat-count-sidebar-prestador");

              if (!token) {
                  if (unreadCountElementCliente) unreadCountElementCliente.style.display = 'none';
                  if (unreadCountElementPrestador) unreadCountElementPrestador.style.display = 'none';
                  return;
              }

              try {
                  const response = await fetch(`${BACKEND_BASE_URL}/api/chat/unread-count`, {
                      headers: { 'Authorization': `Bearer ${token}` }
                  });

                  if (!response.ok) {
                      console.error("[CHAT LIST] Erro ao buscar contagem de mensagens não lidas:", response.status);
                       if (unreadCountElementCliente) unreadCountElementCliente.style.display = 'none';
                       if (unreadCountElementPrestador) unreadCountElementPrestador.style.display = 'none';
                      return;
                  }

                  const data = await response.json();
                  const unreadCount = data.total || 0;

                  if (usuarioTipo === 'usuario' && unreadCountElementCliente) {
                      if (unreadCount > 0) {
                          unreadCountElementCliente.textContent = unreadCount;
                          unreadCountElementCliente.style.display = 'inline';
                      } else {
                          unreadCountElementCliente.style.display = 'none';
                      }
                       if (unreadCountElementPrestador) unreadCountElementPrestador.style.display = 'none';
                  } else if (usuarioTipo === 'prestador' && unreadCountElementPrestador) {
                       if (unreadCount > 0) {
                           unreadCountElementPrestador.textContent = unreadCount;
                           unreadCountElementPrestador.style.display = 'inline';
                       } else {
                           unreadCountElementPrestador.style.display = 'none';
                       }
                        if (unreadCountElementCliente) unreadCountElementCliente.style.display = 'none';
                  }


              } catch (error) {
                  console.error("[CHAT LIST] Erro ao carregar contagem de mensagens não lidas:", error);
                   if (unreadCountElementCliente) unreadCountElementCliente.style.display = 'none';
                   if (unreadCountElementPrestador) unreadCountElementPrestador.style.display = 'none';
              }
         }

          function iniciarPollingMensagensNaoLidas() {
              if (unreadChatPollingInterval) {
                  clearInterval(unreadChatPollingInterval);
              }
              carregarContadorMensagensNaoLidas();
              unreadChatPollingInterval = setInterval(carregarContadorMensagensNaoLidas, 5000);
              console.log("[CHAT LIST] Polling de mensagens não lidas iniciado.");
          }

          function pararPollingMensagensNaoLidas() {
              if (unreadChatPollingInterval) {
                  clearInterval(unreadChatPollingInterval);
                  unreadChatPollingInterval = null;
                  console.log("[CHAT LIST] Polling de mensagens não lidas parado.");
              }
          }

        document.addEventListener("DOMContentLoaded", carregarPerfil);

         window.addEventListener('beforeunload', () => {
              pararPollingMensagensNaoLidas();
         });


    </script>

</body>
</html>
