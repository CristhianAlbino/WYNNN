<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>WYN - Meus Chats</title>

    <link
        rel="apple-touch-icon"
        sizes="180x180"
        href="/w/1.png"
    />
    <link
        rel="icon"
        type="image/png"
        sizes="32x32"
        href="/w/1.png"
    />
    <link
        rel="icon"
        type="image/png"
        sizes="16x16"
        href="/w/1.png"
    />

    <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
    />

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="vendors/styles/core.css" />
    <link
        rel="stylesheet"
        type="text/css"
        href="vendors/styles/icon-font.min.css"
    />
     <link
        rel="stylesheet"
        type="text/css"
        href="src/plugins/datatables/css/dataTables.bootstrap4.min.css"
    />
    <link
        rel="stylesheet"
        type="text/css"
        href="src/plugins/datatables/css/responsive.bootstrap4.min.css"
    />
    <link rel="stylesheet" type="text/css" href="vendors/styles/style.css" />

    <style>
        /* Estilo para a foto de perfil no header */
        .user-icon img.profile-pic-header {
            border-radius: 50% !important;
            object-fit: cover;
            width: 40px;
            height: 40px;
        }

         /* Estilo para mensagens de feedback (loading, erro, vazio) */
        .feedback-message {
            text-align: center;
            padding: 10px;
            margin: 15px 20px; /* Espaçamento alinhado com a tabela */
            border-radius: 4px;
            font-weight: 500;
        }

        .feedback-loading {
            color: #007bff; /* Cor azul */
            background-color: #e9f5ff; /* Fundo azul claro */
            border: 1px solid #b8daff;
        }

        .feedback-error {
            color: #dc3545; /* Cor vermelha */
            background-color: #f8d7da; /* Fundo vermelho claro */
            border: 1px solid #f5c6cb;
        }

        .feedback-empty {
            color: #6c757d; /* Cor cinza */
            background-color: #f8f9fa; /* Fundo branco/claro */
            border: 1px solid #dee2e6;
        }

        /* Estilo para o container de toasts */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050; /* Acima de modais */
        }

        /* Estilo individual do toast */
        .toast {
            width: 300px;
            max-width: 100%;
            font-size: .875rem;
            background-color: rgba(255,255,255,.85);
            background-clip: padding-box;
            border: 1px solid rgba(0,0,0,.1);
            box-shadow: 0 .25rem .75rem rgba(0,0,0,.1);
            opacity: 0;
            border-radius: .25rem;
        }

        .toast.showing {
            opacity: 1;
        }

        .toast.show {
            display: block;
            opacity: 1;
        }

        .toast.hide {
            display: none;
        }

        .toast-header {
            display: flex;
            align-items: center;
            padding: .25rem .75rem;
            color: #6c757d;
            background-color: rgba(255,255,255,.85);
            background-clip: padding-box;
            border-bottom: 1px solid rgba(0,0,0,.05);
            border-top-left-radius: calc(.25rem - 1px);
            border-top-right-radius: calc(.25rem - 1px);
        }

        .toast-body {
            padding: .75rem;
        }

        /* Cores para os headers dos toasts */
        .toast-header.bg-success { background-color: #28a745 !important; color: white !important; }
        .toast-header.bg-danger { background-color: #dc3545 !important; color: white !important; }
        .toast-header.bg-info { background-color: #17a2b8 !important; color: white !important; }

         /* Estilo para linhas da tabela clicáveis */
         #services-table tbody tr {
             cursor: pointer;
         }
         #services-table tbody tr:hover {
             background-color: #f1f1f1; /* Cor de fundo ao passar o mouse */
         }


    </style>

    <script>
        (function (w, d, s, l, i) {
            w[l] = w[l] || [];
            w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
            var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s),
                dl = l != "dataLayer" ? "&l=" + l : "";
            j.async = true;
            j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
            f.parentNode.insertBefore(j, f);
        })(window, document, "script", "dataLayer", "GTM-NXZMQSS");
    </script>
</head>
<body>
    <div class="pre-loader">
        <div class="pre-loader-box">
            <div class="loader-logo">
                <img src="w.png" alt="" />
            </div>
            <div class="loader-progress" id="progress_div">
                <div class="bar" id="bar1"></div>
            </div>
            <div class="percent" id="percent1">0%</div>
            <div class="loading-text">Carregando...</div>
        </div>
    </div>

    <div class="header">
        <div class="header-left">
            <div class="menu-icon bi bi-list"></div>
            <div
                class="search-toggle-icon bi bi-search"
                data-toggle="header_search"
            ></div>
            <div class="header-search">
                <form>
                    <div class="form-group mb-0">
                        <i class="dw dw-search2 search-icon"></i>
                        <input
                            type="text"
                            class="form-control search-input"
                            placeholder="Search Here"
                        />
                        <div class="dropdown">
                            <a
                                class="dropdown-toggle no-arrow"
                                href="#"
                                role="button"
                                data-toggle="dropdown"
                            >
                                <i class="ion-arrow-down-c"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right">
                                <div class="form-group row">
                                    <label class="col-sm-12 col-md-2 col-form-label"
                                        >De</label
                                    >
                                    <div class="col-sm-12 col-md-10">
                                        <input
                                            class="form-control form-control-sm form-control-line"
                                            type="text"
                                        />
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-sm-12 col-md-2 col-form-label">Para</label>
                                    <div class="col-sm-12 col-md-10">
                                        <input
                                            class="form-control form-control-sm form-control-line"
                                            type="text"
                                        />
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="col-sm-12 col-md-2 col-form-label"
                                        >Sujeito</label
                                    >
                                    <div class="col-sm-12 col-md-10">
                                        <input
                                            class="form-control form-control-sm form-control-line"
                                            type="text"
                                        />
                                    </div>
                                </div>
                                <div class="text-right">
                                    <button class="btn btn-primary">Pesquisar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div class="header-right">
            <div class="dashboard-setting user-notification">
                <div class="dropdown">
                    <a
                        class="dropdown-toggle no-arrow"
                        href="javascript:;"
                        data-toggle="right-sidebar"
                    >
                        <i class="dw dw-settings2"></i>
                    </a>
                </div>
            </div>

            <div class="user-info-dropdown">
                <div class="dropdown">
                    <a
                        class="dropdown-toggle"
                        href="#"
                        role="button"
                        data-toggle="dropdown"
                    >
                        <span class="user-icon">
                            <img src="vendors/images/photo1.jpg" id="user-profile-pic" class="profile-pic-header" alt="" />
                        </span>
                        <span class="user-name">Usuário/Prestador</span>
                    </a>
                    <div
                        class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list"
                    >
                        <a class="dropdown-item" href="profile.html"
                            ><i class="dw dw-user1"></i> Perfil</a
                        >
                        <a class="dropdown-item" href="profile.html"
                            ><i class="dw dw-settings2"></i>Configurações</a
                        >
                        <a class="dropdown-item" href="faq.html"
                            ><i class="dw dw-help"></i> Ajuda</a
                        >
                        <a class="dropdown-item" href="#" id="logout-link"
                            ><i class="dw dw-logout"></i> Sair</a
                        >
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="right-sidebar">
        <div class="sidebar-title">
            <h3 class="weight-600 font-16 text-blue">
                Configuração de Layout
                <span class="btn-block font-weight-400 font-12"
                    >Personalização</span
                >
            </h3>
            <div class="close-sidebar" data-toggle="right-sidebar-close">
                <i class="icon-copy ion-close-round"></i>
            </div>
        </div>
        <div class="right-sidebar-body customscroll">
            <div class="right-sidebar-body-content">
                <h4 class="weight-600 font-18 pb-10">Fundo</h4>
                <div class="sidebar-btn-group pb-30 mb-10">
                    <a
                        href="javascript:void(0);"
                        class="btn btn-outline-primary header-white active"
                        >Claro</a
                    >
                    <a
                        href="javascript:void(0);"
                        class="btn btn-outline-primary header-dark"
                        >Escuro</a
                    >
                </div>

                <h4 class="weight-600 font-18 pb-10">Menu Lateral</h4> <div class="sidebar-btn-group pb-30 mb-10">
                    <a
                        href="javascript:void(0);"
                        class="btn btn-outline-primary sidebar-light"
                        >Claro</a
                    >
                    <a
                        href="javascript:void(0);"
                        class="btn btn-outline-primary sidebar-dark active"
                        >Escuro</a
                    >
                </div>

                <h4 class="weight-600 font-18 pb-10">Icone Dropdown</h4> <div class="sidebar-radio-group pb-10 mb-10">
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebaricon-1"
                            name="menu-dropdown-icon"
                            class="custom-control-input"
                            value="icon-style-1"
                            checked=""
                        />
                        <label class="custom-control-label" for="sidebaricon-1"
                            ><i class="fa fa-angle-down"></i
                        ></label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebaricon-2"
                            name="menu-dropdown-icon"
                            class="custom-control-input"
                            value="icon-style-2"
                        />
                        <label class="custom-control-label" for="sidebaricon-2"
                            ><i class="ion-plus-round"></i
                        ></label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebariconlist-3"
                            name="menu-list-icon"
                            class="custom-control-input"
                            value="icon-list-style-3"
                        />
                        <label class="custom-control-label" for="sidebariconlist-3"
                            ><i class="fa fa-angle-double-right"></i
                        ></label>
                    </div>
                </div>

                <h4 class="weight-600 font-18 pb-10">Icones do Menu</h4>
                <div class="sidebar-radio-group pb-30 mb-10">
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebariconlist-1"
                            name="menu-list-icon"
                            class="custom-control-input"
                            value="icon-list-style-1"
                            checked=""
                        />
                        <label class="custom-control-label" for="sidebariconlist-1"
                            ><i class="ion-minus-round"></i
                        ></label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebariconlist-2"
                            name="menu-list-icon"
                            class="custom-control-input"
                            value="icon-list-style-2"
                        />
                        <label class="custom-control-label" for="sidebariconlist-2"
                            ><i class="fa fa-circle-o" aria-hidden="true"></i
                        ></label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebariconlist-3"
                            name="menu-list-icon"
                            class="custom-control-input"
                            value="icon-list-style-3"
                        />
                        <label class="custom-control-label" for="sidebariconlist-3"
                            ><i class="dw dw-check"></i
                        ></label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebariconlist-4"
                            name="menu-list-icon"
                            class="custom-control-input"
                            value="icon-list-style-4"
                            checked=""
                        />
                        <label class="custom-control-label" for="sidebariconlist-4"
                            ><i class="icon-copy dw dw-next-2"></i
                        ></label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebariconlist-5"
                            name="menu-list-icon"
                            class="custom-control-input"
                            value="icon-list-style-5"
                        />
                        <label class="custom-control-label" for="sidebariconlist-5"
                            ><i class="dw dw-fast-forward-1"></i
                        ></label>
                    </div>
                    <div class="custom-control custom-radio custom-control-inline">
                        <input
                            type="radio"
                            id="sidebariconlist-6"
                            name="menu-list-icon"
                            class="custom-control-input"
                            value="icon-list-style-6"
                        />
                        <label class="custom-control-label" for="sidebariconlist-6"
                            ><i class="dw dw-next"></i
                        ></label>
                    </div>
                </div>

                <div class="reset-options pt-30 text-center">
                    <button class="btn btn-danger" id="reset-settings">
                        Resetar Configurações
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="left-side-bar">
        <div class="brand-logo">
            <a href="indexx.html"> <img src="w (1).png" alt="" class="dark-logo" />
                <img
                    src="w (1).png"
                    alt=""
                    class="light-logo"
                />
            </a>
            <div class="close-sidebar" data-toggle="left-sidebar-close">
                <i class="ion-close-round"></i>
            </div>
        </div>
        <div class="menu-block customscroll">
            <div class="sidebar-menu">
                <ul id="accordion-menu">
                    <li id="cliente-menu">
                        <li>
                            <a href="indexx.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-house"></span
                                ><span class="mtext">Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="catalogo.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-grid"></span
                                ><span class="mtext">Catálogo de Serviços</span>
                            </a>
                        </li>
                        <li>
                            <a href="contratos.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-journal-check"></span
                                ><span class="mtext">Meus Pedidos</span>
                            </a>
                        </li>
                        <li>
                            <a href="chat-list.html" class="dropdown-toggle no-arrow active">
                                <span class="micon bi bi-chat-dots"></span>
                                <span class="mtext">Chat de Pedidos</span>
                                <span id="unread-chat-count-sidebar-cliente" class="badge badge-pill badge-danger" style="display: none; margin-left: 5px;">0</span>
                            </a>
                        </li>
                         <li>
                         <li>
                            <a href="profile.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-person"></span>
                                <span class="mtext">Meu Perfil</span>
                            </a>
                        </li>
                    </li>
                     <li id="prestador-menu" style="display: none;">
                         <li>
                             <a href="index.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-house"></span
                                 ><span class="mtext">Dashboard</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-solicitacoes.html" class="dropdown-toggle no-arrow">
                                 <span class="micon bi bi-textarea-resize"></span>
                                 <span class="mtext">Solicitações Pendentes</span>
                                 <span id="new-solicitation-indicator" class="badge badge-pill badge-danger" style="display: none; margin-left: 5px;">Novo!</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-meus-servicos.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-check-circle"></span
                                 ><span class="mtext">Meus Serviços Aceitos</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-historico.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-clock-history"></span
                                 ><span class="mtext">Histórico de Serviços</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-avaliacoes.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-star-fill"></span
                                 ><span class="mtext">Minhas Avaliações</span>
                             </a>
                         </li>
                         <li>
                             <a href="prestador-gerenciar-servicos.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-gear"></span>
                                 <span class="mtext">Gerenciar Serviços</span>
                             </a>
                         </li>
                          <li>
                             <a href="prestador-minha-disponibilidade.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-calendar-week"></span>
                                 <span class="mtext">Minha Disponibilidade</span>
                             </a>
                         </li>
                          <li>
                             <a href="chat-list.html" class="dropdown-toggle no-arrow active"> <span class="micon bi bi-chat-dots"></span>
                                 <span class="mtext">Chat de Serviços</span>
                                  <span id="unread-chat-count-sidebar-prestador" class="badge badge-pill badge-danger" style="display: none; margin-left: 5px;">0</span>
                             </a>
                         </li>
                     </li>

                    <li class="dropdown">
                        <a href="javascript:;" class="dropdown-toggle">
                            <span class="micon bi bi-file-pdf"></span
                            ><span class="mtext">Documentação</span>
                        </a>
                        <ul class="submenu">
                            <li><a href="/Tela Inicial copy/Termos e Condições.docx">Termos e Condições</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="mobile-menu-overlay"></div>

    <div class="main-container">
        <div class="xs-pd-20-10 pd-ltr-20">
            <div class="title pb-20">
                <div>
                    <h2 class="h3 mb-0">Chats Ativos</h2>
                    <p class="font-14 text-secondary weight-500">Selecione um serviço para abrir o chat.</p>
                </div>
            </div>

            <div class="card-box pb-10">
                <div id="loading-services" class="feedback-message feedback-loading" style="display: none;">Carregando chats...</div>
                <div id="feedback-services" class="feedback-message feedback-error" style="display: none;"></div>
                <div id="empty-services" class="feedback-message feedback-empty" style="display: none;">Nenhum chat ativo encontrado.</div>

                <table class="data-table table nowrap" id="services-table">
                    <thead>
                        <tr>
                            <th class="table-plus">Serviço</th>
                            <th>Participante</th> <th>Status</th>
                            <th>Última Mensagem</th> </tr>
                    </thead>
                    <tbody id="services-list-body">
                        </tbody>
                </table>
            </div>

            <div class="footer-wrap pd-20 mb-20 card-box">
                Plataforma WYN-TECH
            </div>
        </div>
    </div>

    <div id="toastContainer">
       </div>


    <script src="vendors/scripts/core.js"></script>
    <script src="vendors/scripts/script.min.js"></script>
    <script src="vendors/scripts/process.js"></script>
    <script src="vendors/scripts/layout-settings.js"></script>
     <script src="src/plugins/datatables/js/jquery.dataTables.min.js"></script>
    <script src="src/plugins/datatables/js/dataTables.bootstrap4.min.js"></script>
    <script src="src/plugins/datatables/js/dataTables.responsive.min.js"></script>
    <script src="src/plugins/datatables/js/responsive.bootstrap4.min.js"></script>
     <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NXZMQSS" height="0" width="0" style="display: none; visibility: hidden"></iframe>
    </noscript>

    <script>
        let usuarioLogado = null; // Variável para armazenar os dados do usuário/prestador logado
        let usuarioTipo = null; // 'usuario' ou 'prestador'
        let unreadChatPollingInterval = null; // Variável para o intervalo de polling de mensagens não lidas


        // Função para exibir toast notifications (copiada das outras telas)
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                console.error("[CHAT LIST] Toast container não encontrado!");
                return;
            }

            const toastElement = document.createElement('div');
            toastElement.classList.add('toast');
            toastElement.setAttribute('role', 'alert');
            toastElement.setAttribute('aria-live', 'assertive');
            toastElement.setAttribute('aria-atomic', 'true');
            toastElement.setAttribute('data-delay', '5000');

            toastElement.innerHTML = `
                <div class="toast-header ${type === 'success' ? 'bg-success text-white' : type === 'danger' ? 'bg-danger text-white' : 'bg-info text-white'}">
                    <strong class="mr-auto">${type === 'success' ? 'Sucesso' : type === 'danger' ? 'Erro' : 'Informação'}</strong>
                    <small>Agora</small>
                    <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;

            toastContainer.appendChild(toastElement);
            $(toastElement).toast('show');
            $(toastElement).on('hidden.bs.toast', function () {
                $(this).remove();
            });
        }


        async function carregarPerfil() {
            const token = localStorage.getItem('token');
            const usuarioCache = localStorage.getItem('usuario'); // Tenta carregar como usuário
            const prestadorCache = localStorage.getItem('prestador'); // Tenta carregar como prestador

            if (!token) {
                console.warn("[CHAT LIST] Não autenticado. Redirecionando para login.");
                window.location.href = "login.html";
                return;
            }

            try {
                 // Tenta carregar do cache primeiro
                 if (usuarioCache) {
                      usuarioLogado = JSON.parse(usuarioCache);
                      usuarioTipo = 'usuario';
                 } else if (prestadorCache) {
                      usuarioLogado = JSON.parse(prestadorCache);
                      usuarioTipo = 'prestador';
                 }

                 const nomeSpan = document.querySelector(".user-name");
                 const profilePicImg = document.getElementById("user-profile-pic"); // ID genérico para a foto no header

                 if (nomeSpan && usuarioLogado?.nome) {
                     nomeSpan.textContent = usuarioLogado.nome;
                 }
                 // Exibe a foto de perfil do cache se existir
                 if (profilePicImg && usuarioLogado?.foto_perfil_url) {
                     profilePicImg.src = usuarioLogado.foto_perfil_url;
                     profilePicImg.onerror = function() {
                         this.onerror = null;
                         this.src = usuarioTipo === 'usuario' ? "vendors/images/photo1.jpg" : "vendors/images/photo4.jpg"; // Fallback por tipo
                     };
                 } else if (profilePicImg) {
                      profilePicImg.src = usuarioTipo === 'usuario' ? "vendors/images/photo1.jpg" : "vendors/images/photo4.jpg"; // Padrão por tipo
                 }


                // Chamada ao backend para validar o token e obter dados completos
                // --- URL ATUALIZADA PARA O BACKEND NO RENDER ---
                 const res = await fetch('https://wyn-backend.onrender.com/perfil', {
                     headers: { 'Authorization': 'Bearer ' + token }
                 });

                 const resClone = res.clone();

                 if (!res.ok) {
                     if (res.status === 401 || res.status === 403) {
                         console.error("[CHAT LIST] Token inválido ou expirado. Redirecionando para login.");
                         showToast("Sua sessão expirou. Por favor, faça login novamente.", 'danger');
                         localStorage.removeItem('token');
                         localStorage.removeItem('usuario');
                         localStorage.removeItem('prestador');
                         setTimeout(() => { window.location.href = "login.html"; }, 3000);
                         return;
                     }
                     const errorText = await resClone.text();
                     console.error("[CHAT LIST] Erro HTTP ao buscar perfil:", res.status, errorText);
                     throw new Error(errorText || `Erro HTTP ao buscar perfil: ${res.status}`);
                 }

                let data = {};
                 try {
                     data = await res.json();
                 } catch(jsonError) {
                     console.error("[CHAT LIST] Erro ao parsear JSON do perfil:", await resClone.text());
                     throw new Error("Resposta de perfil inválida.");
                 }

                // Atualiza a variável global com os dados completos e o tipo, e ajusta o menu lateral
                if (data.tipo === 'usuario' && data.usuario?._id) {
                    usuarioLogado = data.usuario;
                    usuarioTipo = 'usuario';
                    localStorage.setItem('usuario', JSON.stringify(usuarioLogado));
                    localStorage.removeItem('prestador');
                    document.getElementById('cliente-menu').style.display = 'block';
                    document.getElementById('prestador-menu').style.display = 'none';
                } else if (data.tipo === 'prestador' && data.prestador?._id) {
                    usuarioLogado = data.prestador;
                    usuarioTipo = 'prestador';
                    localStorage.setItem('prestador', JSON.stringify(usuarioLogado));
                    localStorage.removeItem('usuario');
                     document.getElementById('cliente-menu').style.display = 'none';
                    document.getElementById('prestador-menu').style.display = 'block';
                } else {
                     console.error("[CHAT LIST] Token válido, mas tipo de usuário/prestador desconhecido ou dados incompletos.");
                     showToast("Erro ao carregar perfil. Faça login novamente.", 'danger');
                     localStorage.removeItem('token');
                     localStorage.removeItem('usuario');
                     localStorage.removeItem('prestador');
                     setTimeout(() => { window.location.href = "login.html"; }, 3000);
                     return;
                }


                // Atualiza o nome e foto na interface com os dados validados do backend
                if (usuarioLogado?.nome && nomeSpan) {
                    nomeSpan.textContent = usuarioLogado.nome;
                }
                 if (profilePicImg && usuarioLogado?.foto_perfil_url) {
                     profilePicImg.src = usuarioLogado.foto_perfil_url;
                      profilePicImg.onerror = function() {
                         this.onerror = null;
                         this.src = usuarioTipo === 'usuario' ? "vendors/images/photo1.jpg" : "vendors/images/photo4.jpg";
                     };
                 } else if (profilePicImg) {
                      profilePicImg.src = usuarioTipo === 'usuario' ? "vendors/images/photo1.jpg" : "vendors/images/photo4.jpg";
                 }

                console.log(`[CHAT LIST] Perfil de ${usuarioTipo} carregado:`, usuarioLogado);

                // Agora que o perfil e o tipo de usuário estão definidos, carrega a lista de serviços para chat
                carregarListaServicosParaChat();
                iniciarPollingMensagensNaoLidas(); // Inicia polling para o contador na sidebar


            } catch (err) {
                console.error('[CHAT LIST] Erro ao carregar perfil:', err);
                showToast('Ocorreu um erro ao carregar informações do perfil.', 'danger');
            }
        }

        // Função de Logout
        document.getElementById('logout-link').addEventListener('click', (e) => {
             e.preventDefault();
             localStorage.removeItem('token');
             localStorage.removeItem('usuario');
             localStorage.removeItem('prestador');
             pararPollingMensagensNaoLidas(); // Para o polling de mensagens
             window.location.href = 'login.html';
        });

        // Função para carregar a lista de serviços com chat ativo
        async function carregarListaServicosParaChat() {
            const loading = document.getElementById("loading-services");
            const feedback = document.getElementById("feedback-services");
            const empty = document.getElementById("empty-services");
            const servicesListBody = document.getElementById("services-list-body");
            const token = localStorage.getItem("token");

            loading.style.display = "block";
            feedback.style.display = "none";
            empty.style.display = "none";
            servicesListBody.innerHTML = ""; // Limpa a lista atual

            if (!token || !usuarioLogado || !usuarioTipo) {
                feedback.textContent = "Autenticação necessária para carregar chats.";
                feedback.style.display = "block";
                loading.style.display = "none";
                console.warn("[CHAT LIST] carregarListaServicosParaChat: Token, usuário ou tipo faltando.");
                return;
            }

            // Destroi a instância anterior do DataTables antes de recarregar
             if ($.fn.DataTable.isDataTable('#services-table')) {
                 $('#services-table').DataTable().destroy();
             }


            try {
                let endpoint = '';
                // Usa endpoints diferentes dependendo do tipo de usuário
                if (usuarioTipo === 'usuario') {
                    // --- URL ATUALIZADA PARA O BACKEND NO RENDER ---
                    endpoint = "https://wyn-backend.onrender.com/meus-servicos"; // Endpoint que lista serviços do cliente
                } else if (usuarioTipo === 'prestador') {
                     // Prestadores podem ver chats de serviços aceitos ou em andamento
                     // O endpoint /meus-servicos-prestador lista serviços aceitos/aguardando pagamento
                     // Para incluir histórico, talvez precise de outro endpoint ou ajustar este
                     // --- URL ATUALIZADA PARA O BACKEND NO RENDER ---
                     endpoint = "https://wyn-backend.onrender.com/meus-servicos-prestador"; // Endpoint que lista serviços do prestador
                } else {
                     feedback.textContent = "Tipo de usuário desconhecido.";
                     feedback.style.display = "block";
                     loading.style.display = "none";
                     console.error("[CHAT LIST] Tipo de usuário inválido para carregar lista de chats:", usuarioTipo);
                     return;
                }


                console.log(`[CHAT LIST] Buscando lista de serviços para chat (${usuarioTipo})...`);
                const response = await fetch(endpoint, {
                     headers: { 'Authorization': `Bearer ${token}` }
                });

                console.log("[CHAT LIST] Resposta do backend recebida:", response.status);

                if (!response.ok) {
                     const errorText = await response.text();
                     console.error("[CHAT LIST] Erro HTTP ao buscar lista de serviços para chat:", response.status, errorText);
                     throw new Error(errorText || `Erro HTTP ao buscar lista de serviços para chat: ${response.status}`);
                }

                const servicos = await response.json();
                console.log("[CHAT LIST] Lista de serviços para chat carregada:", servicos);

                // Filtra serviços que estão em um status onde o chat é relevante
                // Ex: não incluímos 'aguardando_aceite_prestador' (chat começa após aceite) ou 'cancelado'
                const servicosComChatAtivo = servicos.filter(servico =>
                     servico.status !== 'aguardando_aceite_prestador' &&
                     servico.status !== 'recusado_pelo_prestador' &&
                     servico.status !== 'cancelado'
                     // Pode adicionar outros status conforme sua lógica de negócio
                );


                if (servicosComChatAtivo.length === 0) {
                    empty.style.display = "block";
                } else {
                    empty.style.display = "none";
                    servicosComChatAtivo.forEach(servico => {
                        const row = document.createElement('tr');
                        row.dataset.serviceId = servico._id; // Armazena o ID do serviço na linha
                         row.classList.add('service-row'); // Adiciona classe para identificar linhas clicáveis

                        // Determina o nome do "participante" (o outro lado da conversa)
                        let participanteNome = 'Desconhecido';
                         if (usuarioTipo === 'usuario' && servico.nome_prestador) {
                              participanteNome = servico.nome_prestador;
                         } else if (usuarioTipo === 'prestador' && servico.nome_cliente) {
                              participanteNome = servico.nome_cliente;
                         }


                         // Mapeamento de status (pode ser o mesmo usado nos dashboards)
                         const statusMap = {
                             'aguardando_pagamento_cliente': 'Aguardando Pagamento',
                             'aguardando_confirmacao_pagamento': 'Pagamento em Processamento',
                             'aceito_pelo_prestador': 'Em Andamento',
                             'concluido_pelo_prestador': 'Concluído',
                             'avaliado_pelo_cliente': 'Avaliado',
                             // Status não incluídos na lista, mas para referência:
                             // 'aguardando_aceite_prestador': 'Aguardando Aceite',
                             // 'recusado_pelo_prestador': 'Recusado',
                             // 'cancelado': 'Cancelado'
                         };

                         // Formata a data da última mensagem
                         const ultimaMensagemFormatada = servico.ultima_mensagem ? new Date(servico.ultima_mensagem.data_envio).toLocaleString('pt-BR') : 'Nenhuma mensagem';


                        row.innerHTML = `
                            <td class="table-plus">${servico.tipo_servico || 'Serviço sem Nome'}</td>
                            <td>${participanteNome}</td>
                            <td>${statusMap[servico.status] || servico.status}</td>
                            <td>${ultimaMensagemFormatada}</td>
                        `;
                        servicesListBody.appendChild(row);
                    });

                     // Inicializa o DataTables após popular a tabela
                     // Verifica se já existe uma instância e a destrói antes de criar uma nova
                     if ($.fn.DataTable.isDataTable('#services-table')) {
                         $('#services-table').DataTable().destroy();
                     }
                      $('#services-table').DataTable({
                         responsive: true,
                         paging: true, // Habilita paginação
                         searching: true, // Habilita busca
                         ordering: true, // Habilita ordenação
                         info: true, // Mostra informações de "Mostrando X de Y"
                         language: { // Configurações de idioma para português
                             url: 'https://cdn.datatables.net/plug-ins/1.11.5/i18n/pt-BR.json'
                         }
                      });


                     // Adiciona listener de clique nas linhas da tabela
                     document.querySelectorAll('#services-table tbody tr.service-row').forEach(row => {
                         row.addEventListener('click', function() {
                             const serviceId = this.dataset.serviceId;
                             if (serviceId) {
                                 console.log("[CHAT LIST] Clicou na linha do serviço:", serviceId);
                                 // Redireciona para a página de chat com o ID do serviço
                                 window.location.href = `chat.html?serviceId=${serviceId}`;
                             }
                         });
                     });
                }


            } catch (error) {
                console.error("[CHAT LIST] Erro ao carregar lista de serviços para chat:", error);
                feedback.textContent = `Erro ao carregar lista de chats: ${error.message || 'Verifique a conexão com o servidor.'}`;
                feedback.style.display = "block";
                empty.style.display = "none";
            } finally {
                loading.style.display = "none";
            }
        }

         // Função para carregar o contador de mensagens não lidas (para a sidebar)
         async function carregarContadorMensagensNaoLidas() {
              const token = localStorage.getItem("token");
              const unreadCountElementCliente = document.getElementById("unread-chat-count-sidebar-cliente");
              const unreadCountElementPrestador = document.getElementById("unread-chat-count-sidebar-prestador");

              if (!token) {
                  if (unreadCountElementCliente) unreadCountElementCliente.style.display = 'none';
                  if (unreadCountElementPrestador) unreadCountElementPrestador.style.display = 'none';
                  return;
              }

              try {
                  // --- URL ATUALIZADA PARA O BACKEND NO RENDER ---
                  const response = await fetch("https://wyn-backend.onrender.com/api/chat/unread-count", {
                      headers: { 'Authorization': `Bearer ${token}` }
                  });

                  if (!response.ok) {
                      console.error("[CHAT LIST] Erro ao buscar contagem de mensagens não lidas:", response.status);
                       if (unreadCountElementCliente) unreadCountElementCliente.style.display = 'none';
                       if (unreadCountElementPrestador) unreadCountElementPrestador.style.display = 'none';
                      return;
                  }

                  const data = await response.json();
                  const unreadCount = data.total || 0;

                  // Atualiza o contador na sidebar correta (cliente ou prestador)
                  if (usuarioTipo === 'usuario' && unreadCountElementCliente) {
                      if (unreadCount > 0) {
                          unreadCountElementCliente.textContent = unreadCount;
                          unreadCountElementCliente.style.display = 'inline';
                      } else {
                          unreadCountElementCliente.style.display = 'none';
                      }
                       if (unreadCountElementPrestador) unreadCountElementPrestador.style.display = 'none'; // Garante que o outro está oculto
                  } else if (usuarioTipo === 'prestador' && unreadCountElementPrestador) {
                       if (unreadCount > 0) {
                           unreadCountElementPrestador.textContent = unreadCount;
                           unreadCountElementPrestador.style.display = 'inline';
                       } else {
                           unreadCountElementPrestador.style.display = 'none';
                       }
                        if (unreadCountElementCliente) unreadCountElementCliente.style.display = 'none'; // Garante que o outro está oculto
                  }


              } catch (error) {
                  console.error("[CHAT LIST] Erro ao carregar contagem de mensagens não lidas:", error);
                   if (unreadCountElementCliente) unreadCountElementCliente.style.display = 'none';
                   if (unreadCountElementPrestador) unreadCountElementPrestador.style.display = 'none';
              }
         }

          // Função para iniciar o polling de mensagens não lidas (a cada 5 segundos)
          function iniciarPollingMensagensNaoLidas() {
              // Limpa qualquer intervalo existente para evitar duplicação
              if (unreadChatPollingInterval) {
                  clearInterval(unreadChatPollingInterval);
              }
              // Chama a função de atualização imediatamente e depois a cada X milissegundos
              carregarContadorMensagensNaoLidas();
              unreadChatPollingInterval = setInterval(carregarContadorMensagensNaoLidas, 5000); // A cada 5 segundos
              console.log("[CHAT LIST] Polling de mensagens não lidas iniciado.");
          }

          // Função para parar o polling de mensagens não lidas
          function pararPollingMensagensNaoLidas() {
              if (unreadChatPollingInterval) {
                  clearInterval(unreadChatPollingInterval);
                  unreadChatPollingInterval = null;
                  console.log("[CHAT LIST] Polling de mensagens não lidas parado.");
              }
          }


        // Chamar carregarPerfil ao carregar a página
        document.addEventListener("DOMContentLoaded", carregarPerfil);

         // Opcional: Parar polling ao fechar a janela/aba
         window.addEventListener('beforeunload', () => {
              pararPollingMensagensNaoLidas();
         });


    </script>

</body>
</html>
