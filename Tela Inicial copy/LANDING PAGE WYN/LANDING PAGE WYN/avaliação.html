<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>WYN - Minhas Avaliações</title> <link
			rel="apple-touch-icon"
			sizes="180x180"
			href="/w/1.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="32x32"
			href="/w/1.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="16x16"
			href="/w/1.png"
		/>

		<meta
			name="viewport"
			content="width=device-width, initial-scale=1, maximum-scale=1"
		/>

		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
			rel="stylesheet"
		/>
		<link rel="stylesheet" type="text/css" href="vendors/styles/core.css" />
		<link
			rel="stylesheet"
			type="text/css"
			href="vendors/styles/icon-font.min.css"
		/>
		<link
			rel="stylesheet"
			type="text/css"
			href="src/plugins/datatables/css/dataTables.bootstrap4.min.css"
		/>
		<link
			rel="stylesheet"
			type="text/css"
			href="src/plugins/datatables/css/responsive.bootstrap4.min.css"
		/>
		<link rel="stylesheet" type="text/css" href="vendors/styles/style.css" />

        <style>
            /* Estilo para a foto de perfil no header */
            .user-icon img.profile-pic-header {
                border-radius: 50% !important;
                object-fit: cover;
                width: 40px;
                height: 40px;
            }
            /* Estilo para as estrelas de avaliação */
            .rating .bi-star-fill {
                color: gold; /* Cor para estrelas preenchidas */
            }
             /* Estilo para mensagens de feedback (loading, erro, vazio) */
			.feedback-message {
				text-align: center;
				padding: 10px;
				margin: 15px 20px; /* Espaçamento alinhado com o conteúdo */
				border-radius: 4px;
				font-weight: 500;
			}

			.feedback-loading {
				color: #007bff; /* Cor azul */
				background-color: #e9f5ff; /* Fundo azul claro */
				border: 1px solid #b8daff;
			}

			.feedback-error {
				color: #dc3545; /* Cor vermelha */
				background-color: #f8d7da; /* Fundo vermelho claro */
				border: 1px solid #f5c6cb;
			}

			.feedback-empty {
				color: #6c757d; /* Cor cinza */
				background-color: #f8f9fa; /* Fundo branco/claro */
				border: 1px solid #dee2e6;
			}

             /* Estilo para o indicador de notificações no sino */
            .notification-badge {
                position: absolute;
                top: 5px; /* Ajuste a posição vertical */
                right: 5px; /* Ajuste a posição horizontal */
                padding: 3px 6px;
                border-radius: 50%;
                background-color: red;
                color: white;
                font-size: 10px;
                font-weight: bold;
                display: none; /* Inicialmente oculto */
            }

             /* Estilo para o dropdown de notificações */
             .notification-dropdown {
                 width: 300px; /* Largura fixa para o dropdown */
                 max-height: 400px; /* Altura máxima */
                 overflow-y: auto; /* Scroll se necessário */
             }

             .notification-item {
                 padding: 10px;
                 border-bottom: 1px solid #eee;
             }

             .notification-item:last-child {
                 border-bottom: none;
             }

             .notification-item a {
                 text-decoration: none;
                 color: #333; /* Cor do texto */
                 display: block; /* Ocupa toda a área do item */
             }

             .notification-item a:hover {
                 background-color: #f8f9fa; /* Fundo suave no hover */
             }

             .notification-item .timestamp {
                 font-size: 11px;
                 color: #999;
                 display: block;
                 margin-top: 3px;
             }

             .notification-item.unread {
                 background-color: #e9f5ff; /* Fundo azul claro para não lidas */
                 font-weight: bold;
             }
             /* Estilo para o container de toasts */
             #toastContainer {
                 position: fixed;
                 top: 20px;
                 right: 20px;
                 z-index: 1050; /* Acima de modais */
             }

             /* Estilo individual do toast */
             .toast {
                 width: 300px;
                 max-width: 100%;
                 font-size: .875rem;
                 background-color: rgba(255,255,255,.85);
                 background-clip: padding-box;
                 border: 1px solid rgba(0,0,0,.1);
                 box-shadow: 0 .25rem .75rem rgba(0,0,0,.1);
                 opacity: 0;
                 border-radius: .25rem;
             }

             .toast.showing {
                 opacity: 1;
             }

             .toast.show {
                 display: block;
                 opacity: 1;
             }

             .toast.hide {
                 display: none;
             }

             .toast-header {
                 display: flex;
                 align-items: center;
                 padding: .25rem .75rem;
                 color: #6c757d;
                 background-color: rgba(255,255,255,.85);
                 background-clip: padding-box;
                 border-bottom: 1px solid rgba(0,0,0,.05);
                 border-top-left-radius: calc(.25rem - 1px);
                 border-top-right-radius: calc(.25rem - 1px);
             }

             .toast-body {
                 padding: .75rem;
             }

             /* Cores para os headers dos toasts */
             .toast-header.bg-success { background-color: #28a745 !important; color: white !important; }
             .toast-header.bg-danger { background-color: #dc3545 !important; color: white !important; }
             .toast-header.bg-info { background-color: #17a2b8 !important; color: white !important; }

        </style>

		<script
			async
			src="https://www.googletagmanager.com/gtag/js?id=G-GBZ3SGGX85"
		></script>
		<script
			async
			src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2973766580778258"
			crossorigin="anonymous"
		></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("js", new Date());

			gtag("config", "G-GBZ3SGGX85");
		</script>
		<script>
			(function (w, d, s, l, i) {
				w[l] = w[l] || [];
				w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
				var f = d.getElementsByTagName(s)[0],
					j = d.createElement(s),
					dl = l != "dataLayer" ? "&l=" + l : "";
				j.async = true;
				j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
				f.parentNode.insertBefore(j, f);
			})(window, document, "script", "dataLayer", "GTM-NXZMQSS");
		</script>
	</head>
	<body>
		<div class="pre-loader">
			<div class="pre-loader-box">
				<div class="loader-logo">
					<img src="w.png" alt="" />
				</div>
				<div class="loader-progress" id="progress_div">
					<div class="bar" id="bar1"></div>
				</div>
				<div class="percent" id="percent1">0%</div>
				<div class="loading-text">Carregando...</div>
			</div>
		</div>

		<div class="header">
			<div class="header-left">
				<div class="menu-icon bi bi-list"></div>
				<div
					class="search-toggle-icon bi bi-search"
					data-toggle="header_search"
				></div>
				<div class="header-search">
					<form>
						<div class="form-group mb-0">
							<i class="dw dw-search2 search-icon"></i>
							<input
								type="text"
								class="form-control search-input"
								placeholder="Search Here"
							/>
							<div class="dropdown">
								<a
									class="dropdown-toggle no-arrow"
									href="#"
									role="button"
									data-toggle="dropdown"
								>
									<i class="ion-arrow-down-c"></i>
								</a>
								<div class="dropdown-menu dropdown-menu-right">
									<div class="form-group row">
										<label class="col-sm-12 col-md-2 col-form-label"
											>De</label
										>
										<div class="col-sm-12 col-md-10">
											<input
												class="form-control form-control-sm form-control-line"
												type="text"
											/>
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-12 col-md-2 col-form-label">Para</label>
										<div class="col-sm-12 col-md-10">
											<input
												class="form-control form-control-sm form-control-line"
												type="text"
											/>
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-12 col-md-2 col-form-label"
											>Sujeito</label
										>
										<div class="col-sm-12 col-md-10">
											<input
												class="form-control form-control-sm form-control-line"
												type="text"
											/>
										</div>
									</div>
									<div class="text-right">
										<button class="btn btn-primary">Pesquisar</button>
									</div>
								</div>
							</div>
						</div>
					</form>
				</div>
			</div>
			<div class="header-right">
                <div class="user-notification">
                    <div class="dropdown">
                        <a
                            class="dropdown-toggle no-arrow"
                            href="#"
                            role="button"
                            data-toggle="dropdown"
                             id="notification-dropdown-toggle"
                        >
                            <i class="icon-copy dw dw-notification"></i>
                            <span class="badge notification-badge" id="notification-count">0</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right dropdown-menu-lg notification-dropdown customscroll">
                            <h4 class="mb-0">Notificações</h4>
                            <div id="notification-list">
                                <a class="dropdown-item notification-item" href="#">
                                    <i class="icon-copy dw dw-info"></i>
                                    <p>Nenhuma notificação nova.</p>
                                    <span class="timestamp">Agora</span>
                                </a>
                            </div>
                             <div class="text-center">
                                 <a href="#" class="btn btn-sm btn-link">Ver todas as notificações</a>
                             </div>
                        </div>
                    </div>
                </div>
				<div class="dashboard-setting user-notification">
					<div class="dropdown">
						<a
							class="dropdown-toggle no-arrow"
							href="javascript:;"
							data-toggle="right-sidebar"
						>
							<i class="dw dw-settings2"></i>
						</a>
					</div>
				</div>
				<div class="user-info-dropdown">
					<div class="dropdown">
						<a
							class="dropdown-toggle"
							href="#"
							role="button"
							data-toggle="dropdown"
						>
							<span class="user-icon">
								<img src="vendors/images/photo1.jpg" id="user-profile-pic-header" class="profile-pic-header" alt="" />
							</span>
							<span class="user-name">Cliente</span>
						</a>
						<div
							class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list"
						>
							<a class="dropdown-item" href="profile.html"
								><i class="dw dw-user1"></i> Perfil</a
							>
							<a class="dropdown-item" href="profile.html"
								><i class="dw dw-settings2"></i>Configurações</a
							>
							<a class="dropdown-item" href="faq.html"
								><i class="dw dw-help"></i> Ajuda</a
							>
							<a class="dropdown-item" href="#" id="logout-link"
								><i class="dw dw-logout"></i> Sair</a
							>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="right-sidebar">
			<div class="sidebar-title">
				<h3 class="weight-600 font-16 text-blue">
					Configuração de Layout
					<span class="btn-block font-weight-400 font-12"
						>Personalização</span
					>
				</h3>
				<div class="close-sidebar" data-toggle="right-sidebar-close">
					<i class="icon-copy ion-close-round"></i>
				</div>
			</div>
			<div class="right-sidebar-body customscroll">
				<div class="right-sidebar-body-content">
					<h4 class="weight-600 font-18 pb-10">Fundo</h4>
					<div class="sidebar-btn-group pb-30 mb-10">
						<a
							href="javascript:void(0);"
							class="btn btn-outline-primary header-white active"
							>Claro</a
						>
						<a
							href="javascript:void(0);"
							class="btn btn-outline-primary header-dark"
							>Escuro</a
						>
					</div>

					<h4 class="weight-600 font-18 pb-10">Menu Lateral</h4>
					<div class="sidebar-btn-group pb-30 mb-10">
						<a
							href="javascript:void(0);"
							class="btn btn-outline-primary sidebar-light"
							>Claro</a
						>
						<a
							href="javascript:void(0);"
							class="btn btn-outline-primary sidebar-dark active"
							>Escuro</a
						>
					</div>

					<h4 class="weight-600 font-18 pb-10">Icone Dropdown</h4>
					<div class="sidebar-radio-group pb-10 mb-10">
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebaricon-1"
								name="menu-dropdown-icon"
								class="custom-control-input"
								value="icon-style-1"
								checked=""
							/>
							<label class="custom-control-label" for="sidebaricon-1"
								><i class="fa fa-angle-down"></i
							></label>
						</div>
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebaricon-2"
								name="menu-dropdown-icon"
								class="custom-control-input"
								value="icon-style-2"
							/>
							<label class="custom-control-label" for="sidebaricon-2"
								><i class="ion-plus-round"></i
							></label>
						</div>
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebariconlist-3"
								name="menu-list-icon"
								class="custom-control-input"
								value="icon-list-style-3"
							/>
							<label class="custom-control-label" for="sidebariconlist-3"
								><i class="fa fa-angle-double-right"></i
							></label>
						</div>
					</div>

					<h4 class="weight-600 font-18 pb-10">Icones do Menu</h4>
					<div class="sidebar-radio-group pb-30 mb-10">
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebariconlist-1"
								name="menu-list-icon"
								class="custom-control-input"
								value="icon-list-style-1"
								checked=""
							/>
							<label class="custom-control-label" for="sidebariconlist-1"
								><i class="ion-minus-round"></i
							></label>
						</div>
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebariconlist-2"
								name="menu-list-icon"
								class="custom-control-input"
								value="icon-list-style-2"
							/>
							<label class="custom-control-label" for="sidebariconlist-2"
								><i class="fa fa-circle-o" aria-hidden="true"></i
							></label>
						</div>
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebariconlist-3"
								name="menu-list-icon"
								class="custom-control-input"
								value="icon-list-style-3"
							/>
							<label class="custom-control-label" for="sidebariconlist-3"
								><i class="dw dw-check"></i
							></label>
						</div>
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebariconlist-4"
								name="menu-list-icon"
								class="custom-control-input"
								value="icon-list-style-4"
								checked=""
							/>
							<label class="custom-control-label" for="sidebariconlist-4"
								><i class="icon-copy dw dw-next-2"></i
							></label>
						</div>
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebariconlist-5"
								name="menu-list-icon"
								class="custom-control-input"
								value="icon-list-style-5"
							/>
							<label class="custom-control-label" for="sidebariconlist-5"
								><i class="dw dw-fast-forward-1"></i
							></label>
						</div>
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebariconlist-6"
								name="menu-list-icon"
								class="custom-control-input"
								value="icon-list-style-6"
							/>
							<label class="custom-control-label" for="sidebariconlist-6"
								><i class="dw dw-next"></i
							></label>
						</div>
					</div>

					<div class="reset-options pt-30 text-center">
						<button class="btn btn-danger" id="reset-settings">
							Resetar Configurações
						</button>
					</div>
				</div>
			</div>
		</div>

		<div class="left-side-bar">
			<div class="brand-logo">
				<a href="indexx.html">
					<img src="w (1).png" alt="" class="dark-logo" />
					<img
						src="w (1).png"
						alt=""
						class="light-logo"
					/>
				</a>
				<div class="close-sidebar" data-toggle="left-sidebar-close">
					<i class="ion-close-round"></i>
				</div>
			</div>
			<div class="menu-block customscroll">
				<div class="sidebar-menu">
					<ul id="accordion-menu">
						<li>
							<a href="indexx.html" class="dropdown-toggle no-arrow">
								<span class="micon bi bi-house"></span
								><span class="mtext">Dashboard</span>
							</a>
						</li>
						<li class="dropdown">
							<a href="javascript:;" class="dropdown-toggle">
								<span class="micon bi bi-textarea-resize"></span
								><span class="mtext">Funcionalidades</span>
							</a>
							<ul class="submenu">
								<li><a href="/em breve/index.html">Histórico</a></li>
                                <li><a href="catalogo.html">Fazer Pedido</a></li>
                                <li><a href="contratos.html">Meus Pedidos</a></li>
                            </ul>
						</li>
						<li>
							<a href="/Tela Cliente/serviços/dist/index.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi-chat-right-dots"></span>
								<span class="mtext">Serviços</span>
                            </a>
						</li>
                         <li>
                             <a href="chat-list.html" class="dropdown-toggle no-arrow">
                                 <span class="micon bi bi-chat-dots"></span>
                                 <span class="mtext">Chat de Serviços</span>
                                  <span id="unread-chat-count-sidebar" class="badge badge-pill badge-danger" style="display: none; margin-left: 5px;">0</span>
                              </a>
                         </li>
						<li>
							<a href="javascript:;" class="dropdown-toggle">
								<span class="micon bi bi-file-pdf"></span
								><span class="mtext">Documentação</span>
							</a>
							<ul class="submenu">
								<li><a href="/Tela Inicial copy/Termos e Condições.docx">Termos e Condições</a></li>
							</ul>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<div class="mobile-menu-overlay"></div>

		<div class="main-container">
			<div class="xs-pd-20-10 pd-ltr-20">
				<div class="page-header">
					<div class="row">
						<div class="col-md-12 col-sm-12">
							<div class="title">
								<h4>Avaliações Pendentes</h4>
							</div>
							<nav aria-label="breadcrumb" role="navigation">
								<ol class="breadcrumb">
									<li class="breadcrumb-item">
										<a href="indexx.html">Dashboard</a>
									</li>
									<li class="breadcrumb-item active" aria-current="page">
										Avaliações Pendentes
									</li>
								</ol>
							</nav>
						</div>
					</div>
				</div>

				<div class="card-box pb-10">
					<div class="h5 pd-20 mb-0">Serviços Aguardando Sua Avaliação</div>
                    <div id="loading" class="feedback-message feedback-loading" style="display: none;">Carregando serviços para avaliar...</div>
                    <div id="feedback" class="feedback-message feedback-error" style="display: none;"></div>
                    <div id="empty" class="feedback-message feedback-empty" style="display: none;">Nenhum serviço aguardando sua avaliação.</div>

					<table class="data-table table nowrap">
						<thead>
							<tr>
								<th class="table-plus">Prestador</th>
								<th>Tipo de Serviço</th>
                                <th>Data Conclusão</th>
								<th>Notas do Prestador</th>
								<th class="datatable-nosort">Ações</th>
							</tr>
						</thead>
						<tbody id="services-to-evaluate-table">
							</tbody>
					</table>
				</div>

                 <div class="modal fade" id="evaluationModal" tabindex="-1" role="dialog" aria-labelledby="evaluationModalLabel" aria-hidden="true">
                     <div class="modal-dialog" role="document">
                         <div class="modal-content">
                             <div class="modal-header">
                                 <h5 class="modal-title" id="evaluationModalLabel">Avaliar Serviço</h5>
                                 <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                     <span aria-hidden="true">&times;</span>
                                 </button>
                             </div>
                             <form id="evaluationForm">
                                 <div class="modal-body">
                                     <input type="hidden" id="service-id-evaluate" name="serviceId">
                                     <p id="service-info-evaluate"></p> <div class="form-group">
                                         <label for="rating">Avaliação (1-5 estrelas):</label>
                                         <div>
                                             <span class="rating">
                                                 <i class="bi bi-star-fill" data-rating="1"></i>
                                                 <i class="bi bi-star-fill" data-rating="2"></i>
                                                 <i class="bi bi-star-fill" data-rating="3"></i>
                                                 <i class="bi bi-star-fill" data-rating="4"></i>
                                                 <i class="bi bi-star-fill" data-rating="5"></i>
                                             </span>
                                             <input type="hidden" id="rating" name="rating" required>
                                         </div>
                                     </div>

                                     <div class="form-group">
                                         <label for="comment">Comentário (Opcional):</label>
                                         <textarea class="form-control" id="comment" name="comment" rows="3"></textarea>
                                     </div>

                                      <div id="comprovantes-section" style="display: none; margin-top: 20px;">
                                         <h6>Comprovantes Enviados pelo Prestador:</h6>
                                         <div id="comprovantes-list">
                                             </div>
                                     </div>


                                 </div>
                                 <div class="modal-footer">
                                     <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                                     <button type="submit" class="btn btn-primary">Enviar Avaliação</button>
                                 </div>
                             </form>
                         </div>
                     </div>
                 </div>


				<div class="footer-wrap pd-20 mb-20 card-box">
					Plataforma WYN-TECH
				</div>
			</div>
		</div>

         <div id="toastContainer">
         </div>

		<script src="vendors/scripts/core.js"></script>
		<script src="vendors/scripts/script.min.js"></script>
		<script src="vendors/scripts/process.js"></script>
		<script src="vendors/scripts/layout-settings.js"></script>
		<script src="src/plugins/datatables/js/jquery.dataTables.min.js"></script>
		<script src="src/plugins/datatables/js/dataTables.bootstrap4.min.js"></script>
		<script src="src/plugins/datatables/js/responsive.bootstrap4.min.js"></script>
         <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script> <noscript
			><iframe
				src="https://www.googletagmanager.com/ns.html?id=GTM-NXZMQSS"
				height="0"
				width="0"
				style="display: none; visibility: hidden"
			></iframe
		></noscript>

		<script>
			let usuarioLogado = null; // Variável para armazenar os dados do usuário logado

            // Função para exibir toast notifications
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) {
                    console.error("Toast container não encontrado!");
                    return;
                }

                const toastElement = document.createElement('div');
                toastElement.classList.add('toast');
                toastElement.setAttribute('role', 'alert');
                toastElement.setAttribute('aria-live', 'assertive');
                toastElement.setAttribute('aria-atomic', 'true');
                toastElement.setAttribute('data-delay', '5000');

                toastElement.innerHTML = `
                    <div class="toast-header ${type === 'success' ? 'bg-success text-white' : type === 'danger' ? 'bg-danger text-white' : 'bg-info text-white'}">
                        <strong class="mr-auto">${type === 'success' ? 'Sucesso' : type === 'danger' ? 'Erro' : 'Informação'}</strong>
                        <small>Agora</small>
                        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                `;

                toastContainer.appendChild(toastElement);
                $(toastElement).toast('show');
                $(toastElement).on('hidden.bs.toast', function () {
                    $(this).remove();
                });
            }


			async function carregarPerfilUsuario() {
			  const token = localStorage.getItem('token');
			  const usuarioCache = localStorage.getItem('usuario'); // Pega os dados do usuário do cache

              const userNameHeaderSpan = document.querySelector(".user-name");
              const userProfilePicHeaderImg = document.getElementById("user-profile-pic-header");


			  if (!token || !usuarioCache) {
				console.warn("Usuário não autenticado. Redirecionando para login.");
				window.location.href = "login.html";
				return;
			  }

               // Tenta usar os dados do cache primeiro para exibição rápida
               try {
                   usuarioLogado = JSON.parse(usuarioCache);
                   if (userNameHeaderSpan && usuarioLogado?.nome) {
                       userNameHeaderSpan.textContent = usuarioLogado.nome;
                   }
                   if (userProfilePicHeaderImg && usuarioLogado?.foto_perfil_url) {
                       userProfilePicHeaderImg.src = usuarioLogado.foto_perfil_url;
                       userProfilePicHeaderImg.onerror = function() { this.onerror = null; this.src = "vendors/images/photo1.jpg"; }; // Imagem padrão cliente
                   } else if (userProfilePicHeaderImg) {
                        userProfilePicHeaderImg.src = "vendors/images/photo1.jpg"; // Imagem padrão cliente
                   }
               } catch (e) {
                   console.error("Erro ao parsear cache do usuário:", e);
                   // Limpa o cache se estiver corrompido
                   localStorage.removeItem('usuario');
                   // Não redireciona aqui, a chamada ao backend validará o token
               }


			  try {
				// Chamada ao backend para validar o token e obter dados completos do usuário
                // Usando a rota /perfil que agora verifica o tipo no token
				const res = await fetch('https://wyn-backend.onrender.com/perfil', {
				  headers: { 'Authorization': 'Bearer ' + token }
				});

				const resClone = res.clone(); // Clonar para ler o body se der erro de JSON

				if (!res.ok) {
					if (res.status === 401 || res.status === 403) {
						console.error("Token inválido ou expirado. Redirecionando para login.");
                        showToast("Sua sessão expirou. Por favor, faça login novamente.", 'danger');
                        // Limpa o token e o cache do usuário
                        localStorage.removeItem('token');
                        localStorage.removeItem('usuario');
						setTimeout(() => { window.location.href = "login.html"; }, 3000); // Redireciona após 3 segundos
						return;
					}
					throw new Error(`Erro HTTP ao buscar perfil: ${res.status}`);
				}

				let data = {};
				try {
					data = await res.json();
				} catch(jsonError) {
					console.error("Erro ao parsear JSON do perfil:", await resClone.text());
					throw new Error("Resposta de perfil inválida.");
				}

                // Verifique se o perfil retornado é de um usuário (cliente)
                if (data.tipo !== 'usuario' || !data.usuario?._id) {
                     console.error("Token válido, mas não corresponde a um usuário (cliente).");
                     showToast("Acesso negado para este tipo de usuário.", 'danger');
                     // Limpa o token e o cache do usuário, redireciona para login do prestador se for o caso, ou login geral
                     localStorage.removeItem('token');
                     localStorage.removeItem('usuario');
                      // Pode adicionar lógica para verificar se é prestador e redirecionar para login-prestador.html
                      // Por enquanto, redireciona para login geral
                      setTimeout(() => { window.location.href = "login.html"; }, 3000);
                     return;
                }


				// Atualiza a variável global com os dados completos do backend
				usuarioLogado = data.usuario;
                // Atualiza o cache do usuário com os dados completos
                localStorage.setItem('usuario', JSON.stringify(usuarioLogado));


				// Atualiza nome e foto na interface (se a chamada backend for bem sucedida)
				if (usuarioLogado?.nome && userNameHeaderSpan) {
					userNameHeaderSpan.textContent = usuarioLogado.nome;
				}
                 if (userProfilePicHeaderImg && usuarioLogado?.foto_perfil_url) {
                     userProfilePicHeaderImg.src = usuarioLogado.foto_perfil_url;
                      userProfilePicHeaderImg.onerror = function() { this.onerror = null; this.src = "vendors/images/photo1.jpg"; }; // Imagem padrão cliente
                 } else if (userProfilePicHeaderImg) {
                      userProfilePicHeaderImg.src = "vendors/images/photo1.jpg"; // Imagem padrão cliente
                 }


				console.log("Perfil do usuário carregado:", usuarioLogado);

                // Chamar a função para carregar os serviços para avaliar após carregar o perfil
                carregarServicosParaAvaliar();
                carregarContadorMensagensNaoLidas(); // Carrega contador de mensagens
                iniciarPollingMensagensNaoLidas(); // Inicia polling para mensagens


			  } catch (err) {
				console.error('Erro ao carregar perfil:', err);
				 // Se já tentou parsear do cache e deu erro, alertar. Senão, talvez o erro já tenha sido alertado no redirect.
                 if (usuarioLogado) { // Se usuarioLogado foi populado do cache mas a chamada falhou
                     showToast('Erro ao validar sessão do usuário. Pode haver problemas na conexão.', 'danger');
                 } else { // Se nem o cache existia ou deu erro no parse
                     showToast('Ocorreu um erro ao carregar informações do usuário.', 'danger');
                 }
                 // Não redireciona aqui se o redirect já aconteceu acima
			  }
			}

             // Função para carregar o contador de mensagens não lidas (para a sidebar e sino)
             async function carregarContadorMensagensNaoLidas() {
                  const token = localStorage.getItem("token");
                  const unreadCountElementSidebar = document.getElementById("unread-chat-count-sidebar");
                  const notificationCountElement = document.getElementById("notification-count"); // Contador no sino

                  if (!token) {
                      if (unreadCountElementSidebar) unreadCountElementSidebar.style.display = 'none';
                      if (notificationCountElement) notificationCountElement.style.display = 'none';
                      return;
                  }

                  try {
                      // Endpoint para contar mensagens não lidas para o usuário logado
                      const response = await fetch("https://wyn-backend.onrender.com/api/chat/unread-count", {
                          headers: { 'Authorization': `Bearer ${token}` }
                      });

                      if (!response.ok) {
                          console.error("Erro ao buscar contagem de mensagens não lidas:", response.status);
                          if (unreadCountElementSidebar) unreadCountElementSidebar.style.display = 'none';
                          if (notificationCountElement) notificationCountElement.style.display = 'none';
                          return;
                      }

                      const data = await response.json();
                      const unreadCount = data.total || 0;

                      if (unreadCountElementSidebar) {
                          if (unreadCount > 0) {
                              unreadCountElementSidebar.textContent = unreadCount;
                              unreadCountElementSidebar.style.display = 'inline';
                          } else {
                              unreadCountElementSidebar.style.display = 'none';
                          }
                      }

                       if (notificationCountElement) {
                           if (unreadCount > 0) {
                                notificationCountElement.textContent = unreadCount;
                                notificationCountElement.style.display = 'inline';
                           } else {
                                notificationCountElement.style.display = 'none';
                           }
                       }


                  } catch (error) {
                      console.error("Erro ao carregar contagem de mensagens não lidas:", error);
                       if (unreadCountElementSidebar) unreadCountElementSidebar.style.display = 'none';
                       if (notificationCountElement) notificationCountElement.style.display = 'none';
                  }
             }

              // Função para iniciar o polling de mensagens não lidas (a cada 30 segundos)
              let unreadChatPollingInterval = null;
              function iniciarPollingMensagensNaoLidas() {
                  if (unreadChatPollingInterval) {
                      clearInterval(unreadChatPollingInterval);
                  }
                  unreadChatPollingInterval = setInterval(() => {
                      console.log("Verificando mensagens não lidas...");
                      carregarContadorMensagensNaoLidas();
                  }, 30000); // A cada 30 segundos
                  console.log("Polling de mensagens não lidas iniciado.");
              }

              // Função para parar o polling de mensagens não lidas
              function pararPollingMensagensNaoLidas() {
                  if (unreadChatPollingInterval) {
                      clearInterval(unreadChatPollingInterval);
                      unreadChatPollingInterval = null;
                      console.log("Polling de mensagens não lidas parado.");
                  }
              }


            // Função para carregar os serviços que o usuário precisa avaliar
            async function carregarServicosParaAvaliar() {
                const loading = document.getElementById("loading");
                const tableBody = document.getElementById("services-to-evaluate-table");
                const feedback = document.getElementById("feedback");
                const empty = document.getElementById("empty");
                const token = localStorage.getItem('token');

                loading.style.display = "block";
                feedback.style.display = "none";
                empty.style.display = "none";
                tableBody.innerHTML = ""; // Limpa a tabela antes de carregar

                if (!token) {
                     feedback.textContent = "Autenticação necessária para carregar serviços.";
                     feedback.style.display = "block";
                     loading.style.display = "none";
                     return;
                }

                try {
                    // Endpoint para buscar serviços com status 'concluido_pelo_prestador' para o usuário logado
                    const response = await fetch('https://wyn-backend.onrender.com/meus-servicos-para-avaliar', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                         const errorText = await response.text();
                         console.error("Erro HTTP ao buscar serviços para avaliar:", response.status, errorText);
                         feedback.textContent = `Erro ao carregar serviços: ${errorText || response.status}`;
                         feedback.style.display = "block";
                         loading.style.display = "none";
                         return;
                    }

                    const servicos = await response.json();
                    console.log("Serviços para avaliar carregados:", servicos);

                    if (servicos.length === 0) {
                        empty.style.display = "block";
                    } else {
                        servicos.forEach(servico => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="table-plus">
                                    <div class="name-avatar d-flex align-items-center">
                                        <div class="avatar mr-2 flex-shrink-0">
                                            <img src="vendors/images/photo4.jpg" class="border-radius-100 shadow" width="40" height="40" alt="" />
                                        </div>
                                        <div class="txt">
                                            <div class="weight-600">${servico.nome_prestador || 'Prestador Não Informado'}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>${servico.tipo_servico || 'Não Informado'}</td>
                                <td>${servico.data_conclusao ? new Date(servico.data_conclusao).toLocaleDateString() : 'N/A'}</td>
                                <td>${servico.notas_prestador || 'Nenhuma nota.'}</td>
                                <td>
                                    <div class="table-actions">
                                        <a href="#" data-id="${servico._id}" class="evaluate-service btn btn-sm btn-primary mr-1">Avaliar</a>
                                         <a href="#" data-id="${servico._id}" class="view-comprovantes btn btn-sm btn-info">Ver Comprovantes</a>
                                    </div>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });

                         // Adicionar listeners para os botões de ação (Avaliar, Ver Comprovantes)
                         addServiceActionListeners();
                    }

                } catch (error) {
                    console.error('Erro ao carregar serviços para avaliar:', error);
                    feedback.textContent = `Erro ao carregar serviços: ${error.message || 'Verifique a conexão.'}`;
                    feedback.style.display = "block";
                } finally {
                    loading.style.display = "none";
                }
            }

             // Função para adicionar listeners aos botões de ação dos serviços
             function addServiceActionListeners() {
                  const evaluateButtons = document.querySelectorAll('#services-to-evaluate-table .evaluate-service');
                  const comprovanteButtons = document.querySelectorAll('#services-to-evaluate-table .view-comprovantes');


                  evaluateButtons.forEach(button => {
                       button.addEventListener('click', (event) => {
                            event.preventDefault(); // Previne o link padrão
                            const serviceId = event.target.dataset.id;
                            if (serviceId) {
                                 // Abre o modal de avaliação e preenche com o ID do serviço
                                 document.getElementById('service-id-evaluate').value = serviceId;
                                 // Opcional: Buscar detalhes do serviço para mostrar no modal
                                 // carregarDetalhesServicoAvaliacao(serviceId);
                                 document.getElementById('service-info-evaluate').textContent = `Avaliando Serviço ID: ${serviceId}`; // Placeholder
                                 // Limpa o formulário de avaliação anterior
                                 document.getElementById('evaluationForm').reset();
                                 document.getElementById('rating').value = ''; // Garante que o rating oculto esteja vazio
                                 // Remove a seleção visual das estrelas
                                 document.querySelectorAll('#evaluationModal .rating .bi-star-fill').forEach(star => star.classList.remove('selected'));
                                 // Oculta a seção de comprovantes ao abrir o modal para avaliar
                                 document.getElementById('comprovantes-section').style.display = 'none';
                                 document.getElementById('comprovantes-list').innerHTML = ''; // Limpa a lista de comprovantes


                                 $('#evaluationModal').modal('show'); // Abre o modal
                            }
                       });
                  });

                  comprovanteButtons.forEach(button => {
                       button.addEventListener('click', async (event) => {
                            event.preventDefault();
                            const serviceId = event.target.dataset.id;
                            if (serviceId) {
                                 // Abre o modal de avaliação, mas foca em mostrar comprovantes
                                 document.getElementById('service-id-evaluate').value = serviceId;
                                  document.getElementById('service-info-evaluate').textContent = `Comprovantes do Serviço ID: ${serviceId}`; // Placeholder
                                 // Oculta a seção de avaliação
                                 document.querySelector('#evaluationModal .form-group label[for="rating"]').parentElement.style.display = 'none';
                                 document.querySelector('#evaluationModal .form-group label[for="comment"]').parentElement.style.display = 'none';
                                 document.querySelector('#evaluationModal .modal-footer button[type="submit"]').style.display = 'none'; // Oculta o botão de enviar avaliação

                                 // Mostra a seção de comprovantes
                                 document.getElementById('comprovantes-section').style.display = 'block';
                                 document.getElementById('comprovantes-list').innerHTML = ''; // Limpa a lista anterior

                                 // Carrega e exibe os comprovantes
                                 await carregarComprovantesServico(serviceId);

                                 $('#evaluationModal').modal('show'); // Abre o modal
                            }
                       });
                  });


             }

             // Listener para as estrelas de avaliação no modal
             document.querySelectorAll('#evaluationModal .rating .bi-star-fill').forEach(star => {
                  star.addEventListener('click', (event) => {
                       const clickedRating = parseInt(event.target.dataset.rating);
                       const ratingInput = document.getElementById('rating');
                       ratingInput.value = clickedRating; // Define o valor no input hidden

                       // Atualiza a seleção visual das estrelas
                       document.querySelectorAll('#evaluationModal .rating .bi-star-fill').forEach(s => {
                           if (parseInt(s.dataset.rating) <= clickedRating) {
                               s.classList.add('selected'); // Adiciona classe para estrelas selecionadas
                           } else {
                               s.classList.remove('selected'); // Remove classe para estrelas não selecionadas
                           }
                       });
                  });
             });


             // Listener para o envio do formulário de avaliação
             document.getElementById('evaluationForm').addEventListener('submit', async (event) => {
                  event.preventDefault();

                  const form = event.target;
                  const serviceId = document.getElementById('service-id-evaluate').value;
                  const rating = document.getElementById('rating').value;
                  const comment = document.getElementById('comment').value;
                  const token = localStorage.getItem('token');

                  if (!serviceId || !rating || !token) {
                      showToast("Erro: Dados insuficientes para enviar avaliação (ID do serviço, avaliação ou token faltando).", 'danger');
                      return;
                  }

                  const submitButton = form.querySelector('button[type="submit"]');
                  submitButton.disabled = true;
                  submitButton.textContent = "Enviando...";


                  const evaluationData = {
                      rating: parseInt(rating), // Garante que é um número
                      comment: comment.trim() // Remove espaços em branco extras
                  };

                  try {
                      // Endpoint para enviar a avaliação do serviço
                      const response = await fetch(`https://wyn-backend.onrender.com/avaliar-servico/${serviceId}`, {
                          method: 'POST',
                          headers: {
                              'Content-Type': 'application/json',
                              'Authorization': `Bearer ${token}`
                          },
                          body: JSON.stringify(evaluationData)
                      });

                      const result = await response.json();

                      if (!response.ok) {
                           showToast(result.message || "Erro ao enviar avaliação.", 'danger');
                           console.error("Erro ao enviar avaliação:", result);
                      } else {
                          showToast("Avaliação enviada com sucesso!", 'success');
                          $('#evaluationModal').modal('hide'); // Fecha o modal
                          carregarServicosParaAvaliar(); // Recarrega a lista para remover o serviço avaliado
                      }

                  } catch (error) {
                      console.error("Erro ao enviar avaliação:", error);
                      showToast(error.message || "Erro ao enviar avaliação.", 'danger');
                  } finally {
                      submitButton.disabled = false;
                      submitButton.textContent = "Enviar Avaliação";
                  }
             });


             // Função para carregar e exibir comprovantes
             async function carregarComprovantesServico(serviceId) {
                 const comprovantesListDiv = document.getElementById('comprovantes-list');
                 comprovantesListDiv.innerHTML = '<p>Carregando comprovantes...</p>'; // Mensagem de carregamento
                 const token = localStorage.getItem('token');

                 if (!serviceId || !token) {
                      comprovantesListDiv.innerHTML = '<p style="color: red;">Erro: ID do serviço ou token faltando.</p>';
                      return;
                 }

                 try {
                     // Endpoint para buscar detalhes do serviço (que inclui os comprovantes)
                     const response = await fetch(`https://wyn-backend.onrender.com/servico/${serviceId}`, {
                         headers: { 'Authorization': `Bearer ${token}` }
                     });

                     if (!response.ok) {
                          const errorText = await response.text();
                          console.error("Erro HTTP ao buscar comprovantes:", response.status, errorText);
                          comprovantesListDiv.innerHTML = `<p style="color: red;">Erro ao carregar comprovantes: ${errorText || response.status}</p>`;
                          return;
                     }

                     const servico = await response.json();
                     console.log("Detalhes do serviço com comprovantes:", servico);

                     comprovantesListDiv.innerHTML = ''; // Limpa a mensagem de carregamento

                     if (servico.comprovantes_url && servico.comprovantes_url.length > 0) {
                         servico.comprovantes_url.forEach(url => {
                             const fileExtension = url.split('.').pop().toLowerCase();
                             const isImage = ['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension);

                             const fileElement = document.createElement('div');
                             fileElement.classList.add('mb-2');

                             if (isImage) {
                                 fileElement.innerHTML = `<a href="${url}" target="_blank"><img src="${url}" alt="Comprovante" style="max-width: 100px; max-height: 100px; margin-right: 10px;"></a>`;
                             } else { // Assume PDF ou outro tipo de documento
                                 fileElement.innerHTML = `<a href="${url}" target="_blank" class="btn btn-outline-primary btn-sm"><i class="dw dw-download"></i> Ver Arquivo (${fileExtension.toUpperCase()})</a>`;
                             }
                             comprovantesListDiv.appendChild(fileElement);
                         });
                     } else {
                         comprovantesListDiv.innerHTML = '<p>Nenhum comprovante enviado para este serviço.</p>';
                     }


                 } catch (error) {
                      console.error("Erro ao carregar comprovantes:", error);
                      comprovantesListDiv.innerHTML = `<p style="color: red;">Erro ao carregar comprovantes: ${error.message || 'Verifique a conexão.'}</p>`;
                 }
             }


			// Função de Logout
			document.getElementById('logout-link').addEventListener('click', (e) => {
				e.preventDefault();
				localStorage.removeItem('token');
                localStorage.removeItem('usuario'); // Remove o cache do usuário
                 // Para o polling antes de sair
                 pararPollingMensagensNaoLidas();
				window.location.href = 'login.html'; // Redireciona para a página de login principal
			});


			// Chamar carregarPerfilUsuario ao carregar a página
			document.addEventListener("DOMContentLoaded", carregarPerfilUsuario); // carregarServicosParaAvaliar é chamado dentro dela

             // Opcional: Parar polling ao fechar a janela/aba
             window.addEventListener('beforeunload', () => {
                  pararPollingMensagensNaoLidas();
             });

		</script>

	</body>
</html>
