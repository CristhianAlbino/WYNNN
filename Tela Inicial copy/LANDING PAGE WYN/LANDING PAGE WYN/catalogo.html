<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>WYN - Catálogo de Serviços</title>

		<link
			rel="apple-touch-icon"
			sizes="180x180"
			href="/w/1.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="32x32"
			href="/w/1.png"
		/>
		<link
			rel="icon"
			type="image/png"
			sizes="16x16"
			href="/w/1.png"
		/>

		<meta
			name="viewport"
			content="width=device-width, initial-scale=1, maximum-scale=1"
		/>

		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
			rel="stylesheet"
		/>
		<link rel="stylesheet" type="text/css" href="vendors/styles/core.css" />
		<link
			rel="stylesheet"
			type="text/css"
			href="vendors/styles/icon-font.min.css"
		/>
		<link rel="stylesheet" type="text/css" href="vendors/styles/style.css" />
		<link rel="stylesheet" type="text/css" href="catalogo.css" />
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0x0Ugau/r+PRGFNfN/P1M2k/L/W84b36d0K7+v7z/z0q0+A==" crossorigin="anonymous" referrerpolicy="no-referrer" />


		<style>
			/* Estilos customizados para a página de catálogo */
			.service-card {
				border: 1px solid #eee;
				border-radius: 8px;
				padding: 15px;
				margin-bottom: 20px;
				background-color: #fff;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
				transition: transform 0.2s ease-in-out;
                cursor: pointer; /* Indica que é clicável */
                display: flex; /* Adicionado para alinhar conteúdo verticalmente */
                flex-direction: column; /* Conteúdo em coluna */
			}

			.service-card:hover {
				transform: translateY(-5px);
				box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
			}

			.service-card .service-image-wrapper {
                width: 100%;
                height: 150px; /* Altura fixa para consistência */
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 4px;
                margin-bottom: 15px;
                background-color: #f0f0f0; /* Fundo para o placeholder */
                overflow: hidden; /* Garante que a imagem não vaze */
            }

			.service-card .service-image-wrapper img {
				max-width: 100%;
				height: 100%;
				object-fit: cover; /* Garante que a imagem cubra a área sem distorcer */
				border-radius: 4px;
				margin-bottom: 0; /* Remove margin-bottom herdado */
			}

            /* Estilo para o ícone de placeholder de serviço */
            .service-placeholder-icon-wrapper {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: #e9ecef; /* Cor de fundo suave */
                border-radius: 4px;
                color: #6c757d; /* Cor do ícone */
                font-size: 3rem; /* Tamanho do ícone */
            }


			.service-card h5 {
				margin-bottom: 8px;
				color: #333;
                font-size: 18px;
                font-weight: 600;
			}

			.service-card p {
				font-size: 14px;
				color: #555;
				margin-bottom: 5px;
                flex-grow: 1; /* Permite que a descrição ocupe o espaço disponível */
			}

            .service-card .price {
                font-size: 16px;
                font-weight: 700;
                color: #28a745; /* Cor verde para preço */
            }

            .service-card .provider-info {
                 font-size: 13px;
                 color: #777;
                 margin-top: 10px;
                 border-top: 1px solid #eee;
                 padding-top: 10px;
                 display: flex; /* Para alinhar conteúdo verticalmente */
                 align-items: center;
            }

            .service-card .provider-info img {
                 width: 30px; /* Tamanho da foto do prestador */
                 height: 30px;
                 border-radius: 50%;
                 object-fit: cover;
                 margin-right: 8px;
                 margin-bottom: 0; /* Remove margin-bottom herdado */
            }


            /* Estilos para mensagens de feedback (loading, erro, vazio) */
			.feedback-message {
				text-align: center;
				padding: 10px;
				margin: 15px 0; /* Espaçamento */
				border-radius: 4px;
				font-weight: 500;
			}

			.feedback-loading {
				color: #007bff; /* Cor azul */
				background-color: #e9f5ff; /* Fundo azul claro */
				border: 1px solid #b8daff;
			}

			.feedback-error {
				color: #dc3545; /* Cor vermelha */
				background-color: #f8d7da; /* Fundo vermelho claro */
				border: 1px solid #f5c6cb;
			}

			.feedback-empty {
				color: #6c757d; /* Cor cinza */
				background-color: #f8f9fa; /* Fundo branco/claro */
				border: 1px solid #dee2e6;
			}

             /* Estilo para o container de toasts */
             #toastContainer {
                 position: fixed;
                 top: 20px;
                 right: 20px;
                 z-index: 1050; /* Acima de modais */
             }

             /* Estilo individual do toast */
             .toast {
                 width: 300px;
                 max-width: 100%;
                 font-size: .875rem;
                 background-color: rgba(255,255,255,.85);
                 background-clip: padding-box;
                 border: 1px solid rgba(0,0,0,.1);
                 box-shadow: 0 .25rem .75rem rgba(0,0,0,.1);
                 opacity: 0;
                 border-radius: .25rem;
             }

             .toast.showing {
                 opacity: 1;
             }

             .toast.show {
                 display: block;
                 opacity: 1;
             }

             .toast.hide {
                 display: none;
             }

             .toast-header {
                 display: flex;
                 align-items: center;
                 padding: .25rem .75rem;
                 color: #6c757d;
                 background-color: rgba(255,255,255,.85);
                 background-clip: padding-box;
                 border-bottom: 1px solid rgba(0,0,0,.05);
                 border-top-left-radius: calc(.25rem - 1px);
                 border-top-right-radius: calc(.25rem - 1px);
             }

             .toast-body {
                 padding: .75rem;
             }

             /* Cores para os headers dos toasts */
             .toast-header.bg-success { background-color: #28a745 !important; color: white !important; }
             .toast-header.bg-danger { background-color: #dc3545 !important; color: white !important; }
             .toast-header.bg-info { background-color: #17a2b8 !important; color: white !important; }


             /* Estilos para o Chatbox Flutuante */
            #chat-toggle-button {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background-color: #007bff; /* Azul */
                color: white;
                border: none;
                border-radius: 50%;
                width: 60px;
                height: 60px;
                font-size: 2em;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
                z-index: 1001; /* Acima do chat container */
                transition: transform 0.3s ease-in-out;
            }

            #chat-toggle-button:hover {
                transform: scale(1.05);
            }

            /* Esconde o botão de toggle quando o chat está aberto */
            #chat-container.open + #chat-toggle-button {
                display: none;
            }

            /* Container do Chatbot */
            #chat-container {
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 350px;
                height: 450px;
                background-color: #fff;
                border-radius: 15px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
                display: flex;
                flex-direction: column;
                overflow: hidden;
                z-index: 1000; /* Garante que esteja acima de outros elementos */
                transform: translateX(400px); /* Esconde o chat inicialmente */
                transition: transform 0.3s ease-in-out;
            }

            #chat-container.open {
                transform: translateX(0); /* Mostra o chat */
            }

            #chat-header {
                background-color: #007bff; /* Cor do cabeçalho */
                color: white;
                padding: 15px;
                font-size: 1.1em;
                font-weight: bold;
                border-top-left-radius: 15px;
                border-top-right-radius: 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            #chat-close-button {
                background: none;
                border: none;
                color: white;
                font-size: 1.2em;
                cursor: pointer;
                padding: 5px;
                border-radius: 50%;
                transition: background-color 0.2s;
            }

            #chat-close-button:hover {
                background-color: rgba(255, 255, 255, 0.2);
            }

            #chat-messages {
                flex-grow: 1;
                padding: 15px;
                overflow-y: auto;
                background-color: #f9f9f9;
                border-bottom: 1px solid #eee;
            }

            .message {
                margin-bottom: 10px;
                padding: 8px 12px;
                border-radius: 10px;
                max-width: 80%;
            }

            .message.user {
                background-color: #e0f7fa; /* Azul claro para mensagens do usuário */
                align-self: flex-end;
                margin-left: auto;
            }

            .message.bot {
                background-color: #e8f5e9; /* Verde claro para mensagens do bot */
                align-self: flex-start;
                margin-right: auto;
            }

            #chat-loading-indicator {
                padding: 10px 15px;
                font-style: italic;
                color: #555;
                text-align: center;
                background-color: #f1f1f1;
            }

            #chat-input-area {
                display: flex;
                padding: 15px;
                border-top: 1px solid #eee;
            }

            #chat-input {
                flex-grow: 1;
                border: 1px solid #ddd;
                border-radius: 20px;
                padding: 10px 15px;
                margin-right: 10px;
                font-size: 0.9em;
            }

            #chat-send-button {
                background-color: #28a745; /* Verde para o botão de enviar */
                color: white;
                border: none;
                border-radius: 20px;
                padding: 10px 15px;
                cursor: pointer;
                transition: background-color 0.2s;
            }

            #chat-send-button:hover {
                background-color: #218838;
            }

            /* Media queries para responsividade */
            @media (max-width: 768px) {
                #chat-container {
                    width: 90%;
                    height: 80%;
                    bottom: 5%;
                    right: 5%;
                    transform: translateX(100vw); /* Esconde para a direita na tela pequena */
                }

                #chat-container.open {
                    transform: translateX(0);
                }

                #chat-toggle-button {
                    width: 50px;
                    height: 50px;
                    font-size: 1.8em;
                    bottom: 15px;
                    right: 15px;
                }
            }

		</style>


		<script
			async
			src="https://www.googletagmanager.com/gtag/js?id=G-GBZ3SGGX85"
		></script>
		<script
			async
			src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2973766580778258"
			crossorigin="anonymous"
		></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("js", new Date());

			gtag("config", "G-GBZ3SGGX85");
		</script>
		<script>
			(function (w, d, s, l, i) {
				w[l] = w[l] || [];
				w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
				var f = d.getElementsByTagName(s)[0],
					j = d.createElement(s),
					dl = l != "dataLayer" ? "&l=" + l : "";
				j.async = true;
				j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
				f.parentNode.insertBefore(j, f);
			})(window, document, "script", "dataLayer", "GTM-NXZMQSS");
		</script>
	</head>
	<body>
		<div class="pre-loader">
			<div class="pre-loader-box">
				<div class="loader-logo">
					<img src="w (1).png" alt="" />
				</div>
				<div class="loader-progress" id="progress_div">
					<div class="bar" id="bar1"></div>
				</div>
				<div class="percent" id="percent1">0%</div>
				<div class="loading-text">Carregando...</div>
			</div>
		</div>

		<div class="header">
			<div class="header-left">
				<div class="menu-icon bi bi-list"></div>
				<div
					class="search-toggle-icon bi bi-search"
					data-toggle="header_search"
				></div>
				<div class="header-search">
					<form>
						<div class="form-group mb-0">
							<i class="dw dw-search2 search-icon"></i>
							<input
								type="text"
								class="form-control search-input"
								placeholder="Buscar serviços..."
								id="service-search-input" />
							<div class="dropdown">
								<a
									class="dropdown-toggle no-arrow"
									href="#"
									role="button"
									data-toggle="dropdown"
								>
									<i class="ion-arrow-down-c"></i>
								</a>
								<div class="dropdown-menu dropdown-menu-right">
									<div class="form-group row">
										<label class="col-sm-12 col-md-2 col-form-label"
											>Prestador</label
										>
										<div class="col-sm-12 col-md-10">
											<input
												class="form-control form-control-sm form-control-line"
												type="text"
												id="filter-provider" />
										</div>
									</div>
									<div class="form-group row">
										<label class="col-sm-12 col-md-2 col-form-label">Categoria</label>
										<div class="col-sm-12 col-md-10">
											<input
												class="form-control form-control-sm form-control-line"
												type="text"
												id="filter-category" />
										</div>
									</div>
									<div class="text-right">
										<button class="btn btn-primary" id="apply-filters-btn">Aplicar Filtros</button> </div>
								</div>
							</div>
						</div>
					</form>
				</div>
			</div>
			<div class="header-right">
				<div class="dashboard-setting user-notification">
					<div class="dropdown">
						<a
							class="dropdown-toggle no-arrow"
							href="javascript:;"
							data-toggle="right-sidebar"
						>
							<i class="dw dw-settings2"></i>
						</a>
					</div>
				</div>

				<div class="user-info-dropdown">
					<div class="dropdown">
						<a
							class="dropdown-toggle"
							href="#"
							role="button"
							data-toggle="dropdown"
						>
							<span class="user-icon">
								<img src="vendors/images/photo1.jpg" id="user-profile-pic" class="profile-pic-header" alt="" /> </span>
							<span class="user-name" id="user-name">Cliente</span> </a>
						<div
							class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list"
						>
							<a class="dropdown-item" href="profile.html"
								><i class="dw dw-user1"></i> Perfil</a
							>
							<a class="dropdown-item" href="profile.html"
								><i class="dw dw-settings2"></i> Configurações</a
							>
							<a class="dropdown-item" href="faq.html"
								><i class="dw dw-help"></i> Ajuda</a
							>
							<a class="dropdown-item" href="#" id="logout-link"
								><i class="dw dw-logout"></i> Sair</a
							>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="right-sidebar">
			<div class="sidebar-title">
				<h3 class="weight-600 font-16 text-blue">
					Configuração de Layout
					<span class="btn-block font-weight-400 font-12"
						>Personalização</span
					>
				</h3>
				<div class="close-sidebar" data-toggle="right-sidebar-close">
					<i class="icon-copy ion-close-round"></i>
				</div>
			</div>
			<div class="right-sidebar-body customscroll">
				<div class="right-sidebar-body-content">
					<h4 class="weight-600 font-18 pb-10">Fundo</h4>
					<div class="sidebar-btn-group pb-30 mb-10">
						<a
							href="javascript:void(0);"
							class="btn btn-outline-primary header-white active"
							>Claro</a
						>
						<a
							href="javascript:void(0);"
							class="btn btn-outline-primary header-dark"
							>Escuro</a
						>
					</div>

					<h4 class="weight-600 font-18 pb-10">Menu Lateral</h4>
					<div class="sidebar-btn-group pb-30 mb-10">
						<a
							href="javascript:void(0);"
							class="btn btn-outline-primary sidebar-light"
							>Claro</a
						>
						<a
							href="javascript:void(0);"
							class="btn btn-outline-primary sidebar-dark active"
							>Escuro</a
						>
					</div>

					<h4 class="weight-600 font-18 pb-10">Icone Dropdown</h4>
					<div class="sidebar-radio-group pb-10 mb-10">
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebaricon-1"
								name="menu-dropdown-icon"
								class="custom-control-input"
								value="icon-style-1"
								checked=""
							/>
							<label class="custom-control-label" for="sidebaricon-1"
								><i class="fa fa-angle-down"></i
							></label>
						</div>
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebaricon-2"
								name="menu-dropdown-icon"
								class="custom-control-input"
								value="icon-style-2"
							/>
							<label class="custom-control-label" for="sidebaricon-2"
								><i class="ion-plus-round"></i
							></label>
						</div>
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebariconlist-3"
								name="menu-list-icon"
								class="custom-control-input"
								value="icon-list-style-3"
							/>
							<label class="custom-control-label" for="sidebariconlist-3"
								><i class="fa fa-angle-double-right"></i
							></label>
						</div>
					</div>

					<h4 class="weight-600 font-18 pb-10">Icones do Menu</h4>
					<div class="sidebar-radio-group pb-30 mb-10">
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebariconlist-1"
								name="menu-list-icon"
								class="custom-control-input"
								value="icon-list-style-1"
								checked=""
							/>
							<label class="custom-control-label" for="sidebariconlist-1"
								><i class="ion-minus-round"></i
							></label>
						</div>
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebariconlist-2"
								name="menu-list-icon"
								class="custom-control-input"
								value="icon-list-style-2"
							/>
							<label class="custom-control-label" for="sidebariconlist-2"
								><i class="fa fa-circle-o" aria-hidden="true"></i
							></label>
						</div>
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebariconlist-3"
								name="menu-list-icon"
								class="custom-control-input"
								value="icon-list-style-3"
							/>
							<label class="custom-control-label" for="sidebariconlist-3"
								><i class="dw dw-check"></i
							></label>
						</div>
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebariconlist-4"
								name="menu-list-icon"
								class="custom-control-input"
								value="icon-list-style-4"
								checked=""
							/>
							<label class="custom-control-label" for="sidebariconlist-4"
								><i class="icon-copy dw dw-next-2"></i
							></label>
						</div>
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebariconlist-5"
								name="menu-list-icon"
								class="custom-control-input"
								value="icon-list-style-5"
							/>
							<label class="custom-control-label" for="sidebariconlist-5"
								><i class="dw dw-fast-forward-1"></i
							></label>
						</div>
						<div class="custom-control custom-radio custom-control-inline">
							<input
								type="radio"
								id="sidebariconlist-6"
								name="menu-list-icon"
								class="custom-control-input"
								value="icon-list-style-6"
							/>
							<label class="custom-control-label" for="sidebariconlist-6"
								><i class="dw dw-next"></i
							></label>
						</div>
					</div>

					<div class="reset-options pt-30 text-center">
						<button class="btn btn-danger" id="reset-settings">
							Resetar Configurações
						</button>
					</div>
				</div>
			</div>
		</div>

		<div class="left-side-bar">
			<div class="brand-logo">
				<a href="indexx.html"> <img src="w (1).png" alt="" class="dark-logo" />
					<img
						src="w (1).png"
						alt=""
						class="light-logo"
					/>
				</a>
				<div class="close-sidebar" data-toggle="left-sidebar-close">
					<i class="ion-close-round"></i>
				</div>
			</div>
			<div class="menu-block customscroll">
				<div class="sidebar-menu">
					<ul id="accordion-menu">
						<li>
							<a href="indexx.html" class="dropdown-toggle no-arrow active">
                                <span class="micon bi bi-house"></span
								><span class="mtext">Dashboard</span>
							</a>
						</li>
						<li>
							<a href="catalogo.html" class="dropdown-toggle no-arrow"> <span class="micon bi bi-grid"></span
								><span class="mtext">Catálogo de Serviços</span>
							</a>
						</li>
						<li>
							<a href="contratos.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-journal-check"></span
								><span class="mtext">Meus Pedidos</span>
							</a>
						</li>
                        <li>
							<a href="chat-list.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-chat-dots"></span>
                                <span class="mtext">Chat de Pedidos</span>
                                <span id="unread-chat-count-sidebar-cliente" class="badge badge-pill badge-danger" style="display: none; margin-left: 5px;">0</span>
                            </a>
                        </li>
                         <li>
							<a href="avaliar-prestador.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-star-fill"></span>
                                <span class="mtext">Avaliar Prestadores</span>
                            </a>
                        </li>
                         <li>
							<a href="profile.html" class="dropdown-toggle no-arrow">
                                <span class="micon bi bi-person"></span>
                                <span class="mtext">Meu Perfil</span>
                            </a>
                        </li>

						<li class="dropdown">
							<a href="javascript:;" class="dropdown-toggle">
								<span class="micon bi bi-file-pdf"></span
								><span class="mtext">Documentação</span>
							</a>
							<ul class="submenu">
								<li><a href="/Tela Inicial copy/Termos e Condições.docx">Termos e Condições</a></li>
								</ul>
						</li>
						</ul>
				</div>
			</div>
		</div>
		<div class="mobile-menu-overlay"></div>

		<div class="main-container">
			<div class="xs-pd-20-10 pd-ltr-20">
				 <div class="title pb-20">
					<div>
						<h2 class="h3 mb-0">Catálogo de Serviços</h2>
                        <p class="font-14 text-secondary weight-500">Encontre o serviço ideal para suas necessidades.</p>
					</div>
				</div>

                <div class="card-box pb-10">
					<div class="h5 pd-20 mb-0">Serviços Disponíveis</div>

                    <div id="services-loading" class="feedback-message feedback-loading" style="display: none;">Carregando serviços...</div>
					<div id="services-feedback" class="feedback-message feedback-error" style="display: none;"></div>
                    <div id="services-empty" class="feedback-message feedback-empty" style="display: none;">Nenhum serviço disponível no momento.</div>


					<div class="row pd-20" id="service-list">
						</div>
				</div>

                <div class="card-box pb-10 mt-30">
                    <div class="h5 pd-20 mb-0">Recomendações para Você</div>
                    <div id="recommendations-loading" class="feedback-message feedback-loading" style="display: none;">Gerando recomendações...</div>
                    <div id="recommendations-feedback" class="feedback-message feedback-error" style="display: none;"></div>
                    <div id="recommendations-empty" class="feedback-message feedback-empty" style="display: none;">Não foi possível gerar recomendações no momento.</div>

                    <div class="row pd-20" id="recommended-service-list">
                        </div>
                </div>
                <div class="footer-wrap pd-20 mb-20 card-box">
					Plataforma WYN-TECH
				</div>
			</div>
		</div>

        <div class="modal fade" id="solicitationModal" tabindex="-1" role="dialog" aria-labelledby="solicitationModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="solicitationModalLabel">Solicitar Serviço: <span id="modal-service-name"></span></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                     <div class="modal-body">
                         <div id="modal-service-details">
                             <p><strong>Prestador:</strong> <span id="modal-provider-name"></span></p>
                              <p><strong>Descrição do Catálogo:</strong> <span id="modal-service-description"></span></p>
                              <p><strong>Faixa de Preço:</strong> <span id="modal-service-price"></span></p>
                              </div>

                         <hr>

                         <form id="solicitation-form">
                             <input type="hidden" id="solicitacao-servico-oferecido-id">
                             <input type="hidden" id="solicitacao-prestador-id">

                             <div class="form-group">
                                 <label for="user-service-request">Descreva o que você precisa (em suas palavras):</label>
                                 <textarea class="form-control" id="user-service-request" rows="3" placeholder="Ex: Preciso instalar uma nova torneira na cozinha, a antiga está vazando."></textarea>
                                 <button type="button" class="btn btn-info btn-sm mt-2" id="generate-description-ai-btn">Gerar Descrição Detalhada (IA)</button>
                                 <div id="ai-description-loading" class="feedback-message feedback-loading mt-2" style="display: none;">Gerando descrição...</div>
                             </div>

                             <div class="form-group">
                                 <label for="ai-generated-description">Descrição Detalhada do Serviço (Gerada por IA, editável):</label>
                                 <textarea class="form-control" id="ai-generated-description" rows="5" placeholder="A descrição detalhada gerada pela IA aparecerá aqui. Você pode editá-la se desejar." ></textarea>
                             </div>

                             <div class="form-group">
                                 <label for="data-preferencial">Data Preferencial para o Serviço:</label>
                                 <input type="date" class="form-control" id="data-preferencial" required>
                             </div>

                              <div class="form-group">
                                 <label for="hora-preferencial">Hora Preferencial para o Serviço:</label>
                                 <input type="time" class="form-control" id="hora-preferencial">
                             </div>

                             <div class="form-group">
                                 <label for="endereco-servico">Endereço do Serviço:</label>
                                 <input type="text" class="form-control" id="endereco-servico" placeholder="Ex: Rua Exemplo, 123, Bairro" required>
                             </div>
                             <div class="form-group">
                                <label for="geolocation-service">Localização do Serviço (Latitude, Longitude):</label>
                                <input type="text" class="form-control" id="geolocation-service" placeholder="Ex: -23.5505, -46.6333" readonly>
                                <button type="button" class="btn btn-secondary btn-sm mt-2" id="get-current-location-btn">Usar Localização Atual</button>
                                <div id="geolocation-status" class="text-muted mt-1"></div>
                             </div>
                             <div class="form-group">
                                 <label for="notas-adicionais">Notas Adicionais (Opcional - para qualquer outro detalhe):</label>
                                 <textarea class="form-control" id="notas-adicionais" rows="3" placeholder="Qualquer outra observação que não se encaixe na descrição principal."></textarea>
                             </div>

                             <div class="form-group form-check">
                                 <input type="checkbox" class="form-check-input" id="servico-urgente">
                                 <label class="form-check-label" for="servico-urgente">Marcar como Urgente</label>
                             </div>
                              <div class="text-right mt-4">
                                 <button type="submit" class="btn btn-success" id="submit-btn">
                                      Enviar Solicitação
                                 </button>
                             </div>
                         </form>
                    </div>
                </div>
            </div>
        </div>


         <div id="toastContainer">
            </div>


		<script src="vendors/scripts/core.js"></script>
		<script src="vendors/scripts/script.min.js"></script>
		<script src="vendors/scripts/process.js"></script>
		<script src="vendors/scripts/layout-settings.js"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


		<noscript>
			<iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NXZMQSS" height="0" width="0" style="display: none; visibility: hidden"></iframe>
		</noscript>

		<script>
			// Variável para armazenar os dados do usuário logado (cliente)
			let usuarioLogado = null;
			// Variável para armazenar a lista completa de serviços (carregada do backend)
			let allServices = [];
            // Variável para armazenar os serviços que o usuário já pediu
            let userPastServices = [];
             // Intervalo para o polling de serviços
             let servicesPollingInterval = null;
              // Intervalo para o polling de mensagens de chat não lidas
             let unreadChatPollingInterval = null; // DECLARADA AQUI APENAS UMA VEZ

            // Constante para o tamanho máximo da descrição no card
            const MAX_DESCRIPTION_LENGTH = 150;

            // Variáveis para armazenar a localização do usuário
            let userLatitude = null;
            let userLongitude = null;

            // Função para obter a localização atual do usuário
            function getUserLocation() {
                const geolocationStatus = document.getElementById('geolocation-status');
                const geolocationInputField = document.getElementById('geolocation-service');

                if (navigator.geolocation) {
                    geolocationStatus.textContent = 'Obtendo localização...';
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLatitude = position.coords.latitude;
                            userLongitude = position.coords.longitude;
                            geolocationInputField.value = `${userLatitude}, ${userLongitude}`;
                            geolocationStatus.textContent = 'Localização obtida com sucesso.';
                            console.log(`[CATALOGO] Localização do usuário: ${userLatitude}, ${userLongitude}`);
                            // Após obter a localização, você pode recarregar o catálogo com base nela
                            carregarServicosCatalogo();
                        },
                        (error) => {
                            let errorMessage = 'Erro ao obter localização: ';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage += 'Permissão negada. Por favor, permita o acesso à localização.';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage += 'Informação de localização indisponível.';
                                    break;
                                case error.TIMEOUT:
                                    errorMessage += 'Tempo limite excedido ao tentar obter localização.';
                                    break;
                                case error.UNKNOWN_ERROR:
                                    errorMessage += 'Erro desconhecido.';
                                    break;
                            }
                            geolocationStatus.textContent = errorMessage;
                            console.error(`[CATALOGO] Erro de geolocalização: ${errorMessage}`);
                            showToast(errorMessage, 'danger');
                            // Se a localização não puder ser obtida, ainda carrega o catálogo sem filtro de proximidade
                            carregarServicosCatalogo();
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    geolocationStatus.textContent = 'Geolocalização não é suportada por este navegador.';
                    console.warn("[CATALOGO] Geolocalização não suportada.");
                    showToast("Seu navegador não suporta geolocalização.", 'danger');
                    // Se a geolocalização não for suportada, ainda carrega o catálogo
                    carregarServicosCatalogo();
                }
            }


            // Função para truncar texto
            function truncateText(text, maxLength) {
                if (!text) return '';
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength) + '...';
            }

            // Função para gerar o HTML da imagem do serviço com fallback
            function getServiceImageHtml(service) {
                let imageUrl = '';
                // Prioriza foto_servico_url se existir
                if (service.foto_servico_url && service.foto_servico_url.trim() !== '') {
                    imageUrl = service.foto_servico_url;
                } else if (service.foto_perfil_prestador_url && service.foto_perfil_prestador_url.trim() !== '') {
                    // Caso contrário, usa a foto de perfil do prestador
                    imageUrl = service.foto_perfil_prestador_url;
                }

                if (imageUrl) {
                    // Se houver uma URL de imagem, cria a tag <img> com um fallback JavaScript
                    return `
                        <div class="service-image-wrapper">
                            <img src="${imageUrl}" alt="${service.nome || 'Serviço sem Nome'}"
                                 onerror="this.onerror=null; this.parentNode.innerHTML = '<div class=\\'service-placeholder-icon-wrapper\\'><i class=\\'fa-solid fa-screwdriver-wrench\\'></i></div>';" />
                        </div>
                    `;
                } else {
                    // Se não houver URL de imagem, exibe o ícone de placeholder
                    return `
                        <div class="service-image-wrapper">
                            <div class="service-placeholder-icon-wrapper">
                                <i class="fa-solid fa-screwdriver-wrench"></i>
                            </div>
                        </div>
                    `;
                }
            }


            // Função para exibir toast notifications (copiada de outras telas)
            function showToast(message, type = 'success') {
                const toastContainer = document.getElementById('toastContainer');
                if (!toastContainer) {
                    console.error("[CATALOGO] Toast container não encontrado!");
                    return;
                }

                const toastElement = document.createElement('div');
                toastElement.classList.add('toast');
                toastElement.setAttribute('role', 'alert');
                toastElement.setAttribute('aria-live', 'assertive');
                toastElement.setAttribute('aria-atomic', 'true');
                toastElement.setAttribute('data-delay', '5000');

                toastElement.innerHTML = `
                    <div class="toast-header ${type === 'success' ? 'bg-success text-white' : type === 'danger' ? 'bg-danger text-white' : 'bg-info text-white'}">
                        <strong class="mr-auto">${type === 'success' ? 'Sucesso' : type === 'danger' ? 'Erro' : 'Informação'}</strong>
                        <small>Agora</small>
                        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                `;

                toastContainer.appendChild(toastElement);
                $(toastElement).toast('show');
                $(toastElement).on('hidden.bs.toast', function () {
                    $(this).remove();
                });
            }


			// Função para carregar o perfil do usuário logado
			async function carregarPerfilUsuario() {
				const token = localStorage.getItem('token');
				const usuarioCache = localStorage.getItem('usuario'); // Chave correta para usuário cliente

				// Se não houver token ou cache, redireciona imediatamente
				if (!token || !usuarioCache) {
					console.warn("[CATALOGO] Usuário não autenticado ou cache vazio. Redirecionando para login do cliente.");
					window.location.href = "login.html"; // Redireciona para a página de login do cliente
					return; // Interrompe a execução da função
				}

				try {
					 // Tenta usar o cache primeiro para preencher nome e foto rapidamente
					 usuarioLogado = JSON.parse(usuarioCache);
					 const nomeSpan = document.getElementById("user-name");
                     const userProfilePicImg = document.getElementById("user-profile-pic");

					 if (nomeSpan && usuarioLogado?.nome) {
						 nomeSpan.textContent = usuarioLogado.nome;
					 }
                      if (userProfilePicImg && usuarioLogado?.foto_perfil_url) {
                         userProfilePicImg.src = usuarioLogado.foto_perfil_url;
                          userProfilePicImg.onerror = function() {
                             // Fallback para imagem padrão se a URL da foto falhar
                             this.onerror = null; // Evita loop infinito de erro
                             this.src = "vendors/images/photo1.jpg"; // Imagem padrão para cliente
                         };
                     } else if (userProfilePicImg) {
                          // Se não houver foto no cache, usa a imagem padrão
                          userProfilePicImg.src = "vendors/images/photo1.jpg"; // Imagem padrão para cliente
                     }


					// Chamada ao backend para validar o token e obter dados completos e atualizados
					 console.log("[CATALOGO] Verificando token e buscando perfil no backend...");
					 // --- URL ATUALIZADA PARA O BACKEND NO RENDER ---
					 const res = await fetch('https://wyn-backend.onrender.com/perfil', {
						 headers: { 'Authorization': 'Bearer ' + token }
					 });

					 const resClone = res.clone(); // Clonar para ler o body se der erro de JSON

					 if (!res.ok) {
						 // Se o backend retornar 401 ou 403, o token é inválido ou expirado
						 if (res.status === 401 || res.status === 403) {
							 console.error("[CATALOGO] Token inválido ou expirado. Redirecionando para login do cliente.");
							 showToast("Sua sessão expirou. Por favor, faça login novamente.", 'danger');
							 localStorage.removeItem('token'); // Limpa token inválido
							 localStorage.removeItem('usuario'); // Limpa cache
							 setTimeout(() => { window.location.href = "login.html"; }, 3000); // Redireciona
							 return; // Interrompe a execução
						 }
						  // Para outros erros HTTP, loga e lança exceção
						  const errorText = await resClone.text();
						  console.error("[CATALOGO] Erro HTTP ao buscar perfil:", res.status, errorText);
						  throw new Error(errorText || `Erro HTTP ao buscar perfil: ${res.status}`);
					 }

					let data = {};
					 try {
						 data = await res.json();
                         console.log("[CATALOGO] Dados de perfil recebidos do backend:", data); // LOG ADICIONADO
					 } catch(jsonError) {
						 console.error("[CATALOGO] Erro ao parsear JSON do perfil:", await resClone.text());
						 throw new Error("Resposta de perfil inválida.");
					 }


					// Verifique se o perfil retornado é de um usuário cliente ('usuario') E se o ID corresponde
					 if (data.tipo !== 'usuario' || !data.usuario?._id || data.usuario._id !== usuarioLogado._id) {
						  console.error("[CATALOGO] Token válido, mas não corresponde a um usuário cliente ou ID não coincide.");
						  showToast("Acesso negado. Esta página é para clientes. Faça login com uma conta de cliente.", 'danger');
                          // Redireciona para a página de login geral, pois o token não é de cliente válido
						   localStorage.removeItem('token'); // Limpa token incorreto
						   localStorage.removeItem('usuario'); // Limpa cache
						   setTimeout(() => { window.location.href = "login.html"; }, 3000);
						  return; // Interrompe a execução
					 }

					 // Atualiza a variável global com os dados completos e validados do usuário
					 usuarioLogado = data.usuario;
                     console.log("[CATALOGO] Variável usuarioLogado atualizada:", usuarioLogado); // LOG ADICIONADO


					// Atualiza o nome e foto na interface com os dados validados do backend
					if (usuarioLogado?.nome && nomeSpan) {
						nomeSpan.textContent = usuarioLogado.nome;
                         console.log("[CATALOGO] Nome do usuário atualizado na UI:", usuarioLogado.nome); // LOG ADICIONADO
					}
                     if (userProfilePicImg && usuarioLogado?.foto_perfil_url) {
                         userProfilePicImg.src = usuarioLogado.foto_perfil_url;
                          userProfilePicImg.onerror = function() {
                             this.onerror = null;
                             this.src = "vendors/images/photo1.jpg";
                             console.warn("[CATALOGO] Erro ao carregar foto de perfil, usando padrão."); // LOG ADICIONADO
                         };
                          console.log("[CATALOGO] Foto de perfil do usuário atualizada na UI:", usuarioLogado.foto_perfil_url); // LOG ADICIONADO
                     } else if (userProfilePicImg) {
                          userProfilePicImg.src = "vendors/images/photo1.jpg";
                           console.log("[CATALOGO] Sem foto de perfil no backend, usando padrão."); // LOG ADICIONADO
                     }


					console.log("[CATALOGO] Perfil do usuário (cliente) carregado e validado com sucesso.");

                    // --- CHAMA AS FUNÇÕES PARA CARREGAR O CATÁLOGO E RECOMENDAÇÕES SOMENTE AQUI ---
                    getUserLocation(); // Tenta obter a localização do usuário antes de carregar o catálogo
                    await carregarPedidosAnterioresUsuario(); // Carrega os pedidos anteriores do usuário
                    await loadPersonalizedRecommendations(); // Carrega as recomendações personalizadas
                    iniciarPollingServicos(); // Inicia o polling para atualizações
                    carregarContadorMensagensNaoLidas(); // Carrega contador de mensagens
                    iniciarPollingMensagensNaoLidas(); // Inicia polling para mensagens


				} catch (err) {
					console.error('[CATALOGO] Erro ao carregar perfil do usuário ou validar sessão:', err);
					 // Se ocorreu um erro na chamada fetch ou no processamento da resposta
					 showToast('Erro ao carregar informações do usuário. Por favor, faça login novamente.', 'danger');
                     localStorage.removeItem('token'); // Limpa token em caso de erro
					 localStorage.removeItem('usuario'); // Limpa cache em caso de erro
                     setTimeout(() => { window.location.href = "login.html"; }, 3000); // Redireciona para login do cliente
				}
			}

			// Função de Logout
			document.getElementById('logout-link').addEventListener('click', (e) => {
				 e.preventDefault();
				 localStorage.removeItem('token');
				 localStorage.removeItem('usuario'); // Limpa também o cache do usuário
                 localStorage.removeItem('userId'); // Remover também o userId (se estiver usando em algum lugar)
                 pararPollingServicos(); // Para o polling de serviços
                 pararPollingMensagensNaoLidas(); // Para o polling de mensagens
				 window.location.href = 'login.html'; // Redireciona para a página de login do cliente
			});


            // Função para carregar o contador de mensagens não lidas (copiada do dashboard do prestador e adaptada)
            async function carregarContadorMensagensNaoLidas() {
                 const token = localStorage.getItem("token");
                 // ID do elemento na sidebar para o contador de mensagens não lidas
                 const unreadCountElementSidebar = document.getElementById("unread-chat-count-sidebar-cliente");

                 if (!token) {
                     if (unreadCountElementSidebar) unreadCountElementSidebar.style.display = 'none';
                     return;
                 }

                 try {
                     // Este endpoint foi comentado no backend `index.js`.
                     // Se você deseja uma contagem específica de mensagens não lidas para o chat,
                     // você precisará descomentar e/ou ajustar essa rota no seu `index.js` do backend.
                     // Por enquanto, esta função pode não funcionar como esperado devido ao 404.
                     const response = await fetch("https://wyn-backend.onrender.com/api/chat/unread-count", {
                         headers: { 'Authorization': `Bearer ${token}` }
                     });

                     if (!response.ok) {
                         console.error("[CATALOGO] Erro ao buscar contagem de mensagens não lidas (cliente):", response.status);
                         if (unreadCountElementSidebar) unreadCountElementSidebar.style.display = 'none';
                         return;
                     }

                     const data = await response.json();
                     const unreadCount = data.total || 0;

                     if (unreadCountElementSidebar) {
                         if (unreadCount > 0) {
                             unreadCountElementSidebar.textContent = unreadCount;
                             unreadCountElementSidebar.style.display = 'inline';
                         } else {
                             unreadCountElementSidebar.style.display = 'none';
                         }
                     }

                 } catch (error) {
                     console.error("[CATALOGO] Erro ao carregar contagem de mensagens não lidas (cliente):", error);
                     if (unreadChatPollingInterval) clearInterval(unreadChatPollingInterval);
                     if (unreadCountElementSidebar) unreadCountElementElementSidebar.style.display = 'none';
                 }
            }

             // Função para iniciar o polling de mensagens não lidas (a cada 30 segundos)
             function iniciarPollingMensagensNaoLidas() {
                 if (unreadChatPollingInterval) {
                     clearInterval(unreadChatPollingInterval);
                 }

                 unreadChatPollingInterval = setInterval(() => {
                     console.log("[CATALOGO] Verificando mensagens não lidas (cliente)...");
                     carregarContadorMensagensNaoLidas();
                 }, 30000);

                 console.log("[CATALOGO] Polling de mensagens não lidas (cliente) iniciado.");
             }

             // Função para parar o polling de mensagens não lidas
             function pararPollingMensagensNaoLidas() {
                 if (unreadChatPollingInterval) {
                     clearInterval(unreadChatPollingInterval);
                     unreadChatPollingInterval = null;
                     console.log("[CATALOGO] Polling de mensagens não lidas parado.");
                 }
             }


            // Função para carregar os serviços do catálogo do backend
            async function carregarServicosCatalogo() {
                const loading = document.getElementById("services-loading");
                const feedback = document.getElementById("services-feedback");
                const empty = document.getElementById("services-empty");
                const serviceListDiv = document.getElementById("service-list");
                const token = localStorage.getItem("token");


                loading.style.display = "block";
                feedback.style.display = "none";
                empty.style.display = "none";
                serviceListDiv.innerHTML = ""; // Limpa a lista atual

                 if (!token) {
                      feedback.textContent = "Autenticação necessária para carregar o catálogo.";
                      feedback.style.display = "block";
                      loading.style.display = "none";
                      console.warn("[CATALOGO] carregarServicosCatalogo: Token não encontrado.");
                      return;
                 }

                console.log("[CATALOGO] Buscando serviços do catálogo no backend...");
                try {
                    // Adiciona a localização do usuário ao corpo da requisição
                    const requestBody = {
                        latitude: userLatitude,
                        longitude: userLongitude
                    };

                    const response = await fetch("https://wyn-backend.onrender.com/servicos-catalogo", {
                         method: 'POST', // Mudado para POST para enviar o body
                         headers: {
                             'Content-Type': 'application/json',
                             'Authorization': `Bearer ${token}`
                         },
                         body: JSON.stringify(requestBody) // Envia a localização
                    });

                    console.log("[CATALOGO] Resposta do backend recebida:", response.status);

                    if (!response.ok) {
                         const errorText = await response.text();
                         console.error("[CATALOGO] Erro HTTP ao buscar serviços do catálogo:", response.status, errorText);
                         throw new Error(errorText || `Erro HTTP ao buscar serviços do catálogo: ${response.status}`);
                    }

                    const servicos = await response.json();
                    console.log("[CATALOGO] Serviços do catálogo carregados:", servicos);

                    allServices = servicos; // Armazena a lista completa

                    // Popula o catálogo com os serviços carregados
                    populateCatalog(allServices, 'service-list');


                } catch (error) {
                    console.error("[CATALOGO] Erro ao carregar serviços do catálogo:", error);
                    feedback.textContent = `Erro ao carregar serviços: ${error.message || 'Verifique a conexão com o servidor.'}`;
                    feedback.style.display = "block";
                    empty.style.display = "none";
                } finally {
                    loading.style.display = "none";
                }
            }

            // Função para carregar os pedidos anteriores do usuário
            async function carregarPedidosAnterioresUsuario() {
                const token = localStorage.getItem("token");
                if (!token) {
                    userPastServices = [];
                    return;
                }

                try {
                    const response = await fetch("https://wyn-backend.onrender.com/meus-servicos", {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (!response.ok) {
                        console.error("[CATALOGO] Erro ao buscar pedidos anteriores do usuário:", response.status);
                        userPastServices = [];
                        return;
                    }

                    userPastServices = await response.json();
                    console.log("[CATALOGO] Pedidos anteriores do usuário carregados:", userPastServices);
                } catch (error) {
                    console.error("[CATALOGO] Erro ao carregar pedidos anteriores do usuário:", error);
                    userPastServices = [];
                }
            }


            // Função para popular a lista de serviços na UI (agora com um ID de container dinâmico)
            function populateCatalog(servicesToDisplay, containerId) {
                const serviceListDiv = document.getElementById(containerId);
                const emptyElement = document.getElementById(containerId === 'service-list' ? 'services-empty' : 'recommendations-empty');


                serviceListDiv.innerHTML = ""; // Limpa a lista atual

                if (!servicesToDisplay || servicesToDisplay.length === 0) {
                    console.log(`[CATALOGO] Nenhum serviço para exibir no container ${containerId}. Mostrando mensagem de vazio.`);
                    emptyElement.style.display = "block";
                } else {
                    console.log(`[CATALOGO] Exibindo ${servicesToDisplay.length} serviços no container ${containerId}.`);
                    emptyElement.style.display = "none";
                    servicesToDisplay.forEach(servico => {
                        const serviceCard = document.createElement('div');
                        serviceCard.classList.add('col-lg-4', 'col-md-6', 'col-sm-12', 'mb-20');
                        // Adiciona data attributes para o ID do serviço oferecido e o ID do prestador
                        serviceCard.setAttribute('data-servico-oferecido-id', servico._id);
                        // Garante que prestador_id existe antes de tentar acessar _id
                        serviceCard.setAttribute('data-prestador-id', servico.prestador_id?._id || '');

                        const precoTexto = (servico.faixa_preco_min !== undefined && servico.faixa_preco_max !== undefined)
                                    ? `R$ ${servico.faixa_preco_min.toFixed(2).replace('.', ',')} - R$ ${servico.faixa_preco_max.toFixed(2).replace('.', ',')}`
                                    : (servico.faixa_preco_min !== undefined ? `A partir de R$ ${servico.faixa_preco_min.toFixed(2).replace('.', ',')}` : 'Preço a combinar');

                        // Usa a função getServiceImageHtml para a imagem
                        const serviceImageHtml = getServiceImageHtml(servico);
                        // Trunca a descrição
                        const truncatedDescription = truncateText(servico.descricao, MAX_DESCRIPTION_LENGTH);


                        serviceCard.innerHTML = `
                            <div class="service-card">
                                ${serviceImageHtml}
                                <h5>${servico.nome || 'Serviço sem Nome'}</h5>
                                <p>${truncatedDescription || 'Sem descrição.'}</p>
                                <p class="price">Faixa de Preço: ${precoTexto}</p>
                                <div class="provider-info">
                                     ${servico.foto_perfil_prestador_url ? `<img src="${servico.foto_perfil_prestador_url}" alt="Foto de Perfil do Prestador" onerror="this.onerror=null;this.src='vendors/images/photo4.jpg';"/>` : `<img src="vendors/images/photo4.jpg" alt="Foto de Perfil Padrão"/>`}
                                     <span>Prestador: ${servico.nome_prestador || 'Desconhecido'}</span>
                                </div>
                            </div>
                        `;
                        serviceListDiv.appendChild(serviceCard);
                    });

                     // Adiciona listener de clique aos novos cards
                     addServiceCardListeners(containerId);
                }
            }

             // Função para adicionar listeners de clique aos cards de serviço (agora com ID de container)
             function addServiceCardListeners(containerId) {
                 document.querySelectorAll(`#${containerId} .service-card`).forEach(card => {
                     card.addEventListener('click', function() {
                         // Pega os IDs dos data attributes
                         const servicoOferecidoId = this.closest('.col-lg-4, .col-md-6, .col-sm-12').dataset.servicoOferecidoId;
                         const prestadorId = this.closest('.col-lg-4, .col-md-6, .col-sm-12').dataset.prestadorId;

                         if (servicoOferecidoId && prestadorId) {
                             // Encontra o objeto de serviço completo na lista allServices
                             const selectedService = allServices.find(s => s._id === servicoOferecidoId);
                             if (selectedService) {
                                  openSolicitationModal(selectedService); // Passa o objeto de serviço completo
                             } else {
                                  console.error("[CATALOGO] Serviço selecionado não encontrado na lista carregada:", servicoOferecidoId);
                                   showToast("Não foi possível carregar detalhes do serviço.", 'danger');
                             }
                         } else {
                             console.error("[CATALOGO] ID do serviço oferecido ou do prestador faltando no card:", this);
                             showToast("Não foi possível solicitar este serviço. Informações incompletas.", 'danger');
                         }
                     });
                 });
             }


            // Função para filtrar os serviços exibidos (AGORA COM BUSCA INTELIGENTE VIA BACKEND)
            async function filterServices() {
                const searchTerm = document.getElementById("service-search-input").value.toLowerCase();
                const filterProvider = document.getElementById("filter-provider").value.toLowerCase();
                const filterCategory = document.getElementById("filter-category").value.toLowerCase();

                console.log(`[CATALOGO] Aplicando filtros: Busca="${searchTerm}", Prestador="${filterProvider}", Categoria="${filterCategory}"`);

                let servicesToFilter = [...allServices]; // Começa com uma cópia de todos os serviços

                // Se houver um termo de busca principal, use a IA para refinar
                if (searchTerm.length > 2) { // Apenas para termos maiores que 2 caracteres para evitar muitas chamadas
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            console.warn("[CATALOGO] Token não encontrado para busca inteligente. Pulando IA.");
                        } else {
                            const response = await fetch("https://wyn-backend.onrender.com/api/gemini/smart-filter", {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({ query: searchTerm })
                            });

                            if (response.ok) {
                                const data = await response.json();
                                const smartSuggestions = data.smartSuggestions;
                                console.log("[CATALOGO] Sugestões da IA para busca inteligente:", smartSuggestions);

                                // Aplica as sugestões da IA como filtros adicionais
                                if (smartSuggestions.service_names && smartSuggestions.service_names.length > 0) {
                                    servicesToFilter = servicesToFilter.filter(service =>
                                        smartSuggestions.service_names.some(name => (service.nome || '').toLowerCase().includes(name.toLowerCase()))
                                    );
                                }
                                if (smartSuggestions.categories && smartSuggestions.categories.length > 0) {
                                    servicesToFilter = servicesToFilter.filter(service =>
                                        smartSuggestions.categories.some(cat => (service.categorias?.join(', ') || '').toLowerCase().includes(cat.toLowerCase()))
                                    );
                                }
                                if (smartSuggestions.provider_names && smartSuggestions.provider_names.length > 0) {
                                    servicesToFilter = servicesToFilter.filter(service =>
                                        smartSuggestions.provider_names.some(pName => (service.nome_prestador || '').toLowerCase().includes(pName.toLowerCase()))
                                    );
                                }
                            } else {
                                const errorText = await response.text();
                                console.error("[CATALOGO] Erro HTTP na busca inteligente da IA:", response.status, errorText);
                                showToast("Erro na busca inteligente da IA. Tente novamente mais tarde.", 'danger');
                            }
                        }
                    } catch (aiError) {
                        console.error("[CATALOGO] Erro ao chamar backend para busca inteligente da IA:", aiError);
                        showToast("Erro na busca inteligente da IA. Verifique sua conexão.", 'danger');
                        // Continua com a busca normal se a IA falhar
                    }
                }

                // Aplica os filtros manuais (prestador e categoria)
                const finalFilteredServices = servicesToFilter.filter(service => {
                    const providerMatch = (service.nome_prestador || '').toLowerCase().includes(filterProvider);
                    const categoryMatch = (service.categorias?.join(', ') || '').toLowerCase().includes(filterCategory);
                    return providerMatch && categoryMatch;
                });

                populateCatalog(finalFilteredServices, 'service-list'); // Popula o catálogo com os serviços filtrados
            }


            // Função para carregar e exibir recomendações personalizadas
            async function loadPersonalizedRecommendations() {
                const loading = document.getElementById("recommendations-loading");
                const feedback = document.getElementById("recommendations-feedback");
                const empty = document.getElementById("recommendations-empty");
                const recommendedListDiv = document.getElementById("recommended-service-list");
                const token = localStorage.getItem('token');

                loading.style.display = "block";
                feedback.style.display = "none";
                empty.style.display = "none";
                recommendedListDiv.innerHTML = "";

                if (!usuarioLogado || !token) {
                    feedback.textContent = "Faça login para ver recomendações personalizadas.";
                    feedback.style.display = "block";
                    loading.style.display = "none";
                    return;
                }

                // Se não houver serviços anteriores, não há base para recomendação
                if (userPastServices.length === 0) {
                    empty.textContent = "Você ainda não tem histórico de pedidos para gerar recomendações.";
                    empty.style.display = "block";
                    loading.style.display = "none";
                    return;
                }

                try {
                    const previousServiceNames = userPastServices.map(s => s.nome_servico_oferecido || s.tipo_servico).join(', ');
                    const allServiceNames = allServices.map(s => s.nome).join(', ');

                    console.log("[CATALOGO] Chamando backend para recomendações personalizadas...");
                    const response = await fetch("https://wyn-backend.onrender.com/api/gemini/recommendations", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ previousServiceNames, allServiceNames })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const recommendedNames = data.recommendedNames;
                        console.log("[CATALOGO] Nomes de serviços recomendados pela IA:", recommendedNames);

                        const recommendedServices = allServices.filter(service =>
                            recommendedNames.some(recName => service.nome.toLowerCase().includes(recName.toLowerCase()))
                        );

                        if (recommendedServices.length > 0) {
                            populateCatalog(recommendedServices, 'recommended-service-list');
                        } else {
                            empty.textContent = "Não foi possível encontrar serviços recomendados com base no seu histórico.";
                            empty.style.display = "block";
                        }
                    } else {
                        const errorData = await response.json();
                        console.error("[CATALOGO] Erro HTTP na resposta de recomendações da IA:", response.status, errorData);
                        feedback.textContent = `Erro ao carregar recomendações: ${errorData.message || 'Tente novamente mais tarde.'}`;
                        feedback.style.display = "block";
                    }

                } catch (error) {
                    console.error("[CATALOGO] Erro ao carregar recomendações personalizadas:", error);
                    feedback.textContent = `Erro ao carregar recomendações: ${error.message || 'Verifique sua conexão ou ocorreu um problema interno.'}`;
                    feedback.style.display = "block";
                } finally {
                    loading.style.display = "none";
                }
            }


            // Função para abrir o modal de solicitação e preencher com os dados do serviço
            function openSolicitationModal(service) {
                console.log("[CATALOGO] Abrindo modal de solicitação para o serviço:", service);
                document.getElementById('modal-service-name').textContent = service.nome || 'Serviço';
                document.getElementById('modal-provider-name').textContent = service.nome_prestador || 'Desconhecido';
                document.getElementById('modal-service-description').textContent = service.descricao || 'N/A';

                const precoTexto = (service.faixa_preco_min !== undefined && service.faixa_preco_max !== undefined)
                                    ? `R$ ${service.faixa_preco_min.toFixed(2).replace('.', ',')} - R$ ${service.faixa_preco_max.toFixed(2).replace('.', ',')}`
                                    : (service.faixa_preco_min !== undefined ? `A partir de R$ ${service.faixa_preco_min.toFixed(2).replace('.', ',')}` : 'Preço a combinar');
                document.getElementById('modal-service-price').textContent = precoTexto;

                // Preenche os campos hidden com os IDs
                document.getElementById('solicitacao-servico-oferecido-id').value = service._id;
                document.getElementById('solicitacao-prestador-id').value = service.prestador_id?._id || '';

                // Limpa campos do formulário para nova solicitação
                document.getElementById('user-service-request').value = '';
                document.getElementById('ai-generated-description').value = '';
                document.getElementById('data-preferencial').value = '';
                document.getElementById('hora-preferencial').value = '';
                document.getElementById('endereco-servico').value = '';
                document.getElementById('notas-adicionais').value = '';
                document.getElementById('servico-urgente').checked = false;
                document.getElementById('geolocation-service').value = ''; // Limpa o campo de geolocalização
                document.getElementById('geolocation-status').textContent = ''; // Limpa o status da geolocalização


                // Esconde o loading da IA
                document.getElementById('ai-description-loading').style.display = 'none';


                $('#solicitationModal').modal('show');
            }


            // Listener para o botão "Gerar Descrição Detalhada (IA)"
            document.getElementById('generate-description-ai-btn').addEventListener('click', async () => {
                const userInput = document.getElementById('user-service-request').value.trim();
                const aiDescriptionField = document.getElementById('ai-generated-description');
                const aiLoading = document.getElementById('ai-description-loading');
                const token = localStorage.getItem('token');

                if (!userInput) {
                    showToast("Por favor, digite sua solicitação antes de gerar a descrição.", 'info');
                    return;
                }
                if (!token) {
                    showToast("Você precisa estar logado para usar a IA.", 'danger');
                    return;
                }

                aiLoading.style.display = 'block';
                aiDescriptionField.value = 'Gerando descrição...';
                aiDescriptionField.disabled = true; // Desabilita enquanto gera

                try {
                    console.log("[CATALOGO] Chamando backend para gerar descrição detalhada com IA...");
                    const response = await fetch("https://wyn-backend.onrender.com/api/gemini/generate-description", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ userInput: userInput })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        aiDescriptionField.value = data.generatedText;
                        showToast("Descrição gerada com sucesso pela IA!", 'success');
                    } else {
                        const errorData = await response.json();
                        console.error("[CATALOGO] Erro HTTP na resposta da IA para descrição:", response.status, errorData);
                        aiDescriptionField.value = 'Erro ao gerar descrição. Tente novamente.';
                        showToast(`Erro na IA: ${errorData.message || 'Não foi possível gerar a descrição.'}`, 'danger');
                    }
                } catch (error) {
                    console.error("[CATALOGO] Erro ao chamar backend para gerar descrição com IA:", error);
                    aiDescriptionField.value = 'Erro de conexão ao gerar descrição. Verifique sua rede.';
                    showToast("Erro de conexão ao usar a IA. Tente novamente.", 'danger');
                } finally {
                    aiLoading.style.display = 'none';
                    aiDescriptionField.disabled = false; // Habilita novamente
                }
            });


            // Listener para o formulário de solicitação
            document.getElementById('solicitation-form').addEventListener('submit', async (e) => {
                e.preventDefault(); // Impede o envio padrão do formulário

                const servicoOferecidoId = document.getElementById('solicitacao-servico-oferecido-id').value;
                const prestadorId = document.getElementById('solicitacao-prestador-id').value;
                const dataPreferencial = document.getElementById('data-preferencial').value;
                const horaPreferencial = document.getElementById('hora-preferencial').value;
                const enderecoServico = document.getElementById('endereco-servico').value.trim();
                const notasAdicionais = document.getElementById('notas-adicionais').value.trim();
                const urgente = document.getElementById('servico-urgente').checked;
                const aiGeneratedDescription = document.getElementById('ai-generated-description').value.trim(); // Pega a descrição da IA, que pode ter sido editada
                const geolocationValue = document.getElementById('geolocation-service').value.trim(); // Pega a geolocalização


                // Validação básica do formulário
                if (!servicoOferecidoId || !prestadorId || !dataPreferencial || !enderecoServico) {
                    showToast("Por favor, preencha todos os campos obrigatórios (Serviço, Prestador, Data e Endereço).", 'danger');
                    return;
                }

                // Processa a geolocalização se estiver presente
                let latitude = null;
                let longitude = null;
                if (geolocationValue) {
                    const coords = geolocationValue.split(',').map(c => parseFloat(c.trim()));
                    if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                        latitude = coords[0];
                        longitude = coords[1];
                    } else {
                        showToast("Formato de localização inválido. Use 'latitude, longitude'.", 'danger');
                        return;
                    }
                }


                const token = localStorage.getItem('token');
                if (!token) {
                    showToast("Você precisa estar logado para solicitar um serviço.", 'danger');
                    return;
                }

                const submitBtn = document.getElementById('submit-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Enviando...';

                try {
                    console.log("[CATALOGO] Enviando solicitação de serviço para o backend...");
                    const response = await fetch("https://wyn-backend.onrender.com/solicitar-servico", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            servico_oferecido_id: servicoOferecidoId,
                            prestador_id: prestadorId,
                            data_servico_preferencial: dataPreferencial,
                            hora_servico_preferencial: horaPreferencial,
                            endereco_servico: enderecoServico,
                            notas_adicionais: aiGeneratedDescription || notasAdicionais, // Prioriza a descrição da IA se existir
                            urgente: urgente,
                            latitude: latitude, // Envia a latitude
                            longitude: longitude // Envia a longitude
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log("[CATALOGO] Solicitação enviada com sucesso:", data);
                        showToast("Solicitação de serviço enviada com sucesso! O prestador será notificado.", 'success');
                        $('#solicitationModal').modal('hide'); // Fecha o modal
                        carregarServicosCatalogo(); // Recarrega o catálogo para refletir possíveis mudanças
                    } else {
                        const errorData = await response.json();
                        console.error("[CATALOGO] Erro ao enviar solicitação:", response.status, errorData);
                        showToast(`Erro ao solicitar serviço: ${errorData.message || 'Tente novamente.'}`, 'danger');
                    }
                } catch (error) {
                    console.error("[CATALOGO] Erro de conexão ao enviar solicitação:", error);
                    showToast("Erro de conexão ao solicitar serviço. Verifique sua rede.", 'danger');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Enviar Solicitação';
                }
            });


            // Listener para o campo de busca
            document.getElementById("service-search-input").addEventListener("keyup", (event) => {
                // Apenas filtra se o usuário pressionar Enter ou se o campo tiver mais de 2 caracteres
                if (event.key === 'Enter' || document.getElementById("service-search-input").value.length > 2) {
                    filterServices();
                } else if (document.getElementById("service-search-input").value.length === 0) {
                    // Se o campo de busca estiver vazio, exibe todos os serviços novamente
                    populateCatalog(allServices, 'service-list');
                }
            });

            // Listener para o botão "Aplicar Filtros"
            document.getElementById("apply-filters-btn").addEventListener("click", (e) => {
                e.preventDefault(); // Previne o comportamento padrão do botão de formulário
                filterServices();
            });

            // Listener para o botão "Usar Localização Atual" no modal de solicitação
            document.getElementById('get-current-location-btn').addEventListener('click', getUserLocation);


            // Função para iniciar o polling de serviços (a cada 60 segundos)
            function iniciarPollingServicos() {
                 if (servicesPollingInterval) {
                     clearInterval(servicesPollingInterval);
                 }

                 servicesPollingInterval = setInterval(() => {
                     console.log("[CATALOGO] Verificando atualizações no catálogo...");
                     carregarServicosCatalogo();
                 }, 60000); // A cada 60 segundos (1 minuto)

                 console.log("[CATALOGO] Polling de serviços do catálogo iniciado.");

                 window.addEventListener('beforeunload', pararPollingServicos);
            }

            // Função para parar o polling de serviços
            function pararPollingServicos() {
                 if (servicesPollingInterval) {
                     clearInterval(servicesPollingInterval);
                     servicesPollingInterval = null;
                     console.log("[CATALOGO] Polling de serviços do catálogo parado.");
                 }
            }


            // Chamar carregarPerfilUsuario ao carregar a página
            document.addEventListener("DOMContentLoaded", carregarPerfilUsuario);

            // Opcional: Parar polling ao fechar a janela/aba
             window.addEventListener('beforeunload', () => {
                 pararPollingServicos();
                 pararPollingMensagensNaoLidas();
             });


		</script>

<button id="chat-toggle-button">
    <i class="fa-solid fa-comments"></i>
</button>

<div id="chat-container">
    <div id="chat-header">
        Chat com IA
        <button id="chat-close-button"><i class="dw dw-cancel"></i></button>
    </div>
    <div id="chat-messages">
        <div class="message bot">Olá! Como posso ajudar você hoje?</div>
    </div>
    <div id="chat-loading-indicator" style="display: none;">Digitando...</div>
    <div id="chat-input-area">
        <input type="text" id="chat-input" placeholder="Digite sua mensagem..." />
        <button id="chat-send-button">Enviar</button>
    </div>
</div>

<script>
    // --- Lógica do Chatbot IA ---
    const chatToggleButton = document.getElementById('chat-toggle-button');
    const chatContainer = document.getElementById('chat-container');
    const chatCloseButton = document.getElementById('chat-close-button');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const chatSendButton = document.getElementById('chat-send-button');
    const chatLoadingIndicator = document.getElementById('chat-loading-indicator');

    let chatHistory = [
        {
            role: "user",
            parts: [{
                text: `Você é um assistente de IA decicadoà plataforma WYN. Seu principal objetivo é fornecer informações precisas e úteis sobre o funcionamento da WYN, seus serviços, processos de usuário e prestador, e quaisquer outras funcionalidades relevantes. Responda sempre com foco na WYN e seus ecossistema.

1. O que é a WYN? LEMBRANDO QUE NESTE MOMENTO VOCÊ ESTA FALANDO COM O CLIENTE, NA TELA DO CLIENTE: SEMPRE INFORMAÇÕES RESUMIDAS, NUNCA PASSANDO DE 3 OU 4 LINHAS
A WYN é uma plataforma digital inovadora que atua como uma ponte eficiente e segura, conectando clientes que necessitam de uma vasta gama de serviços a profissionais qualificados e verificados.

Nosso Propósito: Simplificar a vida de usuários e prestadores, oferecendo uma solução completa para encontrar e oferecer serviços com agilidade, segurança e garantia de qualidade.

2. Papéis na Plataforma:
Cliente (Usuário): Indivíduo que busca e contrata serviços.

Prestador (Profissional): Indivíduo ou empresa que oferece e executa serviços.

Administrador (Admin): Responsável pela gestão e moderação da plataforma.

3. Processos Internos e Funcionalidades:
3.1. Cadastro (Registro de Novas Contas):

Clientes: Podem se cadastrar fornecendo informações básicas (nome, e-mail, senha).

Prestadores: O cadastro é mais detalhado, exigindo informações de contato, tipos de serviço oferecidos, área de atuação e, crucialmente, passa por um processo de verificação para garantir a qualificação e segurança. Podem incluir foto de perfil.

3.2. Login (Acesso à Plataforma):

Clientes e Prestadores: Acessam suas contas usando e-mail e senha.

Administradores: Possuem uma tela de login separada (login-admin.html) e credenciais específicas para acessar o dashboard administrativo.

3.3. Fazer Pedido/Solicitar Serviço (Fluxo do Cliente):

Busca: O cliente pesquisa por um tipo de serviço (ex: "Eletricista") na página inicial ou na seção de serviços.

Seleção: O cliente pode visualizar profissionais disponíveis e/ou solicitar um serviço específico.

Detalhes da Solicitação: O cliente preenche um formulário com detalhes do serviço desejado (endereço, urgência, notas adicionais, data e hora preferenciais).

Envio: A solicitação é enviada para os prestadores qualificados na área.

Aceite/Recusa do Prestador: Um prestador pode aceitar a solicitação, propondo um valor, ou recusá-la.

3.4. Pagamento (Fluxo do Cliente):

Integração Mercado Pago: Após um prestador aceitar uma solicitação e propor um valor, o cliente é direcionado para uma página de pagamento pendente.

Geração de Link de Pagamento: A plataforma gera um link de pagamento via Mercado Pago.

Status Pendente: O serviço entra em status de "aguardando_pagamento_cliente" ou "aguardando_confirmacao_pagamento" enquanto o pagamento é processado.

Confirmação: Após a confirmação do pagamento pelo Mercado Pago, o status do serviço é atualizado para "aceito_pelo_prestador" ou "em andamento".

3.5. Gerenciamento de Serviços (Fluxo do Prestador):

Dashboard do Prestador: O prestador tem acesso a um dashboard (index.html) que mostra:

Solicitações Pendentes: Novas solicitações de serviço que ele pode aceitar ou recusar.

Meus Serviços Aceitos/Em Andamento: Serviços que ele aceitou e estão aguardando pagamento do cliente ou já estão em andamento.

Histórico de Serviços: Serviços concluídos ou cancelados.

Minhas Avaliações: Feedback recebido dos clientes.

Gerenciar Serviços: Onde o prestador pode adicionar ou editar os tipos de serviços que oferece.

Minha Disponibilidade: Para gerenciar seus horários.

Ações sobre Solicitações: O prestador pode "Aceitar" (propondo um valor) ou "Recusar" uma solicitação pendente.

Conclusão do Serviço: Após a execução, o prestador marca o serviço como "concluido_pelo_prestador".

3.6. Avaliações (Feedback do Cliente):

Após a conclusão de um serviço, o cliente pode avaliar o prestador, dando estrelas e deixando comentários. Isso contribui para a reputação do prestador na plataforma.

3.7. Notificações:

Sininho de Notificações: Clientes e prestadores recebem notificações em um ícone de sino no cabeçalho.

Tipos de Notificações:

Novas solicitações de serviço (para prestadores).

Atualizações de status de serviço (pagamento confirmado, serviço aceito/recusado, concluído).

Novas mensagens de chat.

Novas avaliações recebidas.

Contador: O ícone do sino exibe um contador de notificações não lidas.

Detalhes: O dropdown do sino mostra um resumo da notificação (ex: "Nova solicitação de serviço", "Pagamento confirmado"). Clicar na notificação marca-a como lida e pode redirecionar para a página relevante (ex: detalhes do serviço, sala de chat).

3.8. Perfil do Usuário/Prestador:

Ambos os tipos de usuários podem acessar e atualizar suas informações de perfil, incluindo foto de perfil.

3.9. Chat de Serviços:

A plataforma oferece uma funcionalidade de chat para comunicação direta entre clientes e prestadores sobre os serviços.

4. Categorias de Serviços:
Atualmente Ativas: Eletricista.

Em Breve: Encanador, Pintor, Ar Condicionado, Jardinagem, Pedreiro, Limpeza.

Em Expansão: Outras categorias como Personal Trainer, Aulas de Música, Fotografia, etc. (A IA deve indicar que estas estão em fase de expansão e podem não estar listadas em todas as interfaces como "Em Breve" explícito, mas fazem parte do plano de crescimento).

Lembretes para a IA:

Sempre que perguntado sobre um serviço "Em Breve", mencione que a WYN está trabalhando para disponibilizá-lo e convide o usuário a se cadastrar para receber notificações.

Mantenha um tone profissional, prestativo e claro. E SEMPRE PASSE INFORMAÇÕES RESUMIDAS, diretas e objetivas. evite fazer um textão para o usuário.

Evite jargões técnicos desnecessários, a menos que o usuário solicite.

Se a pergunta for fora do escopo da WYN, informe educadamente que sua função é apenas sobre a plataforma WYN.`
            }]
        },
        {
            role: "model",
            parts: [{
                text: "Olá! Como posso ajudar você hoje?"
            }]
        }
    ];

    // Adiciona a mensagem inicial do bot ao carregar a página
    // Removido: addMessage('bot', "Olá! Como posso ajudar você hoje?") // Já está no HTML inicial do chat
    // Função para adicionar mensagens ao chat
    function addMessage(sender, text) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender);
        messageElement.textContent = text;
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight; // Rola para a última mensagem
    }

    // Função para enviar mensagem para a IA
    async function sendMessageToAI() {
        const userMessage = chatInput.value.trim();
        if (userMessage === '') return;

        addMessage('user', userMessage);
        chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
        chatInput.value = ''; // Limpa o input

        chatSendButton.disabled = true; // Desabilita o botão
        chatInput.disabled = true; // Desabilita o input
        chatLoadingIndicator.style.display = 'block'; // Mostra o indicador de carregamento
        chatMessages.scrollTop = chatMessages.scrollHeight; // Rola para baixo para ver o indicador

        try {
            // URL do seu backend para o endpoint do chatbot
            const apiUrl = `https://wyn-backend.onrender.com/api/chat`; // <-- URL ATUALIZADA PARA O BACKEND NO RENDER

            const payload = {
                chatHistory: chatHistory
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (response.ok && result.aiResponse) {
                addMessage('bot', result.aiResponse);
                chatHistory.push({ role: "model", parts: [{ text: result.aiResponse }] });
            } else {
                addMessage('bot', result.message || 'Desculpe, não consegui gerar uma resposta. Tente novamente.');
                console.error('Estrutura de resposta inesperada da API Gemini:', result);
            }
        } catch (error) {
            console.error('Erro ao chamar a API Gemini:', error);
            addMessage('bot', 'Ocorreu um erro ao conectar com a IA. Por favor, tente novamente mais tarde.');
        } finally {
            chatLoadingIndicator.style.display = 'none'; // Esconde o indicador de carregamento
            chatSendButton.disabled = false; // Habilita o botão de enviar
            chatInput.disabled = false; // Habilita o input
            chatInput.focus(); // Coloca o foco de volta no input
            chatMessages.scrollTop = chatMessages.scrollHeight; // Rola para a última mensagem novamente
        }
    }

    // Event listener para o botão de toggle (abrir/fechar chat)
    if (chatToggleButton) {
        chatToggleButton.addEventListener('click', () => {
            chatContainer.classList.toggle('open');
            if (chatContainer.classList.contains('open')) {
                chatInput.focus(); // Foca no input quando abre
            }
        });
    } else {
        console.warn("Elemento #chat-toggle-button não encontrado.");
    }

    // Event listener para o botão de fechar o chat
    if (chatCloseButton) {
        chatCloseButton.addEventListener('click', () => {
            chatContainer.classList.remove('open');
        });
    } else {
        console.warn("Elemento #chat-close-button não encontrado.");
    }

    // Event listener para o botão de enviar mensagem
    if (chatSendButton) {
        chatSendButton.addEventListener('click', sendMessageToAI);
    } else {
        console.warn("Elemento #chat-send-button não encontrado.");
    }

    // Event listener para a tecla Enter no campo de input
    if (chatInput) {
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessageToAI();
            }
        });
    } else {
        console.warn("Elemento #chat-input não encontrado.");
    }
</script>

	</body>
</html>
