<!doctype html>
<html lang="pt-br">
<head>
    <title>WYN - Login Prestador</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/w/1.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/w/1.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/w/1.png" />
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://unicons.iconscout.com/release/v2.1.9/css/unicons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="login.css">
</head>
<body>
    <header>
        <nav>
            <a href="https://bright-douhua-66bc14.netlify.app/" class="Logo">WYN</a>
        </nav>
    </header>

    <div class="section">
        <div class="container">
            <div class="row full-height justify-content-center">
                <div class="col-12 text-center align-self-center py-5">
                    <div class="section pb-5 pt-5 pt-sm-2 text-center">
                        <h6 class="#"><span>Login Prestador </span><span>Cadastre-se Prestador</span></h6>
                        <input class="checkbox" type="checkbox" id="reg-log" name="reg-log" />
                        <label for="reg-log"></label>
                        <div class="card-3d-wrap mx-auto">
                            <div class="card-3d-wrapper">
                                <div class="card-front">
                                    <div class="center-wrap">
                                        <div class="section text-center">
                                            <h4 class="mb-4 pb-3">Login Prestador</h4>
                                            <div class="form-group">
                                                <input type="email" class="form-style" placeholder="Email Prestador" name="emailPrestador" required>
                                                <i class="input-icon uil uil-at"></i>
                                            </div>
                                            <div class="form-group mt-2">
                                                <input type="password" class="form-style" placeholder="Senha Prestador" name="senhaPrestador" required>
                                                <i class="input-icon uil uil-lock-alt"></i>
                                            </div>
                                            <button class="btn mt-4" id="btnLoginPrestador">Login</button>
                                             <p class="mb-0 mt-4 text-center"><a href="forgot-password.html" class="link">Esqueceu sua senha?</a></p>
                                        </div>
                                    </div>
                                </div>

                                <div class="card-back">
                                    <div class="center-wrap">
                                        <div class="section text-center">
                                            <h4 class="mb-3 pb-3">Cadastre-se Prestador</h4>
                                            <form id="formCadastroPrestador">
                                                <div class="form-group">
                                                    <input type="text" class="form-style" placeholder="Nome Completo Prestador" name="nomePrestador" required>
                                                    <i class="input-icon uil uil-user"></i>
                                                </div>
                                                <div class="form-group mt-2">
                                                    <input type="text" class="form-style" placeholder="CPF (somente n\u00fameros)" name="cpfPrestador" required pattern="\d{11}" title="CPF deve conter 11 d\u00edgitos num\u00e9ricos">
                                                    <i class="input-icon uil uil-postcard"></i>
                                                </div>
                                                <div class="form-group mt-2">
                                                    <label for="dataNascimentoPrestador" class="form-label" style="color: #c4c3ca; text-align: left; display: block;">Data de Nascimento</label>
                                                    <input type="date" class="form-style" id="dataNascimentoPrestador" name="dataNascimentoPrestador" required>
                                                </div>
                                                <div class="form-group mt-2">
                                                    <input type="tel" class="form-style" placeholder="Telefone (ex: 11987654321)" name="telefonePrestador" required pattern="[0-9]{10,11}" title="Telefone deve conter 10 ou 11 d\u00edgitos num\u00e9ricos">
                                                    <i class="input-icon uil uil-phone"></i>
                                                </div>
                                                <div class="form-group mt-2">
                                                    <input type="email" class="form-style" placeholder="Email Prestador" name="emailCadastroPrestador" required>
                                                    <i class="input-icon uil uil-at"></i>
                                                </div>
                                                <div class="form-group mt-2">
                                                    <input type="password" class="form-style" placeholder="Senha Prestador" name="senhaCadastroPrestador" required>
                                                    <i class="input-icon uil uil-lock-alt"></i>
                                                </div>

                                                <h5 class="mb-2 mt-4 pb-1" style="color: #ff9900;">Endere\u00e7o</h5>
                                                <div class="form-group mt-2">
                                                    <input type="text" class="form-style" placeholder="CEP" name="cepPrestador" required pattern="\d{8}" title="CEP deve conter 8 d\u00edgitos num\u00e9ricos">
                                                    <i class="input-icon uil uil-map-marker"></i>
                                                </div>
                                                <div class="form-group mt-2">
                                                    <input type="text" class="form-style" placeholder="Rua" name="ruaPrestador" required>
                                                    <i class="input-icon uil uil-map-marker-alt"></i>
                                                </div>
                                                <div class="form-group mt-2">
                                                    <input type="text" class="form-style" placeholder="N\u00famero" name="numeroEnderecoPrestador" required>
                                                    <i class="input-icon uil uil-location-pin-alt"></i>
                                                </div>
                                                <div class="form-group mt-2">
                                                    <input type="text" class="form-style" placeholder="Bairro" name="bairroPrestador" required>
                                                    <i class="input-icon uil uil-compass"></i>
                                                </div>
                                                <div class="form-group mt-2">
                                                    <input type="text" class="form-style" placeholder="Cidade" name="cidadePrestador" required>
                                                    <i class="input-icon uil uil-city"></i>
                                                </div>
                                                <div class="form-group mt-2">
                                                    <input type="text" class="form-style" placeholder="Estado (UF)" name="estadoPrestador" required maxlength="2">
                                                    <i class="input-icon uil uil-globe"></i>
                                                </div>

                                                <h5 class="mb-2 mt-4 pb-1" style="color: #ff9900;">Documentos e Fotos</h5>
                                                <div class="form-group mt-2 text-left">
                                                    <label for="foto_perfil_prestador" class="form-label" style="color: #c4c3ca;">Foto de Perfil (Opcional)</label>
                                                    <input type="file" class="form-control-file" id="foto_perfil_prestador" name="foto_perfil" accept="image/*">
                                                </div>
                                                <div class="form-group mt-2 text-left">
                                                    <label for="foto_selfie_documento" class="form-label" style="color: #c4c3ca;">Foto do Rosto com Documento em M\u00e3os (Obrigat\u00f3rio)</label>
                                                    <input type="file" class="form-control-file" id="foto_selfie_documento" name="fotoSelfieDocumento" accept="image/*" required>
                                                </div>
                                                <div class="form-group mt-2 text-left">
                                                    <label for="foto_documento" class="form-label" style="color: #c4c3ca;">Foto do Documento com Foto (RG ou CNH - Obrigat\u00f3rio)</label>
                                                    <input type="file" class="form-control-file" id="foto_documento" name="fotoDocumento" accept="image/*" required>
                                                </div>

                                                <h5 class="mb-2 mt-4 pb-1" style="color: #ff9900;">Certifica\u00e7\u00e3o/Curso</h5>
                                                <div class="form-group mt-2">
                                                    <input type="text" class="form-style" placeholder="Certifica\u00e7\u00e3o ou Curso na \u00e1rea (Opcional)" name="certificacaoPrestador">
                                                    <i class="input-icon uil uil-graduation-cap"></i>
                                                </div>

                                                <h5 class="mb-2 mt-4 pb-1" style="color: #ff9900;">Dados para Recebimento</h5>
                                                <div class="form-group mt-2 text-left">
                                                    <label style="color: #c4c3ca;">M\u00e9todo de Recebimento:</label><br>
                                                    <input type="radio" id="radioContaBancaria" name="tipoRecebimento" value="contaBancaria" checked>
                                                    <label for="radioContaBancaria" style="color: #c4c3ca; margin-left: 5px;">Conta Banc\u00e1ria</label>
                                                    <input type="radio" id="radioChavePix" name="tipoRecebimento" value="chavePix" style="margin-left: 20px;">
                                                    <label for="radioChavePix" style="color: #c4c3ca; margin-left: 5px;">Chave Pix</label>
                                                </div>

                                                <div id="camposContaBancaria">
                                                    <div class="form-group mt-2">
                                                        <input type="text" class="form-style" placeholder="Banco" name="bancoPrestador">
                                                        <i class="input-icon uil uil-building"></i>
                                                    </div>
                                                    <div class="form-group mt-2">
                                                        <input type="text" class="form-style" placeholder="Ag\u00eancia" name="agenciaPrestador">
                                                        <i class="input-icon uil uil-money-bill"></i>
                                                    </div>
                                                    <div class="form-group mt-2">
                                                        <input type="text" class="form-style" placeholder="Conta" name="contaPrestador">
                                                        <i class="input-icon uil uil-credit-card"></i>
                                                    </div>
                                                    <div class="form-group mt-2">
                                                        <input type="text" class="form-style" placeholder="Tipo de Conta (Corrente/Poupan\u00e7a)" name="tipoContaPrestador">
                                                        <i class="input-icon uil uil-wallet"></i>
                                                    </div>
                                                </div>

                                                <div id="camposChavePix" style="display: none;">
                                                    <div class="form-group mt-2">
                                                        <select class="form-style" name="tipoChavePixPrestador">
                                                            <option value="">Selecione o Tipo de Chave Pix</option>
                                                            <option value="cpf">CPF</option>
                                                            <option value="cnpj">CNPJ</option>
                                                            <option value="email">Email</option>
                                                            <option value="telefone">Telefone</option>
                                                            <option value="aleatoria">Chave Aleat\u00f3ria</option>
                                                        </select>
                                                        <i class="input-icon uil uil-qrcode-scan"></i>
                                                    </div>
                                                    <div class="form-group mt-2">
                                                        <input type="text" class="form-style" placeholder="Chave Pix" name="chavePixPrestador">
                                                        <i class="input-icon uil uil-key-skeleton"></i>
                                                    </div>
                                                </div>

                                                <h5 class="mb-2 mt-4 pb-1" style="color: #ff9900;">Pol\u00edtica de Cancelamento/Reagendamento</h5>
                                                <div class="form-group mt-2">
                                                    <select class="form-style" id="politicaCancelamentoTipo" name="politicaCancelamentoTipo" required>
                                                        <option value="">Selecione a Pol\u00edtica</option>
                                                        <option value="padrao">Padr\u00e3o da Plataforma</option>
                                                        <option value="personalizada">Personalizada</option>
                                                    </select>
                                                    <i class="input-icon uil uil-file-alt"></i>
                                                </div>
                                                <div class="form-group mt-2" id="campoPoliticaPersonalizada" style="display: none;">
                                                    <textarea class="form-style" placeholder="Descreva sua pol\u00edtica personalizada" name="politicaCancelamentoPersonalizada" rows="4"></textarea>
                                                </div>

                                                <button type="submit" class="btn mt-4" id="btnCadastrarPrestador">Cadastrar</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Obter a URL base do backend do ambiente (se definida) ou usar localhost para desenvolvimento
        const BACKEND_BASE_URL = 'https://wyn-backend.onrender.com'; // Sua URL do Render

        // Listener para o Login de Prestador (AJUSTADO)
        document.getElementById('btnLoginPrestador').addEventListener('click', async (e) => { // Alterado ID
            e.preventDefault();
            const email = document.querySelector('input[name="emailPrestador"]').value; // Alterado nome do input
            const senha = document.querySelector('input[name="senhaPrestador"]').value; // Alterado nome do input

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/login-prestador`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, senha })
                });

                // Clonar a resposta antes de tentar ler o JSON
                const responseClone = response.clone();
                let data;
                try {
                     data = await response.json();
                } catch (jsonError) {
                     const textError = await responseClone.text();
                     console.error("Erro ao parsear JSON da resposta de login:", textError);
                     // Lança um erro customizado ou usa uma mensagem padrão
                     throw new Error(`Resposta inv\u00e1lida do servidor (${response.status}). Detalhes: ${textError.substring(0, 100)}...`);
                }


                if (response.ok && data.token && data.prestador) { // *** Verifica por 'prestador' nos dados ***
                    localStorage.setItem("token", data.token);
                    // *** SALVANDO O OBJETO 'prestador' CORRETO, que agora inclui foto_perfil_url ***
                    localStorage.setItem("prestador", JSON.stringify(data.prestador));

                    // Substitu\u00eddo alert por console.log para evitar bloqueio em alguns ambientes
                    console.log(data.message);
                    // Redireciona para a p\u00e1gina inicial do prestador
                    window.location.href = "index.html"; // Ajuste o nome da p\u00e1gina se for diferente

                } else {
                    // Se o backend retornou um erro esperado (ex: 401 Unauthorized)
                    // Substitu\u00eddo alert por console.error para evitar bloqueio em alguns ambientes
                    console.error(data.message || "Credenciais inv\u00e1lidas ou erro ao fazer login.");
                }
            } catch (error) {
                console.error("Erro na requisi\u00e7\u00e3o de login:", error);
                 // Se o erro for a nossa mensagem customizada do parse JSON, mostre-a.
                 // Caso contr\u00e1rio, mostre uma mensagem de erro de conex\u00e3o.
                console.error(error.message.startsWith("Resposta inv\u00e1lida") ? error.message : "Erro ao conectar ao servidor de login.");
            }
        });

        // Fun\u00e7\u00e3o para validar se o usu\u00e1rio \u00e9 maior de 18 anos
        function isAdult(dateString) {
            const birthDate = new Date(dateString);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age >= 18;
        }

        // Listener para o Cadastro de Prestador (AJUSTADO)
        document.getElementById('formCadastroPrestador').addEventListener('submit', async (e) => { // Alterado ID
            e.preventDefault();
            const form = e.target;
            const btnCadastrar = document.getElementById('btnCadastrarPrestador');

            // Crie um objeto FormData para enviar os dados do formul\u00e1rio, incluindo o arquivo
            const formData = new FormData();

            // Adiciona os campos de texto manualmente com os NOMES ESPERADOS PELO BACKEND
            formData.append('nome', form.querySelector('input[name="nomePrestador"]').value);
            formData.append('cpf', form.querySelector('input[name="cpfPrestador"]').value);
            formData.append('dataNascimento', form.querySelector('input[name="dataNascimentoPrestador"]').value);
            formData.append('telefone', form.querySelector('input[name="telefonePrestador"]').value);
            formData.append('email', form.querySelector('input[name="emailCadastroPrestador"]').value);
            formData.append('senha', form.querySelector('input[name="senhaCadastroPrestador"]').value);

            // Adiciona campos de endere\u00e7o
            formData.append('cep', form.querySelector('input[name="cepPrestador"]').value);
            formData.append('rua', form.querySelector('input[name="ruaPrestador"]').value);
            formData.append('numeroEndereco', form.querySelector('input[name="numeroEnderecoPrestador"]').value);
            formData.append('bairro', form.querySelector('input[name="bairroPrestador"]').value);
            formData.append('cidade', form.querySelector('input[name="cidadePrestador"]').value);
            formData.append('estado', form.querySelector('input[name="estadoPrestador"]').value);

            // Adiciona certifica\u00e7\u00e3o (opcional)
            const certificacao = form.querySelector('input[name="certificacaoPrestador"]').value;
            if (certificacao) {
                formData.append('certificacao', certificacao);
            }

            // Adiciona dados de recebimento (conta banc\u00e1ria ou pix)
            const tipoRecebimento = document.querySelector('input[name="tipoRecebimento"]:checked').value;
            formData.append('tipoRecebimento', tipoRecebimento);

            if (tipoRecebimento === 'contaBancaria') {
                formData.append('banco', form.querySelector('input[name="bancoPrestador"]').value);
                formData.append('agencia', form.querySelector('input[name="agenciaPrestador"]').value);
                formData.append('conta', form.querySelector('input[name="contaPrestador"]').value);
                formData.append('tipoConta', form.querySelector('input[name="tipoContaPrestador"]').value);
            } else if (tipoRecebimento === 'chavePix') {
                formData.append('tipoChavePix', form.querySelector('select[name="tipoChavePixPrestador"]').value);
                formData.append('chavePix', form.querySelector('input[name="chavePixPrestador"]').value);
            }

            // Adiciona pol\u00edtica de cancelamento
            const politicaCancelamentoTipo = form.querySelector('select[name="politicaCancelamentoTipo"]').value;
            formData.append('politicaCancelamentoTipo', politicaCancelamentoTipo);
            if (politicaCancelamentoTipo === 'personalizada') {
                formData.append('politicaCancelamentoPersonalizada', form.querySelector('textarea[name="politicaCancelamentoPersonalizada"]').value);
            }

            // Adiciona os arquivos de foto se eles existirem
            const fotoPerfilInput = form.querySelector('input[name="foto_perfil"]');
            if (fotoPerfilInput.files && fotoPerfilInput.files[0]) {
                 formData.append('foto_perfil', fotoPerfilInput.files[0]); // O backend espera 'foto_perfil'
            }

            const fotoSelfieDocumentoInput = form.querySelector('input[name="fotoSelfieDocumento"]');
            if (fotoSelfieDocumentoInput.files && fotoSelfieDocumentoInput.files[0]) {
                formData.append('fotoSelfieDocumento', fotoSelfieDocumentoInput.files[0]);
            }

            const fotoDocumentoInput = form.querySelector('input[name="fotoDocumento"]');
            if (fotoDocumentoInput.files && fotoDocumentoInput.files[0]) {
                formData.append('fotoDocumento', fotoDocumentoInput.files[0]);
            }

            // Valida\u00e7\u00f5es client-side
            const dataNascimento = form.querySelector('input[name="dataNascimentoPrestador"]').value;
            if (!isAdult(dataNascimento)) {
                console.error("O prestador deve ter 18 anos ou mais.");
                btnCadastrar.disabled = false;
                btnCadastrar.textContent = 'Cadastrar';
                return;
            }

            const cpf = form.querySelector('input[name="cpfPrestador"]').value;
            if (!/^\d{11}$/.test(cpf)) {
                console.error("CPF inv\u00e1lido. Deve conter 11 d\u00edgitos num\u00e9ricos.");
                btnCadastrar.disabled = false;
                btnCadastrar.textContent = 'Cadastrar';
                return;
            }

            if (!fotoSelfieDocumentoInput.files || !fotoSelfieDocumentoInput.files[0]) {
                console.error("Por favor, envie a foto do rosto com documento em m\u00e3os.");
                btnCadastrar.disabled = false;
                btnCadastrar.textContent = 'Cadastrar';
                return;
            }
            if (!fotoDocumentoInput.files || !fotoDocumentoInput.files[0]) {
                console.error("Por favor, envie a foto do documento com foto (RG ou CNH).");
                btnCadastrar.disabled = false;
                btnCadastrar.textContent = 'Cadastrar';
                return;
            }

            btnCadastrar.disabled = true; // Desabilita o bot\u00e3o
            btnCadastrar.textContent = 'Cadastrando...';

            try {
                 const response = await fetch(`${BACKEND_BASE_URL}/cadastrar-prestador`, { // Endpoint de CADASTRO DE PRESTADOR
                     method: 'POST',
                     // N\u00e3o defina o cabe\u00e7alho 'Content-Type' manualmente ao usar FormData.
                     // O navegador definir\u00e1 automaticamente como 'multipart/form-data' com o boundary correto.
                     body: formData // Envia o objeto FormData
                 });

                 const responseClone = response.clone();
                 let data;
                 try {
                      data = await response.json();
                 } catch(jsonError) {
                      const textError = await responseClone.text();
                      console.error("Erro ao parsear JSON da resposta de cadastro:", textError);
                      throw new Error(`Resposta inv\u00e1lida do servidor (${response.status}). Detalhes: ${textError.substring(0, 100)}...`);
                 }

                 console.log(data.message);
                 if(response.ok) {
                      form.reset(); // Limpa o formul\u00e1rio em caso de sucesso
                      // Opcional: Redirecionar para login ap\u00f3s sucesso
                      // window.location.href = "login-prestador.html"; // Redireciona para login
                 }

            } catch (error) {
                 console.error("Erro na requisi\u00e7\u00e3o de cadastro:", error);
                 console.error(error.message.startsWith("Resposta inv\u00e1lida") ? error.message : "Erro ao conectar ao servidor de cadastro.");
            } finally {
                btnCadastrar.disabled = false; // Reabilita o bot\u00e3o
                btnCadastrar.textContent = 'Cadastrar';
            }
        });

        // L\u00f3gica para mostrar/esconder campos de Conta Banc\u00e1ria ou Chave Pix
        document.addEventListener('DOMContentLoaded', () => {
            const radioContaBancaria = document.getElementById('radioContaBancaria');
            const radioChavePix = document.getElementById('radioChavePix');
            const camposContaBancaria = document.getElementById('camposContaBancaria');
            const camposChavePix = document.getElementById('camposChavePix');

            function toggleRecebimentoFields() {
                if (radioContaBancaria.checked) {
                    camposContaBancaria.style.display = 'block';
                    camposChavePix.style.display = 'none';
                } else if (radioChavePix.checked) {
                    camposContaBancaria.style.display = 'none';
                    camposChavePix.style.display = 'block';
                }
            }

            radioContaBancaria.addEventListener('change', toggleRecebimentoFields);
            radioChavePix.addEventListener('change', toggleRecebimentoFields);

            // Inicializa a exibi\u00e7\u00e3o correta ao carregar a p\u00e1gina
            toggleRecebimentoFields();

            // L\u00f3gica para mostrar/esconder campo de Pol\u00edtica Personalizada
            const politicaCancelamentoTipo = document.getElementById('politicaCancelamentoTipo');
            const campoPoliticaPersonalizada = document.getElementById('campoPoliticaPersonalizada');

            function togglePoliticaPersonalizada() {
                if (politicaCancelamentoTipo.value === 'personalizada') {
                    campoPoliticaPersonalizada.style.display = 'block';
                } else {
                    campoPoliticaPersonalizada.style.display = 'none';
                }
            }

            politicaCancelamentoTipo.addEventListener('change', togglePoliticaPersonalizada);
            // Inicializa a exibi\u00e7\u00e3o correta ao carregar a p\u00e1gina
            togglePoliticaPersonalizada();
        });


         // Se voc\u00ea tem login de USU\u00c1RIO e PRESTADOR na mesma p\u00e1gina, voc\u00ea precisa:
         // 1. Garantir que os inputs de email/senha tenham nomes diferentes para cada formul\u00e1rio.
         // 2. Ter dois event listeners separados, um para o bot\u00e3o de login de usu\u00e1rio e outro para o de prestador.
         // 3. Cada listener deve chamar o endpoint backend correto (/login ou /login-prestador)
         // 4. Cada listener deve salvar o token e o objeto retornado (usuario ou prestador)
         //    nas chaves CORRETAS do localStorage ("usuario" ou "prestador").

         // Exemplo de listener para login de USU\u00c1RIO (se voc\u00ea tiver um formul\u00e1rio e bot\u00e3o espec\u00edficos para isso nesta p\u00e1gina)
         /*
         document.getElementById('btnLoginUsuario').addEventListener('click', async (e) => {
              e.preventDefault();
              const email = document.querySelector('input[name="emailUsuario"]').value; // Nome do input de email de usu\u00e1rio
              const senha = document.querySelector('input[name="senhaUsuario"]').value; // Nome do input de senha de usu\u00e1rio

              try {
                  const response = await fetch('https://wyn-backend.onrender.com/login', { // Endpoint de LOGIN DE USU\u00c1RIO // --- URL ATUALIZADA ---
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ email, senha })
                  });

                  const data = await response.json();

                  if (response.ok && data.token && data.usuario) {
                      localStorage.setItem("token", data.token);
                      localStorage.setItem("usuario", JSON.stringify(data.usuario)); // Salva como 'usuario'

                      alert(data.message);
                      window.location.href = "index.html"; // Redireciona para a p\u00e1gina inicial do USU\u00c1RIO
                  } else {
                      alert(data.message || "Credenciais inv\u00e1lidas ou erro ao fazer login.");
                  }
              } catch (error) {
                  console.error(error);
                  alert("Erro ao conectar ao servidor.");
              }
         });
         */

    </script>

</body>
</html>
